CAIXA_SESSAO_MANUT_PA

-------
feature_sis arquivo
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\000\dbupdate 000000032.txt
-------


---------------------------------------
TESTES 
---------------------------------------
---------------------------------------
FIM TESTES
---------------------------------------

-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=CAIXA
DBATUALIZ_OBJETIVO=CRIAR CAIXA_SESSAO_MANUT_PA
DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE CAIXA_SESSAO_MANUT_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=CAIXA_SESSAO_MANUT_PA
/*

C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\PDV
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\PDV\CAIXA_SESSAO_MANUT_PA.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\PDV\CAIXA_SESSAO_MANUT_PA.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\PDV\CAIXA_SESSAO_MANUT_PA.sql";
in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\PDV\CAIXA_SESSAO_MANUT_PA2.sql";

show procedure PERFIL_DE_USO_PA.GARANTIR;

*/
```FIREBIRD
/*
in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\PDV\CAIXA_SESSAO_MANUT_PA.sql";


SELECT * FROM CAIXA_SESSAO_MANUT_PA.CAIXA_SESSAO_OPERACAO_INSERIR_DO(
1 -- LOJA_ID ID_SHORT_DOM NOT NULL
, 1 -- TERMINAL_ID ID_SHORT_DOM NOT NULL
, NULL -- SESS_ID ID_DOM
, NULL --SESS_LOG_ID BIGINT
, NULL -- OPER_ORDEM SMALLINT
, '!' -- OPER_TIPO_ID ID_CHAR_DOM Not Null
, NULL -- OPER_LOG_ID BIGINT
, NULL -- OPER_TIPO_ORDEM SMALLINT
, 2.35 -- VALOR PRECO_DOM Not Null
, 'PRIMEIRA ' -- OBS OBS_DOM
, -2 -- LOG_PESSOA_ID ID_DOM
, 1 -- MACHINE_ID ID_SHORT_DOM
);
COMMIT;


SELECT * FROM CAIXA_SESSAO_MANUT_PA.CAIXA_SESSAO_OPERACAO_INSERIR_DO(
1 -- LOJA_ID ID_SHORT_DOM NOT NULL
, 1 -- TERMINAL_ID ID_SHORT_DOM NOT NULL
, 7 -- SESS_ID ID_DOM
, 10 --SESS_LOG_ID BIGINT
, NULL -- OPER_ORDEM SMALLINT
, '!' -- OPER_TIPO_ID ID_CHAR_DOM Not Null
, NULL -- OPER_LOG_ID BIGINT
, NULL -- OPER_TIPO_ORDEM SMALLINT
, 2.35 -- VALOR PRECO_DOM Not Null
, 'PRIMEIRA ' -- OBS OBS_DOM
, -2 -- LOG_PESSOA_ID ID_DOM
, 1 -- MACHINE_ID ID_SHORT_DOM
);
COMMIT;




ROLLBACK;
*/
SET TERM ^;
CREATE OR ALTER PACKAGE CAIXA_SESSAO_MANUT_PA
AS
BEGIN
  PROCEDURE ABERTO_GET
  RETURNS
  (
    SESS_ID ID_DOM
    , PESSOA_ID ID_DOM
    , APELIDO NOME_REDU_DOM
  );
  
  PROCEDURE CAIXA_SESSAO_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , LOG_PESSOA_ID ID_DOM
    , MACHINE_ID ID_SHORT_DOM
  )  
  RETURNS
  (
    SESS_ID_RET ID_DOM
  );
  
  PROCEDURE OPER_ORDEM_PROXIMO_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , OPER_ORDEM SMALLINT
  )
  RETURNS
  (
    OPER_ORDEM_RET SMALLINT
  );
  
  PROCEDURE OPER_TIPO_ORDEM_PROXIMO_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , OPER_ORDEM SMALLINT
    , OPER_TIPO_ID ID_CHAR_DOM NOT NULL
    , OPER_TIPO_ORDEM SMALLINT
  )
  RETURNS
  (
    OPER_TIPO_ORDEM_RET SMALLINT
  );
  
  -- CAIXA_SESSAO_MANUT_PA.CAIXA_SESSAO_OPERACAO_INSERIR_DO DEF
  PROCEDURE CAIXA_SESSAO_OPERACAO_INSERIR_DO
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , OPER_ORDEM SMALLINT
    , OPER_TIPO_ID ID_CHAR_DOM Not Null
    , OPER_LOG_ID BIGINT
    , OPER_TIPO_ORDEM SMALLINT
    , VALOR PRECO_DOM Not Null
    , OBS OBS_DOM
    , LOG_PESSOA_ID ID_DOM
    , MACHINE_ID ID_SHORT_DOM
  )
  RETURNS
  (
    SESS_ID_RET ID_DOM
    , OPER_ORDEM_RET SMALLINT
    , OPER_LOG_ID_RET BIGINT
    , OPER_TIPO_ORDEM_RET SMALLINT
    , LOG_DESCR VARCHAR(333)
  );
END^

RECREATE PACKAGE BODY CAIXA_SESSAO_MANUT_PA
AS
BEGIN
  PROCEDURE ABERTO_GET
  RETURNS
  (
    SESS_ID ID_DOM
    , PESSOA_ID ID_DOM
    , APELIDO NOME_REDU_DOM
  )
  AS
  BEGIN
    FOR
      SELECT
      SESS.SESS_ID
      , PESS.PESSOA_ID
      , PESS.APELIDO
      
      FROM AMBIENTE_SIS AMBI  

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID = SESS.TERMINAL_ID

      JOIN LOG ON
      SESS.LOJA_ID = LOG.LOJA_ID
      AND SESS.TERMINAL_ID = LOG.TERMINAL_ID 
      AND SESS.SESS_LOG_ID = LOG.LOG_ID 

      JOIN PESSOA PESS ON
      LOG.LOJA_ID = PESS.LOJA_ID
      AND LOG.TERMINAL_ID = PESS.TERMINAL_ID
      AND LOG.PESSOA_ID = PESS.PESSOA_ID
    INTO  
      :SESS_ID
      , :PESSOA_ID
      , :APELIDO
    DO  
      SUSPEND;
  END
  
  PROCEDURE CAIXA_SESSAO_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , LOG_PESSOA_ID ID_DOM
    , MACHINE_ID ID_SHORT_DOM
  )  
  RETURNS
  (
    SESS_ID_RET ID_DOM
  )
  AS
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- MODULO PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    DECLARE SESS_FEATURE_SIS_ID ID_SHORT_DOM = 13; -- FEATURE SESSAO

    DECLARE SESS_LOG_ID BIGINT;
  BEGIN
    :SESS_ID_RET = COALESCE(SESS_ID, 0);
    
    IF (:SESS_ID_RET = 0) THEN
    BEGIN
      :SESS_ID_RET = NEXT VALUE FOR CAIXA_SESSAO_SEQ;
      
      SELECT LOG_ID_RET 
      FROM LOG_PA.LOG_NOVO_GET
      (
        :LOJA_ID,
        :TERMINAL_ID,
        :LOG_PESSOA_ID,
        :MODULO_SIS_ID,
        :ACAO_SIS_ID,
        :SESS_FEATURE_SIS_ID,
        :MACHINE_ID
      ) INTO :SESS_LOG_ID;

      EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
      (
        :LOJA_ID,
        :TERMINAL_ID,
        :SESS_LOG_ID,
        0,
        
        NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
        NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
        :SESS_ID, -- ID_ENVOLVIDO INTEGER,
        0 -- ORDEM_ENVOLVIDO SMALLINT
      );    

      INSERT INTO CAIXA_SESSAO
      (
        LOJA_ID
        , TERMINAL_ID
        , SESS_ID
        , SESS_LOG_ID
      )
      VALUES
      (
        :LOJA_ID
        , :TERMINAL_ID
        , :SESS_ID_RET
        , :SESS_LOG_ID
      );
    END
    SUSPEND;
  END
  
  PROCEDURE OPER_ORDEM_PROXIMO_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , OPER_ORDEM SMALLINT
  )
  RETURNS
  (
    OPER_ORDEM_RET SMALLINT
  )
  AS
  BEGIN
    :OPER_ORDEM_RET = COALESCE(:OPER_ORDEM, 0);
    IF (:OPER_ORDEM_RET = 0) THEN
    BEGIN
      SELECT COALESCE(MAX(OPER_ORDEM), -1) + 1 
      FROM CAIXA_SESSAO_OPERACAO
      WHERE SESS_ID = :SESS_ID
      INTO :OPER_ORDEM_RET;    
    END
    SUSPEND;
  END
  
  
  PROCEDURE OPER_TIPO_ORDEM_PROXIMO_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , OPER_ORDEM SMALLINT
    , OPER_TIPO_ID ID_CHAR_DOM NOT NULL
    , OPER_TIPO_ORDEM SMALLINT
  )
  RETURNS
  (
    OPER_TIPO_ORDEM_RET SMALLINT
  )
  AS
  BEGIN
    :OPER_TIPO_ORDEM_RET = COALESCE(:OPER_TIPO_ORDEM, 0);
    IF (:OPER_TIPO_ORDEM_RET = 0) THEN
    BEGIN
      SELECT COALESCE(MAX(OPER_TIPO_ORDEM), -1) + 1 
      FROM CAIXA_SESSAO_OPERACAO
      WHERE SESS_ID = :SESS_ID
      AND OPER_TIPO_ID = :OPER_TIPO_ID
      INTO :OPER_TIPO_ORDEM_RET;
    END
    SUSPEND;
  END
  
  -- CAIXA_SESSAO_MANUT_PA.CAIXA_SESSAO_OPERACAO_INSERIR_DO IMP
  PROCEDURE CAIXA_SESSAO_OPERACAO_INSERIR_DO
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM
    , OPER_ORDEM SMALLINT
    , OPER_TIPO_ID ID_CHAR_DOM Not Null
    , OPER_LOG_ID BIGINT
    , OPER_TIPO_ORDEM SMALLINT
    , VALOR PRECO_DOM Not Null
    , OBS OBS_DOM
    , LOG_PESSOA_ID ID_DOM
    , MACHINE_ID ID_SHORT_DOM
  )
  RETURNS
  (
    SESS_ID_RET ID_DOM
    , OPER_ORDEM_RET SMALLINT
    , OPER_LOG_ID_RET BIGINT
    , OPER_TIPO_ORDEM_RET SMALLINT
    , LOG_DESCR VARCHAR(333)
  )
  AS
    -- LOJA INICIAL GAR LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE OPER_FEATURE_SIS_ID ID_SHORT_DOM = 14; -- FEATURE OPERACAO
    
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- MODULO PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    
  BEGIN
    -- CAIXA_SESSAO_MANUT_PA.CAIXA_SESSAO_OPERACAO_INSERIR_DO COD

    -- SESSAO SESS_ID -> SESS_ID_RET
    SELECT SESS_ID_RET
    FROM CAIXA_SESSAO_INS(:LOJA_ID, :TERMINAL_ID, :SESS_ID, :LOG_PESSOA_ID,
      :MACHINE_ID)
    INTO :SESS_ID_RET;
    
    :LOG_DESCR = 'SESS_ID_RET='||CAST(:SESS_ID_RET AS VARCHAR(1024));
    
    -- OPER ORDEM
    SELECT OPER_ORDEM_RET
    FROM OPER_ORDEM_PROXIMO_GET
    (:LOJA_ID, :TERMINAL_ID, :SESS_ID, :OPER_ORDEM)
    INTO :OPER_ORDEM_RET;
    :LOG_DESCR = :LOG_DESCR || ' / OPER_ORDEM_RET='||CAST(:OPER_ORDEM_RET AS VARCHAR(1024));

    -- OPER_TIPO ORDEM
    SELECT OPER_TIPO_ORDEM_RET
    FROM OPER_TIPO_ORDEM_PROXIMO_GET
    (:LOJA_ID, :TERMINAL_ID, :SESS_ID, :OPER_ORDEM, :OPER_TIPO_ID,
    :OPER_TIPO_ORDEM)
    INTO :OPER_TIPO_ORDEM_RET;
    :LOG_DESCR = :LOG_DESCR || ' / OPER_TIPO_ORDEM_RET='||CAST(:OPER_TIPO_ORDEM_RET AS VARCHAR(1024));
    
    SELECT LOG_ID_RET
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :OPER_FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :OPER_LOG_ID_RET;
    
    :LOG_DESCR = :LOG_DESCR || ' / OPER_LOG_ID_RET='||CAST(:OPER_LOG_ID_RET AS VARCHAR(1024));

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :OPER_LOG_ID_RET,
      0,
      
      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :SESS_ID, -- ID_ENVOLVIDO INTEGER,
      :OPER_ORDEM_RET -- ORDEM_ENVOLVIDO SMALLINT
    );    
    
    INSERT INTO CAIXA_SESSAO_OPERACAO
    (
      LOJA_ID
      , TERMINAL_ID
      , SESS_ID
      , OPER_ORDEM
      , OPER_LOG_ID
      , OPER_TIPO_ID
      , OPER_TIPO_ORDEM
      , VALOR
      , OBS
    )
    VALUES
    (
      :LOJA_ID
      , :TERMINAL_ID
      , :SESS_ID_RET
      , :OPER_ORDEM_RET
      , :OPER_LOG_ID_RET
      , :OPER_TIPO_ID
      , :OPER_TIPO_ORDEM_RET
      , :VALOR
      , :OBS
    );
    
    ---
--    INSERT INTO LOG_DESCR(LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM, DESCR)
--    VALUES(:LOJA_ID, :TERMINAL_ID, :OPER_LOG_ID_RET, 0/*:OPER_ORDEM_RET*/,
--    :S);    
    
    
    SUSPEND;    
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
