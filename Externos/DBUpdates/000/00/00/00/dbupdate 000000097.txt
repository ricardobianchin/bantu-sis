EST_MOV_MANUT_PA




DROP PACKAGE VENDA_MANUT_PA;
DROP PACKAGE VENDA_INICIAL_PA;
DROP PACKAGE EST_MOV_MANUT_PA;

--DROP TABLE V ENDA _I TEM;
--DROP TABLE V ENDA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=95;
COMMIT;

-- ROLLBACK;




-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=ESTOQUE
DBATUALIZ_OBJETIVO=CRIAR EST_MOV_MANUT_PA
//DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE EST_MOV_MANUT_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=EST_MOV_MANUT_PA
/*

C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\EST_MOV_MANUT_PA.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\EST_MOV_MANUT_PA.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\EST_MOV_MANUT_PA.sql";


*/
```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE EST_MOV_MANUT_PA
AS
BEGIN
  PROCEDURE EST_MOV_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL 
    , EST_MOV_TIPO_ID ID_CHAR_DOM NOT NULL
    , DTH_DOC TIMESTAMP NOT NULL
    , EST_MOV_CRIADO_EM TIMESTAMP NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    EST_MOV_ID_RET BIGINT
    , DTH_DOC_RET TIMESTAMP
    , EST_MOV_CRIADO_EM_RET TIMESTAMP
  );
  
  PROCEDURE ORDEM_PROXIMO_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
  )
  RETURNS
  (
    ORDEM_RET SMALLINT
  );  
  
  PROCEDURE EST_MOV_ITEM_INS
  (
    LOJA_ID ID_SHORT_DOM Not Null
    , TERMINAL_ID ID_SHORT_DOM Not Null
    , EST_MOV_ID BIGINT NOT NULL
    , EST_MOV_TIPO_ID ID_CHAR_DOM Not Null
    , DTH_DOC TIMESTAMP NOT NULL
    , EST_MOV_CRIADO_EM TIMESTAMP NOT NULL
    , PROD_ID ID_DOM Not Null
    , QTD QTD_DOM Not Null

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    EST_MOV_ID_RET BIGINT
    , DTH_DOC_RET TIMESTAMP
    , EST_MOV_CRIADO_EM_RET TIMESTAMP
    , EST_MOV_ITEM_CRIADO_EM_RET TIMESTAMP
    , ORDEM_RET SMALLINT
  );  

  -- EST_MOV_MANUT_PA.EST_MOV_FINALIZE DEF
  PROCEDURE EST_MOV_FINALIZE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    FINALIZADO_EM_RET TIMESTAMP
  );

  PROCEDURE EST_MOV_CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    CANCELADO_EM_RET TIMESTAMP
  );
  
  -- EST_MOV_MANUT_PA.EST_MOV_ITEM_CANCELE DEF
  PROCEDURE EST_MOV_ITEM_CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , ORDEM SMALLINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )  
  RETURNS
  (
    CANCELADO_EM_RET TIMESTAMP
  );
END^

RECREATE PACKAGE BODY EST_MOV_MANUT_PA
AS
BEGIN
  PROCEDURE EST_MOV_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL 
    , EST_MOV_TIPO_ID ID_CHAR_DOM NOT NULL
    , DTH_DOC TIMESTAMP NOT NULL
    , EST_MOV_CRIADO_EM TIMESTAMP NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    EST_MOV_ID_RET BIGINT
    , DTH_DOC_RET TIMESTAMP
    , EST_MOV_CRIADO_EM_RET TIMESTAMP
  )
  AS
    -- EST_MOV_MANUT_PA EST_MOV_INS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 17; -- EST_MOV
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    :EST_MOV_ID_RET = COALESCE(EST_MOV_ID, 0);
    :EST_MOV_CRIADO_EM_RET = :EST_MOV_CRIADO_EM;
    :DTH_DOC_RET = :DTH_DOC;

    IF (:EST_MOV_ID_RET = 0) THEN
    BEGIN
      :EST_MOV_ID_RET = NEXT VALUE FOR EST_MOV_SEQ;
      :EST_MOV_CRIADO_EM_RET = CURRENT_TIMESTAMP;
      :DTH_DOC_RET = :EST_MOV_CRIADO_EM_RET;

      INSERT INTO EST_MOV (
        LOJA_ID
        , TERMINAL_ID
        , EST_MOV_ID
        , EST_MOV_TIPO_ID
        , DTH_DOC
        , CRIADO_EM
      ) VALUES (
        :LOJA_ID
        , :TERMINAL_ID
        , :EST_MOV_ID_RET
        , :EST_MOV_TIPO_ID
        , :DTH_DOC_RET
        , :EST_MOV_CRIADO_EM_RET
      );
    END

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID_RET, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );

    SUSPEND;
  END
  
  PROCEDURE ORDEM_PROXIMO_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
  )
  RETURNS
  (
    ORDEM_RET SMALLINT
  )
  AS
  BEGIN
    --:ORDEM_RET = COALESCE(:ORDEM, 0);
    --IF (:ORDEM_RET = 0) THEN
    --BEGIN
    --END

    SELECT COALESCE(MAX(ORDEM), -1) + 1 
    FROM EST_MOV_ITEM
    WHERE LOJA_ID = :LOJA_ID
    AND TERMINAL_ID = :TERMINAL_ID
    AND EST_MOV_ID = :EST_MOV_ID
    INTO :ORDEM_RET;

    SUSPEND;
  END  
  
  PROCEDURE EST_MOV_ITEM_INS
  (
    LOJA_ID ID_SHORT_DOM Not Null
    , TERMINAL_ID ID_SHORT_DOM Not Null
    , EST_MOV_ID BIGINT NOT NULL
    , EST_MOV_TIPO_ID ID_CHAR_DOM Not Null
    , DTH_DOC TIMESTAMP NOT NULL
    , EST_MOV_CRIADO_EM TIMESTAMP NOT NULL
    , PROD_ID ID_DOM Not Null
    , QTD QTD_DOM Not Null

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    EST_MOV_ID_RET BIGINT
    , DTH_DOC_RET TIMESTAMP
    , EST_MOV_CRIADO_EM_RET TIMESTAMP
    , EST_MOV_ITEM_CRIADO_EM_RET TIMESTAMP
    , ORDEM_RET SMALLINT
  )
  AS
    -- EST_MOV_MANUT_PA EST_MOV_INS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 18; -- EST_MOV
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    :EST_MOV_ID_RET = COALESCE(EST_MOV_ID, 0);
    IF (:EST_MOV_ID_RET = 0) THEN
    BEGIN
      SELECT EST_MOV_ID_RET, DTH_DOC_RET, EST_MOV_CRIADO_EM_RET
      FROM EST_MOV_INS
      (
        :LOJA_ID
        , :TERMINAL_ID
        , :EST_MOV_ID_RET
        , :EST_MOV_TIPO_ID
        , :DTH_DOC
        , :EST_MOV_CRIADO_EM
        
        , :LOG_PESSOA_ID
        , :MACHINE_ID
        , :MODULO_SIS_ID        
      )
      INTO :EST_MOV_ID_RET, :DTH_DOC_RET, :EST_MOV_CRIADO_EM_RET;
    END  
  
--    :ORDEM_RET = COALESCE(:ORDEM, 0);
    --IF (:ORDEM_RET = 0) THEN
    --BEGIN
    --END

    SELECT ORDEM_RET
    FROM ORDEM_PROXIMO_GET
    (:LOJA_ID, :TERMINAL_ID, :EST_MOV_ID_RET)
    INTO :ORDEM_RET;
    
    :EST_MOV_ITEM_CRIADO_EM_RET = CURRENT_TIMESTAMP;

    INSERT INTO EST_MOV_ITEM
    (
      LOJA_ID 
      , TERMINAL_ID 
      , EST_MOV_ID 
      , ORDEM 
      , PROD_ID 
      , QTD 
      , CRIADO_EM 
    )
    VALUES
    (
      :LOJA_ID 
      , :TERMINAL_ID 
      , :EST_MOV_ID_RET
      , :ORDEM_RET
      , :PROD_ID 
      , :QTD 
      , :EST_MOV_ITEM_CRIADO_EM_RET
    );
    
    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT
      :EST_MOV_ID_RET, -- ID_ENVOLVIDO INTEGER
      :ORDEM_RET -- ORDEM_ENVOLVIDO SMALLINT
    );
    
    SUSPEND;    
  END

  PROCEDURE EST_MOV_FINALIZE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
  
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
)
  RETURNS
  (
    FINALIZADO_EM_RET TIMESTAMP
  )
  AS
    -- EST_MOV_MANUT_PA EST_MOV_INS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 17; -- EST_MOV
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ','; -- FINALIZE
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    SELECT LOG_ID_RET, DTH
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET, FINALIZADO_EM_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );

    UPDATE EST_MOV SET
      FINALIZADO = TRUE
      , ALTERADO_EM = :FINALIZADO_EM_RET
      , FINALIZADO_EM = :FINALIZADO_EM_RET
    WHERE LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID;

    SUSPEND;
  END
  
  PROCEDURE EST_MOV_CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    CANCELADO_EM_RET TIMESTAMP
  )
  AS
    -- EST_MOV_MANUT_PA EST_MOV_CANCELE LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 17; -- EST_MOV
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA 
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ')'; -- CANCELAR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    SELECT LOG_ID_RET, DTH
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET, CANCELADO_EM_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );

    UPDATE EST_MOV SET
      CANCELADO = TRUE,
      ALTERADO_EM = :CANCELADO_EM_RET,--MESMA VARIAVEL EM AMBOS
      CANCELADO_EM = :CANCELADO_EM_RET
    WHERE LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID;

    SUSPEND;
  END
  
  -- EST_MOV_MANUT_PA.EST_MOV_ITEM_CANCELE IMP
  PROCEDURE EST_MOV_ITEM_CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , ORDEM SMALLINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )  
  RETURNS
  (
    CANCELADO_EM_RET TIMESTAMP
  )
  AS
    -- EST_MOV_MANUT_PA EST_MOV_CANCELE LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 18; -- EST_MOV_ITEM
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA 
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ')'; -- CANCELAR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    -- EST_MOV_MANUT_PA.EST_MOV_ITEM_CANCELE COD
    SELECT LOG_ID_RET, DTH
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET, CANCELADO_EM_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID, -- ID_ENVOLVIDO INTEGER,
      :ORDEM -- ORDEM_ENVOLVIDO SMALLINT
    );
    
    UPDATE EST_MOV_ITEM
    SET CANCELADO = TRUE,
        CANCELADO_EM = :CANCELADO_EM_RET
        , ALTERADO_EM = :CANCELADO_EM_RET
    WHERE LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID
      AND ORDEM = :ORDEM;

    UPDATE EST_MOV
    SET ALTERADO_EM = :CANCELADO_EM_RET
    WHERE LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID;

    SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
