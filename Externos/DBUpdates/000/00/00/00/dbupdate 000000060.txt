PAGAMENTOS, FORMAS DE PAGAMENTO, RETAGUARDA

--------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=PAGAMENTOS, FORMAS DE PAGAMENTO
DBATUALIZ_OBJETIVO=CRIAR TABELA PAGAMENTO_FORMA
DBATUALIZ_OBS=



///////////////////////////
//PACKAGE PAGAMENTO_FORMA_RETAG_PA
///////////////////////////
COMANDO INI
COMANDO_PONTO_ALVO=SERVIDOR
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=PAGAMENTO_FORMA_RETAG_PA
```FIREBIRD
/*---------
NAO ALTERAR AQUI, MAS, NO ARQLUIVO:
Complementos\PAGAMENTO\pagamento_forma_pa.sql
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\000\Complementos\Fin\pagamento_forma_pa.sql
IN C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\000\Complementos\Fin\pagamento_forma_pa.sql;
*/---------

SET TERM ^;
CREATE OR ALTER PACKAGE PAGAMENTO_FORMA_RETAG_PA
AS
BEGIN
  PROCEDURE BYID_GET
  (
    FORMA_ID ID_SHORT_DOM
  )
  RETURNS
  (
    TIPO_ID          ID_CHAR_DOM
    , TIPO_DESCR     NOME_INTERM_DOM
    , TIPO_DESCR_RED CHAR(6)
    , TIPO_ATIVO     BOOLEAN

    , DESCR                  NOME_INTERM_DOM
    , DESCR_RED              CHAR(8)
    , ATIVO                  BOOLEAN
    , PARA_VENDA             BOOLEAN
    , DE_SISTEMA             BOOLEAN
    , PROMOCAO_PERMITE       BOOLEAN
    , COMISSAO_PERMITE       BOOLEAN
    , TAXA_ADM_PERC          PERC_DOM
    , VALOR_MINIMO           DINH_DOM
    , COMISSAO_ABATER_PERC   PERC_DOM
    , REEMBOLSO_DIAS         SMALLINT
    , TEF_USA                BOOLEAN
    , AUTORIZACAO_EXIGE      BOOLEAN
    , PESSOA_EXIGE           BOOLEAN
    , A_VISTA                BOOLEAN
  );

  -- PAGAMENTO_FORMA_PA.INSERIR_DO DEF
  PROCEDURE INSERIR_DO
  (
    PAGAMENTO_FORMA_TIPO_ID  ID_CHAR_DOM Not Null
    , DESCR                  NOME_INTERM_DOM Not Null
    , DESCR_RED              CHAR(8) Not Null
    , ATIVO                  BOOLEAN Not Null
    , PARA_VENDA             BOOLEAN Not Null
    , DE_SISTEMA             BOOLEAN Not Null
    , PROMOCAO_PERMITE       BOOLEAN Not Null
    , COMISSAO_PERMITE       BOOLEAN Not Null
    , TAXA_ADM_PERC          PERC_DOM  Not Null
    , VALOR_MINIMO           DINH_DOM Not Null
    , COMISSAO_ABATER_PERC   PERC_DOM  Not Null
    , REEMBOLSO_DIAS         SMALLINT Not Null
    , TEF_USA                BOOLEAN Not Null
    , AUTORIZACAO_EXIGE      BOOLEAN Not Null
    , PESSOA_EXIGE           BOOLEAN Not Null
    , A_VISTA                BOOLEAN Not Null  
    , LOJA_ID                ID_DOM NOT NULL
    , PESSOA_ID              ID_DOM NOT NULL
    , MACHINE_ID             ID_SHORT_DOM
  )
  RETURNS
  (
    PAGAMENTO_FORMA_ID ID_DOM
  );

  -- PAGAMENTO_FORMA_PA.ALTERAR_DO DEF
  PROCEDURE ALTERAR_DO
  (
    PAGAMENTO_FORMA_ID       ID_DOM Not Null
    , PAGAMENTO_FORMA_TIPO_ID  ID_CHAR_DOM Not Null
    , DESCR                  NOME_INTERM_DOM Not Null
    , DESCR_RED              CHAR(8) Not Null
    , ATIVO                  BOOLEAN Not Null
    , PARA_VENDA             BOOLEAN Not Null
    , DE_SISTEMA             BOOLEAN Not Null
    , PROMOCAO_PERMITE       BOOLEAN Not Null
    , COMISSAO_PERMITE       BOOLEAN Not Null
    , TAXA_ADM_PERC          PERC_DOM  Not Null
    , VALOR_MINIMO           DINH_DOM Not Null
    , COMISSAO_ABATER_PERC   PERC_DOM  Not Null
    , REEMBOLSO_DIAS         SMALLINT Not Null
    , TEF_USA                BOOLEAN Not Null
    , AUTORIZACAO_EXIGE      BOOLEAN Not Null
    , PESSOA_EXIGE           BOOLEAN Not Null
    , A_VISTA                BOOLEAN Not Null  
    , LOJA_ID                ID_DOM NOT NULL
    , PESSOA_ID              ID_DOM NOT NULL
    , MACHINE_ID             ID_SHORT_DOM
  );
END^

------ BODY ------

RECREATE PACKAGE BODY PAGAMENTO_FORMA_RETAG_PA
AS
BEGIN
  PROCEDURE BYID_GET
  (
    FORMA_ID ID_SHORT_DOM
  )
  RETURNS
  (
    TIPO_ID          ID_CHAR_DOM
    , TIPO_DESCR     NOME_INTERM_DOM
    , TIPO_DESCR_RED CHAR(6)
    , TIPO_ATIVO     BOOLEAN

    , DESCR                  NOME_INTERM_DOM
    , DESCR_RED              CHAR(8)
    , ATIVO                  BOOLEAN
    , PARA_VENDA             BOOLEAN
    , DE_SISTEMA             BOOLEAN
    , PROMOCAO_PERMITE       BOOLEAN
    , COMISSAO_PERMITE       BOOLEAN
    , TAXA_ADM_PERC          PERC_DOM
    , VALOR_MINIMO           DINH_DOM
    , COMISSAO_ABATER_PERC   PERC_DOM
    , REEMBOLSO_DIAS         SMALLINT
    , TEF_USA                BOOLEAN
    , AUTORIZACAO_EXIGE      BOOLEAN
    , PESSOA_EXIGE           BOOLEAN
    , A_VISTA                BOOLEAN
  )
  AS
  BEGIN
    FOR
    WITH F AS (
      SELECT PAGAMENTO_FORMA_ID ID, PAGAMENTO_FORMA_TIPO_ID TIPO_ID, DESCR,
      DESCR_RED, ATIVO, PARA_VENDA, DE_SISTEMA, PROMOCAO_PERMITE, COMISSAO_PERMITE,
      TAXA_ADM_PERC, VALOR_MINIMO, COMISSAO_ABATER_PERC, REEMBOLSO_DIAS,
      TEF_USA, AUTORIZACAO_EXIGE, PESSOA_EXIGE, A_VISTA

      FROM PAGAMENTO_FORMA  
      WHERE PAGAMENTO_FORMA_ID = :FORMA_ID
    ),
    FT AS (
      SELECT PAGAMENTO_FORMA_TIPO_ID TIPO_ID, DESCR TIPO_DESCR, DESCR_RED TIPO_DESCR_RED, ATIVO TIPO_ATIVO
      FROM PAGAMENTO_FORMA_TIPO
    )
    SELECT FIRST(1)
      FT.TIPO_ID, FT.TIPO_DESCR, FT.TIPO_DESCR_RED, FT.TIPO_ATIVO,
      F.DESCR, F.DESCR_RED, F.ATIVO, F.PARA_VENDA, F.DE_SISTEMA, F.PROMOCAO_PERMITE,
      F.COMISSAO_PERMITE, F.TAXA_ADM_PERC, F.VALOR_MINIMO, F.COMISSAO_ABATER_PERC,
      F.REEMBOLSO_DIAS, F.TEF_USA, F.AUTORIZACAO_EXIGE, F.PESSOA_EXIGE, F.A_VISTA    
    
    FROM F
    JOIN FT ON F.TIPO_ID = FT.TIPO_ID
    INTO 
      :TIPO_ID
      , :TIPO_DESCR
      , :TIPO_DESCR_RED
      , :TIPO_ATIVO

      , :DESCR
      , :DESCR_RED
      , :ATIVO
      , :PARA_VENDA
      , :DE_SISTEMA
      , :PROMOCAO_PERMITE
      , :COMISSAO_PERMITE
      , :TAXA_ADM_PERC
      , :VALOR_MINIMO
      , :COMISSAO_ABATER_PERC
      , :REEMBOLSO_DIAS
      , :TEF_USA
      , :AUTORIZACAO_EXIGE
      , :PESSOA_EXIGE
      , :A_VISTA

    DO SUSPEND; 
  END

  -- PAGAMENTO_FORMA_PA.INSERIR_DO IMP
  PROCEDURE INSERIR_DO
  (
    PAGAMENTO_FORMA_TIPO_ID  ID_CHAR_DOM Not Null
    , DESCR                  NOME_INTERM_DOM Not Null
    , DESCR_RED              CHAR(8) Not Null
    , ATIVO                  BOOLEAN Not Null
    , PARA_VENDA             BOOLEAN Not Null
    , DE_SISTEMA             BOOLEAN Not Null
    , PROMOCAO_PERMITE       BOOLEAN Not Null
    , COMISSAO_PERMITE       BOOLEAN Not Null
    , TAXA_ADM_PERC          PERC_DOM  Not Null
    , VALOR_MINIMO           DINH_DOM Not Null
    , COMISSAO_ABATER_PERC   PERC_DOM  Not Null
    , REEMBOLSO_DIAS         SMALLINT Not Null
    , TEF_USA                BOOLEAN Not Null
    , AUTORIZACAO_EXIGE      BOOLEAN Not Null
    , PESSOA_EXIGE           BOOLEAN Not Null
    , A_VISTA                BOOLEAN Not Null  
    , LOJA_ID              ID_DOM NOT NULL
    , PESSOA_ID              ID_DOM NOT NULL
    , MACHINE_ID             ID_SHORT_DOM
)
  RETURNS
  (
    PAGAMENTO_FORMA_ID ID_DOM
  )
  AS
    // PAGAMENTO_FORMA LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG 
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 11;//PAGAMENTO_FORMA
    DECLARE RETAGUARDA_TERMINAL_ID ID_SHORT_DOM = 0;
    DECLARE RETAGUARDA_MODULO_SIS_ID ID_CHAR_DOM = '"';
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%';//INSERIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    -- PAGAMENTO_FORMA_PA.INSERIR_DO COD
    PAGAMENTO_FORMA_ID = NEXT VALUE FOR PAGAMENTO_FORMA_SEQ;

    INSERT INTO PAGAMENTO_FORMA (PAGAMENTO_FORMA_ID, PAGAMENTO_FORMA_TIPO_ID, 
      DESCR, DESCR_RED, ATIVO, PARA_VENDA, DE_SISTEMA, PROMOCAO_PERMITE,
      COMISSAO_PERMITE, TAXA_ADM_PERC, VALOR_MINIMO, COMISSAO_ABATER_PERC,
      REEMBOLSO_DIAS, TEF_USA, AUTORIZACAO_EXIGE, PESSOA_EXIGE, A_VISTA
    )VALUES(
      :PAGAMENTO_FORMA_ID, :PAGAMENTO_FORMA_TIPO_ID, :DESCR, :DESCR_RED,
      :ATIVO, :PARA_VENDA, :DE_SISTEMA, :PROMOCAO_PERMITE, :COMISSAO_PERMITE,
      :TAXA_ADM_PERC, :VALOR_MINIMO, :COMISSAO_ABATER_PERC, :REEMBOLSO_DIAS,
      :TEF_USA, :AUTORIZACAO_EXIGE, :PESSOA_EXIGE, :A_VISTA);    

    SELECT LOG_ID_RET
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :PESSOA_ID,
      :RETAGUARDA_MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :LOG_ID_RET,
      0,

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PAGAMENTO_FORMA_ID, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );

    SUSPEND;
  END

  -- PAGAMENTO_FORMA_PA.ALTERAR_DO IMP
  PROCEDURE ALTERAR_DO
  (
    PAGAMENTO_FORMA_ID       ID_DOM Not Null
    , PAGAMENTO_FORMA_TIPO_ID  ID_CHAR_DOM Not Null
    , DESCR                  NOME_INTERM_DOM Not Null
    , DESCR_RED              CHAR(8) Not Null
    , ATIVO                  BOOLEAN Not Null
    , PARA_VENDA             BOOLEAN Not Null
    , DE_SISTEMA             BOOLEAN Not Null
    , PROMOCAO_PERMITE       BOOLEAN Not Null
    , COMISSAO_PERMITE       BOOLEAN Not Null
    , TAXA_ADM_PERC          PERC_DOM  Not Null
    , VALOR_MINIMO           DINH_DOM Not Null
    , COMISSAO_ABATER_PERC   PERC_DOM  Not Null
    , REEMBOLSO_DIAS         SMALLINT Not Null
    , TEF_USA                BOOLEAN Not Null
    , AUTORIZACAO_EXIGE      BOOLEAN Not Null
    , PESSOA_EXIGE           BOOLEAN Not Null
    , A_VISTA                BOOLEAN Not Null  
    , LOJA_ID                ID_DOM NOT NULL
    , PESSOA_ID              ID_DOM NOT NULL
    , MACHINE_ID             ID_SHORT_DOM
)
  AS
    // PAGAMENTO_FORMA LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG 
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 11;//PAGAMENTO_FORMA
    DECLARE RETAGUARDA_TERMINAL_ID ID_SHORT_DOM = 0;
    DECLARE RETAGUARDA_MODULO_SIS_ID ID_CHAR_DOM = '"';
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '&';//ALTERAR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    -- PAGAMENTO_FORMA_PA.ALTERAR_DO COD
    UPDATE PAGAMENTO_FORMA SET 
      PAGAMENTO_FORMA_TIPO_ID = :PAGAMENTO_FORMA_TIPO_ID,
      DESCR = :DESCR,
      DESCR_RED = :DESCR_RED,
      ATIVO = :ATIVO,
      PARA_VENDA = :PARA_VENDA,
      DE_SISTEMA = :DE_SISTEMA,
      PROMOCAO_PERMITE = :PROMOCAO_PERMITE,
      COMISSAO_PERMITE = :COMISSAO_PERMITE,
      TAXA_ADM_PERC = :TAXA_ADM_PERC,
      VALOR_MINIMO = :VALOR_MINIMO,
      COMISSAO_ABATER_PERC = :COMISSAO_ABATER_PERC,
      REEMBOLSO_DIAS = :REEMBOLSO_DIAS,
      TEF_USA = :TEF_USA,
      AUTORIZACAO_EXIGE = :AUTORIZACAO_EXIGE,
      PESSOA_EXIGE = :PESSOA_EXIGE,
      A_VISTA = :A_VISTA
    WHERE PAGAMENTO_FORMA_ID = :PAGAMENTO_FORMA_ID;

    SELECT LOG_ID_RET 
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :PESSOA_ID,
      :RETAGUARDA_MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :LOG_ID_RET,
      0,

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PAGAMENTO_FORMA_ID, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );
  END
END^
SET TERM ;^

```
COMANDO FIM
//PACKAGE PAGAMENTO_FORMA_PA FIM

DBATUALIZ FIM
