CRIA
LOJA_INICIAL_PA

OBS
LOJA TEM DUAS PACKAGES ESTA, LOJA_INICIAL_PA E A LOJA_MANUT_PA


-----------------------------
TESTES INICIO
-----------------------------




-----------------------------
TESTES FIM 
-----------------------------

-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=AMBIENTE, LOJA
DBATUALIZ_OBJETIVO=CRIAR PACKAGE LOJA_INICIAL_PA
DBATUALIZ_OBS=



// PACKAGE LOJA_INICIAL_PA
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=LOJA_INICIAL_PA


/*
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\loja_inicial_pa.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\loja_inicial_pa.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\loja_inicial_pa.sql";
*/


```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE LOJA_INICIAL_PA
AS
BEGIN
  {SE PONTO_ALVO=SERVIDOR}//DEF INI SERV
  PROCEDURE SELECIONADO_GET
  RETURNS
  (
    LOJA_ID SMALLINT
    , APELIDO NOME_REDU_DOM
  );

  PROCEDURE LISTA_GET
  (
    APELIDO_BUSCA NOME_REDU_DOM
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , APELIDO NOME_REDU_DOM
    , SELECIONADO BOOLEAN
  );

  PROCEDURE BYID_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
  )
  RETURNS
  (
    APELIDO NOME_REDU_DOM
    , SELECIONADO BOOLEAN
  );

  -- LOJA_INICIAL_PA.GARANTIR DEF
  PROCEDURE GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , APELIDO NOME_REDU_DOM NOT NULL
    , SELECIONADO SELECIONADO_DOM NOT NULL
    , LOG_LOJA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM
  );
  {FIMSE} // DEF FIM SERV
END^

------- BODY

RECREATE PACKAGE BODY LOJA_INICIAL_PA
AS
BEGIN
{SE PONTO_ALVO=SERVIDOR}//IMP INI SERV

  PROCEDURE SELECIONADO_GET
  RETURNS
  (
    LOJA_ID SMALLINT
    , APELIDO NOME_REDU_DOM
  )
  AS
  BEGIN
    FOR 
      SELECT L.LOJA_ID, L.APELIDO 
      FROM LOJA L 
      WHERE L.SELECIONADO = TRUE 
    INTO 
      :LOJA_ID, 
      :APELIDO 
    DO 
      SUSPEND;
  END
  
  PROCEDURE LISTA_GET
  (
    APELIDO_BUSCA NOME_REDU_DOM
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , APELIDO NOME_REDU_DOM
    , SELECIONADO BOOLEAN
  )
  AS 
  BEGIN 
    IF (TRIM(APELIDO_BUSCA) = '') THEN 
      FOR SELECT L.LOJA_ID, L.APELIDO, L.SELECIONADO FROM LOJA L INTO :LOJA_ID, :APELIDO, :SELECIONADO DO SUSPEND; 
    ELSE 
      FOR SELECT L.LOJA_ID, L.APELIDO, L.SELECIONADO FROM LOJA L WHERE L.APELIDO LIKE '%'||:APELIDO_BUSCA||'%' INTO :LOJA_ID, :APELIDO, :SELECIONADO DO SUSPEND; 
  END
  
   PROCEDURE BYID_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
  )
  RETURNS
  (
    APELIDO NOME_REDU_DOM
    , SELECIONADO BOOLEAN
  )
  AS  
  BEGIN  
    SELECT FIRST(1) L.APELIDO, L.SELECIONADO FROM LOJA L WHERE L.LOJA_ID = :LOJA_ID INTO :APELIDO, :SELECIONADO;  
    SUSPEND;
  END
  
  -- LOJA_INICIAL_PA.GARANTIR IMP
  PROCEDURE GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , APELIDO NOME_REDU_DOM NOT NULL
    , SELECIONADO SELECIONADO_DOM NOT NULL

    , LOG_LOJA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM
  )
  AS
    -- LOJA INICIAL GAR LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 1; -- LOJAS
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
BEGIN
    -- LOJA_INICIAL_PA.GARANTIR COD

    IF (:SELECIONADO IS NULL) THEN
      :SELECIONADO = FALSE;
    ELSE IF (:SELECIONADO = TRUE) THEN
      UPDATE LOJA SET SELECIONADO = FALSE;

    UPDATE OR INSERT INTO LOJA
    (APELIDO, SELECIONADO, LOJA_ID)
    VALUES
    (:APELIDO, :SELECIONADO, :LOJA_ID)
    MATCHING (LOJA_ID);

    IF (:SELECIONADO) THEN
      EXECUTE PROCEDURE AMBIENTE_SIS_PA.LOJA_ID_SET(:LOJA_ID);

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOG_LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOG_LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      NULL, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );
  END
{FIMSE}//IMP FIM SERV
END^
SET TERM ;^

```
COMANDO FIM

DBATUALIZ FIM
