INVENTARIO_PA


"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\00\00\00\dbupdate 000000109.txt"

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;

show package INVENTARIO_PA;

DROP PACKAGE INVENTARIO_PA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=113;
COMMIT;



/*

C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\INVENTARIO_PA.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\INVENTARIO_PA.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\INVENTARIO_PA.sql";


*/





-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=ESTOQUE
DBATUALIZ_OBJETIVO=CRIAR INVENTARIO_PA
DBATUALIZ_PONTO_ALVO=SERVIDOR
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE INVENTARIO_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=INVENTARIO_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE INVENTARIO_PA
AS
BEGIN
  PROCEDURE LISTA_GET
  (
    CRIADO_EM_INICIAL TIMESTAMP NOT NULL,
    CRIADO_EM_FINAL TIMESTAMP NOT NULL
  )
  RETURNS
  (
    LOJA_ID                         ID_SHORT_DOM,
    TERMINAL_ID                     ID_SHORT_DOM,
    EST_MOV_ID                      BIGINT,
    INVENTARIO_ID                    ID_DOM,
    COD                             VARCHAR(20),
    --DTH_DOC                         TIMESTAMP,
    CRIADO_EM                       TIMESTAMP,
    FINALIZADO                      BOOLEAN,
    FINALIZADO_EM                   TIMESTAMP,
    CANCELADO                       BOOLEAN,
    --ALTERADO_EM                     TIMESTAMP,
    CANCELADO_EM                    TIMESTAMP,
    CRIADO_POR_ID                   ID_DOM,
    CRIADO_POR_APELIDO              NOME_REDU_DOM,
    CANCELADO_POR_ID                ID_DOM,
    CANCELADO_POR_APELIDO           NOME_REDU_DOM,
    FINALIZADO_POR_ID               ID_DOM,
    FINALIZADO_POR_APELIDO          NOME_REDU_DOM
  );
  
  /*
  usuario nao chama ins do cabecalho
  nao chama INVENTARIO_INS
  ao inves, chama ins do item,
  INVENTARIO_ITEM_INS.
  o ins do item verifica se precisa
  e cria cabecalho  
  */
  PROCEDURE INVENTARIO_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    --, TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , INVENTARIO_ID ID_DOM
  )
  RETURNS
  (
    INVENTARIO_ID_RET ID_DOM
  );
  
  -- INVENTARIO_PA.INVENTARIO_ITEM_INS DEF
  PROCEDURE INVENTARIO_ITEM_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    --, TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT
    
    , INVENTARIO_ID ID_DOM NOT NULL
    
    , PROD_ID ID_DOM NOT NULL
    , QTD QTD_DOM NOT NULL
    
    , LOG_STR VARCHAR(200) NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    EST_MOV_ID_RET BIGINT
    , DTH_DOC_RET TIMESTAMP
    , EST_MOV_CRIADO_EM_RET TIMESTAMP
    , EST_MOV_ITEM_CRIADO_EM_RET TIMESTAMP
    
    , INVENTARIO_ID_RET ID_DOM
    , ORDEM_RET SMALLINT
    , LOG_STR_RET VARCHAR(200)
  );
END^

----- BODY

RECREATE PACKAGE BODY INVENTARIO_PA
AS
BEGIN
  PROCEDURE LISTA_GET
  (
    CRIADO_EM_INICIAL TIMESTAMP NOT NULL,
    CRIADO_EM_FINAL TIMESTAMP NOT NULL
  )
  RETURNS
  (
    LOJA_ID                         ID_SHORT_DOM,
    TERMINAL_ID                     ID_SHORT_DOM,
    EST_MOV_ID                      BIGINT,
    INVENTARIO_ID                    ID_DOM,
    COD                             VARCHAR(20),

    --DTH_DOC                         TIMESTAMP,

    CRIADO_EM                       TIMESTAMP,

    FINALIZADO                      BOOLEAN,
    FINALIZADO_EM                   TIMESTAMP,

    CANCELADO                       BOOLEAN,
    --ALTERADO_EM                     TIMESTAMP,
    CANCELADO_EM                    TIMESTAMP,

    CRIADO_POR_ID                   ID_DOM,
    CRIADO_POR_APELIDO              NOME_REDU_DOM,

    CANCELADO_POR_ID                ID_DOM,
    CANCELADO_POR_APELIDO           NOME_REDU_DOM,

    FINALIZADO_POR_ID               ID_DOM,
    FINALIZADO_POR_APELIDO          NOME_REDU_DOM
  )
  AS
  BEGIN
    FOR SELECT
      EM.LOJA_ID,
      EM.TERMINAL_ID,
      EM.EST_MOV_ID,
      ES.INVENTARIO_ID,
      '' COD,
      
      --EM.DTH_DOC,
      
      EM.CRIADO_EM,
      
      EM.FINALIZADO,
      EM.FINALIZADO_EM,

      EM.CANCELADO,
      --EM.ALTERADO_EM,
      EM.CANCELADO_EM,
      
      0 CRIADO_POR_ID,
      '' CRIADO_POR_APELIDO,

      0 CANCELADO_POR_ID,
      '' CANCELADO_POR_APELIDO,

      0 FINALIZADO_POR_ID,
      '' FINALIZADO_POR_APELIDO
      
    FROM EST_MOV EM
    INNER JOIN INVENTARIO ES
      ON ES.LOJA_ID = EM.LOJA_ID
      AND ES.TERMINAL_ID = EM.TERMINAL_ID
      AND ES.EST_MOV_ID = EM.EST_MOV_ID
    WHERE
      (
        :CRIADO_EM_INICIAL = '01.01.1900' OR
        EM.CRIADO_EM >= :CRIADO_EM_INICIAL
      )
      AND
      (
        :CRIADO_EM_FINAL = '01.01.1900' OR
        EM.CRIADO_EM <= :CRIADO_EM_FINAL
      )
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,
      :INVENTARIO_ID,
      :COD,

      --:DTH_DOC,

      :CRIADO_EM,

      :FINALIZADO,
      :FINALIZADO_EM,

      :CANCELADO,
      --:ALTERADO_EM,
      :CANCELADO_EM,

      :CRIADO_POR_ID,
      :CRIADO_POR_APELIDO,

      :CANCELADO_POR_ID,
      :CANCELADO_POR_APELIDO,

      :FINALIZADO_POR_ID,
      :FINALIZADO_POR_APELIDO
    DO
      SUSPEND;
  END

  PROCEDURE INVENTARIO_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    --, TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , INVENTARIO_ID ID_DOM
  )
  RETURNS
  (
    INVENTARIO_ID_RET ID_DOM
  )
  AS
  BEGIN
    :INVENTARIO_ID_RET = COALESCE(:INVENTARIO_ID, 0);
    IF (:INVENTARIO_ID_RET = 0) THEN
    BEGIN
      :INVENTARIO_ID_RET = NEXT VALUE FOR INVENTARIO_SEQ;
      INSERT INTO INVENTARIO
      (
        LOJA_ID
        , TERMINAL_ID
        , EST_MOV_ID
        , INVENTARIO_ID
      )
      VALUES
      (
        :LOJA_ID
        , 0 --:TERMINAL_ID
        , :EST_MOV_ID
        , :INVENTARIO_ID_RET
      );
    END
    SUSPEND;
  END
  
  -- INVENTARIO_PA.INVENTARIO_ITEM_INS IMP
  PROCEDURE INVENTARIO_ITEM_INS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    --, TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT
    
    , INVENTARIO_ID ID_DOM NOT NULL
    
    , PROD_ID ID_DOM NOT NULL
    , QTD QTD_DOM NOT NULL
    
    , LOG_STR VARCHAR(200) NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    EST_MOV_ID_RET BIGINT
    , DTH_DOC_RET TIMESTAMP
    , EST_MOV_CRIADO_EM_RET TIMESTAMP
    , EST_MOV_ITEM_CRIADO_EM_RET TIMESTAMP
    
    , INVENTARIO_ID_RET ID_DOM
    , ORDEM_RET SMALLINT
    , LOG_STR_RET VARCHAR(200)
  )
  AS
    -- INVENTARIO_PA INVENTARIO_ITEM_INS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    --DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 17; -- EST_MOV
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    --DECLARE ACAO_SIS_ID ID_CHAR_DOM = '&'; -- ALTERAR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    -- INVENTARIO_PA.INVENTARIO_ITEM_INS DEF
    
    LOG_STR_RET = LOG_STR;

    SELECT EST_MOV_ID_RET, DTH_DOC_RET, EST_MOV_CRIADO_EM_RET,
      EST_MOV_ITEM_CRIADO_EM_RET, ORDEM_RET
    FROM EST_MOV_MANUT_PA.EST_MOV_ITEM_INS
    (
      :LOJA_ID
      , :TERMINAL_ID
      , :EST_MOV_ID
      , '#' -- EST_MOV_TIPO_ID #35 INVENTARIO
      , '01.01.1900' -- EST_MOV_DTH_DOC
      , '01.01.1900' -- EST_MOV_CRIADO_EM
      , :PROD_ID
      , :QTD
      
      , :LOG_PESSOA_ID
      , :MACHINE_ID
      , :MODULO_SIS_ID        
    )
    INTO :EST_MOV_ID_RET, :DTH_DOC_RET, :EST_MOV_CRIADO_EM_RET,
      :EST_MOV_ITEM_CRIADO_EM_RET, :ORDEM_RET;
    
    
    :LOG_STR_RET = :LOG_STR_RET ||';EST_MOV_ID_RET='||:EST_MOV_ID_RET;
    :LOG_STR_RET = :LOG_STR_RET ||';ORDEM_RET='||:ORDEM_RET;
    SELECT INVENTARIO_ID_RET FROM INVENTARIO_INS
    (
      :LOJA_ID
      --, :TERMINAL_ID
      , :EST_MOV_ID_RET
      , :INVENTARIO_ID
    )
    INTO :INVENTARIO_ID_RET;
    
    :LOG_STR_RET = :LOG_STR_RET ||';INVENTARIO_ID_RET='||:INVENTARIO_ID_RET;
    
    INSERT INTO INVENTARIO_ITEM
    (
      LOJA_ID
      , TERMINAL_ID
      , EST_MOV_ID
      , ORDEM
    )
    VALUES
    (
      :LOJA_ID
      , 0 -- :TERMINAL_ID
      , :EST_MOV_ID_RET
      , :ORDEM_RET
    );
    SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
