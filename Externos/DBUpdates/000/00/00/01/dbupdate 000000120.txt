TERM_LOG_HIST_PA

DELETE FROM DBUPDATE_HIST WHERE NUM>=120;
COMMIT;

-----------------------------
INICIO TERM_LOG_HIST_PA
-----------------------------
DBATUALIZ INI
DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_ASSUNTO=SIS, SYNC
DBATUALIZ_OBJETIVO=CRIAR TERM_LOG_HIST_PA
DBATUALIZ_OBS=



/*
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Assist\
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Assist\TERM_LOG_HIST_PA.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Assist\TERM_LOG_HIST_PA.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Assist\TERM_LOG_HIST_PA.sql";
*/

/////////////////////////
//
// PACKAGE TERM_LOG_HIST_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=TERM_LOG_HIST_PA
```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE TERM_LOG_HIST_PA
AS
BEGIN
  PROCEDURE ULTIMO_LOG_ID_GET
  RETURNS (LOG_ID_RET BIGINT);

  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO DEF
  PROCEDURE TEVE_CAIXA_SESSAO
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,
    ORDEM SMALLINT,
    LOJA_ID_ENVOLVIDO ID_SHORT_DOM,
    TERMINAL_ID_ENVOLVIDO ID_SHORT_DOM,
    ID_ENVOLVIDO BIGINT,
    ORDEM_ENVOLVIDO SMALLINT,
    ID_ENVOLVIDO2 BIGINT,
    SESS_ID ID_DOM,
    SESS_LOG_ID BIGINT,
    ABERTO BOOLEAN,
    CONFERIDO BOOLEAN
  );

  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO DEF
  PROCEDURE TEVE_CAIXA_SESSAO_OPERACAO
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,
    ORDEM SMALLINT,
    LOJA_ID_ENVOLVIDO ID_SHORT_DOM,
    TERMINAL_ID_ENVOLVIDO ID_SHORT_DOM,
    ID_ENVOLVIDO BIGINT,
    ORDEM_ENVOLVIDO SMALLINT,
    ID_ENVOLVIDO2 BIGINT,
    SESS_ID ID_DOM,
    OPER_ORDEM SMALLINT,
    OPER_LOG_ID BIGINT,
    OPER_TIPO_ID ID_CHAR_DOM,
    OPER_TIPO_ORDEM SMALLINT,
    VALOR DINH_DOM,
    OBS OBS_DOM
  );

  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO_DESPESA DEF
  PROCEDURE TEVE_CAIXA_SESSAO_OPERACAO_DESPESA
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    SESS_ID ID_DOM,
    OPER_ORDEM SMALLINT,
    OPER_LOG_ID BIGINT,
    DESPESA_TIPO_ID ID_SHORT_DOM,
    FORNEC_NOME NOME_DOM,
    NUMDOC VARCHAR(12)
  );

  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO_VALOR DEF
  PROCEDURE TEVE_CAIXA_SESSAO_OPERACAO_VALOR
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,
    SESS_ID ID_DOM,
    OPER_ORDEM SMALLINT,
    OPER_LOG_ID BIGINT,
    VALOR_LOG_ID BIGINT,
    PAGAMENTO_FORMA_ID ID_DOM,
    VALOR DINH_DOM
  );

  PROCEDURE TEVE_LOG_MOVS
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,

    ORDEM SMALLINT,
    LOJA_ID_ENVOLVIDO ID_SHORT_DOM,
    TERMINAL_ID_ENVOLVIDO ID_SHORT_DOM,
    ID_ENVOLVIDO BIGINT,
    ORDEM_ENVOLVIDO SMALLINT,
    ID_ENVOLVIDO2 BIGINT
  );
  
  PROCEDURE TEVE_EST_MOV_VENDA
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID              ID_SHORT_DOM,
    TERMINAL_ID          ID_SHORT_DOM,
    EST_MOV_ID           BIGINT,

    EST_MOV_TIPO_ID      ID_CHAR_DOM,
    DTH_DOC              TIMESTAMP,
    FINALIZADO           BOOLEAN,
    CANCELADO            BOOLEAN,
    CRIADO_EM            TIMESTAMP,
    ALTERADO_EM          TIMESTAMP,
    FINALIZADO_EM        TIMESTAMP,
    CANCELADO_EM         TIMESTAMP,

    VENDA_ID             ID_DOM,
    SESS_LOJA_ID         ID_SHORT_DOM,
    SESS_TERMINAL_ID     ID_SHORT_DOM,
    SESS_ID              ID_DOM,
    C                    VARCHAR(15),
    CLIENTE_LOJA_ID      ID_SHORT_DOM,
    CLIENTE_TERMINAL_ID  ID_SHORT_DOM,
    CLIENTE_ID           ID_DOM,
    ENDERECO_LOJA_ID     ID_SHORT_DOM,
    ENDERECO_TERMINAL_ID ID_SHORT_DOM,
    ENDERECO_ID          ID_DOM,
    DESCONTO_TOTAL       DINH_DOM,
    CUSTO_TOTAL          DINH_DOM,
    TOTAL_LIQUIDO        DINH_DOM,
    ENTREGA_TEM          BOOLEAN,
    ENTREGADOR_PESSOA_ID ID_DOM,
    ENTREGA_EM           TIMESTAMP
  );
  
  PROCEDURE TEVE_EST_MOV_ITEM_VENDA_ITEM
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    EST_MOV_ID BIGINT,
    ORDEM SMALLINT,

    PROD_ID ID_DOM,
    QTD QTD_DOM,
    CANCELADO BOOLEAN,
    CRIADO_EM TIMESTAMP,
    ALTERADO_EM TIMESTAMP,
    CANCELADO_EM TIMESTAMP,

    CUSTO_UNIT CUSTO_DOM,
    CUSTO DINH_DOM,
    PRECO_UNIT_ORIGINAL DINH_DOM,
    PRECO_UNIT_PROMO DINH_DOM,
    PRECO_UNIT DINH_DOM,
    PRECO_BRUTO DINH_DOM,
    DESCONTO DINH_DOM,
    PRECO DINH_DOM
    );

  PROCEDURE TEVE_VENDA_PAG
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    EST_MOV_ID BIGINT,
    ORDEM SMALLINT,

    PAGAMENTO_FORMA_ID ID_DOM,
    VALOR_DEVIDO DINH_DOM,
    VALOR_ENTREGUE DINH_DOM,
    TROCO DINH_DOM,
    CANCELADO BOOLEAN,
    CRIADO_EM TIMESTAMP,
    CANCELADO_EM TIMESTAMP
  );
END^

------ BODY

RECREATE PACKAGE BODY TERM_LOG_HIST_PA
AS
BEGIN
  PROCEDURE ULTIMO_LOG_ID_GET
  RETURNS (LOG_ID_RET BIGINT)
  AS
  BEGIN
    SELECT
      MAX(LOG_ID)
    FROM LOG
    INTO :LOG_ID_RET;
    
    IF (:LOG_ID_RET IS NULL) THEN
      :LOG_ID_RET = 0;
      
    SUSPEND;
  END

  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO IMP
  PROCEDURE TEVE_CAIXA_SESSAO
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,
    ORDEM SMALLINT,
    LOJA_ID_ENVOLVIDO ID_SHORT_DOM,
    TERMINAL_ID_ENVOLVIDO ID_SHORT_DOM,
    ID_ENVOLVIDO BIGINT,
    ORDEM_ENVOLVIDO SMALLINT,
    ID_ENVOLVIDO2 BIGINT,
    SESS_ID ID_DOM,
    SESS_LOG_ID BIGINT,
    ABERTO BOOLEAN,
    CONFERIDO BOOLEAN
  )
  AS
  BEGIN
    -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO COD
    FOR
      WITH L AS (
      SELECT LOJA_ID, TERMINAL_ID, LOG_ID, DTH,
        PESSOA_TERMINAL_ID, PESSOA_ID, MODULO_SIS_ID,
        ACAO_SIS_ID, FEATURE_SIS_ID, MACHINE_ID 
      FROM LOG
      WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
    ), LE AS (  
      SELECT LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM,
      LOJA_ID_ENVOLVIDO, TERMINAL_ID_ENVOLVIDO,
      ID_ENVOLVIDO, ORDEM_ENVOLVIDO, ID_ENVOLVIDO2
      FROM LOG_ENVOLVE_ID
      WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
    ), SES AS (
      SELECT LOJA_ID, TERMINAL_ID, SESS_ID,
        SESS_LOG_ID, ABERTO, CONFERIDO
      FROM CAIXA_SESSAO
    )
    SELECT 
        L.LOJA_ID,
        L.TERMINAL_ID,
        L.LOG_ID,
        L.DTH,
        L.PESSOA_TERMINAL_ID,
        L.PESSOA_ID,
        L.MODULO_SIS_ID,
        L.ACAO_SIS_ID,
        L.FEATURE_SIS_ID,
        L.MACHINE_ID,
        LE.ORDEM,
        LE.LOJA_ID_ENVOLVIDO,
        LE.TERMINAL_ID_ENVOLVIDO,
        LE.ID_ENVOLVIDO,
        LE.ORDEM_ENVOLVIDO,
        LE.ID_ENVOLVIDO2,
        SES.SESS_ID,
        L.LOG_ID AS SESS_LOG_ID,
        SES.ABERTO,
        SES.CONFERIDO
    FROM L
    JOIN SES ON
      L.LOJA_ID = SES.LOJA_ID
      AND L.TERMINAL_ID = SES.TERMINAL_ID
      AND L.LOG_ID = SES.SESS_LOG_ID
    JOIN LE ON
      L.LOJA_ID = LE.LOJA_ID
      AND L.TERMINAL_ID = LE.TERMINAL_ID
      AND L.LOG_ID = LE.LOG_ID
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID,
      :DTH,
      :PESSOA_TERMINAL_ID,
      :PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID,
      :ORDEM,
      :LOJA_ID_ENVOLVIDO,
      :TERMINAL_ID_ENVOLVIDO,
      :ID_ENVOLVIDO,
      :ORDEM_ENVOLVIDO,
      :ID_ENVOLVIDO2,
      :SESS_ID,
      :SESS_LOG_ID,
      :ABERTO,
      :CONFERIDO
    DO
      SUSPEND;
  END

  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO IMP
  PROCEDURE TEVE_CAIXA_SESSAO_OPERACAO
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,
    ORDEM SMALLINT,
    LOJA_ID_ENVOLVIDO ID_SHORT_DOM,
    TERMINAL_ID_ENVOLVIDO ID_SHORT_DOM,
    ID_ENVOLVIDO BIGINT,
    ORDEM_ENVOLVIDO SMALLINT,
    ID_ENVOLVIDO2 BIGINT,
    SESS_ID ID_DOM,
    OPER_ORDEM SMALLINT,
    OPER_LOG_ID BIGINT,
    OPER_TIPO_ID ID_CHAR_DOM,
    OPER_TIPO_ORDEM SMALLINT,
    VALOR DINH_DOM,
    OBS OBS_DOM
  )
  AS
  BEGIN
    -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO COD
    FOR
      WITH L AS (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, DTH,
          PESSOA_TERMINAL_ID, PESSOA_ID, MODULO_SIS_ID,
          ACAO_SIS_ID, FEATURE_SIS_ID, MACHINE_ID 
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), LE AS (  
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM,
        LOJA_ID_ENVOLVIDO, TERMINAL_ID_ENVOLVIDO,
        ID_ENVOLVIDO, ORDEM_ENVOLVIDO, ID_ENVOLVIDO2
        FROM LOG_ENVOLVE_ID
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), OPER AS (
        SELECT LOJA_ID, TERMINAL_ID, SESS_ID, OPER_ORDEM, 
          OPER_LOG_ID, OPER_TIPO_ID, OPER_TIPO_ORDEM, 
          VALOR, OBS, CANCELADO    
        FROM CAIXA_SESSAO_OPERACAO
      )
      SELECT 
          L.LOJA_ID,
          L.TERMINAL_ID,
          L.LOG_ID,
          L.DTH,
          L.PESSOA_TERMINAL_ID,
          L.PESSOA_ID,
          L.MODULO_SIS_ID,
          L.ACAO_SIS_ID,
          L.FEATURE_SIS_ID,
          L.MACHINE_ID,
          LE.ORDEM,
          LE.LOJA_ID_ENVOLVIDO,
          LE.TERMINAL_ID_ENVOLVIDO,
          LE.ID_ENVOLVIDO,
          LE.ORDEM_ENVOLVIDO,
          LE.ID_ENVOLVIDO2,
          OPER.SESS_ID,
          OPER.OPER_ORDEM,
          OPER.OPER_LOG_ID,
          OPER.OPER_TIPO_ID,
          OPER.OPER_TIPO_ORDEM,
          OPER.VALOR,
          OPER.OBS    
      FROM L
      JOIN OPER ON
        L.LOJA_ID = OPER.LOJA_ID
        AND L.TERMINAL_ID = OPER.TERMINAL_ID
        AND L.LOG_ID = OPER.OPER_LOG_ID
      JOIN LE ON
        L.LOJA_ID = LE.LOJA_ID
        AND L.TERMINAL_ID = LE.TERMINAL_ID
        AND L.LOG_ID = LE.LOG_ID
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID,
      :DTH,
      :PESSOA_TERMINAL_ID,
      :PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID,
      :ORDEM,
      :LOJA_ID_ENVOLVIDO,
      :TERMINAL_ID_ENVOLVIDO,
      :ID_ENVOLVIDO,
      :ORDEM_ENVOLVIDO,
      :ID_ENVOLVIDO2,
      :SESS_ID,
      :OPER_ORDEM,
      :OPER_LOG_ID,
      :OPER_TIPO_ID,
      :OPER_TIPO_ORDEM,
      :VALOR,
      :OBS
    DO
      SUSPEND;
  END
  
  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO_DESPESA IMP
  PROCEDURE TEVE_CAIXA_SESSAO_OPERACAO_DESPESA
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    SESS_ID ID_DOM,
    OPER_ORDEM SMALLINT,
    OPER_LOG_ID BIGINT,
    DESPESA_TIPO_ID ID_SHORT_DOM,
    FORNEC_NOME NOME_DOM,
    NUMDOC VARCHAR(12)
  )
  AS
  BEGIN
    -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO_DESPESA COD
    FOR
      WITH L AS (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), DESP AS (
        SELECT LOJA_ID, TERMINAL_ID, SESS_ID, OPER_ORDEM,
          OPER_LOG_ID, DESPESA_TIPO_ID, FORNEC_NOME, NUMDOC
        FROM CAIXA_SESSAO_OPERACAO_DESPESA
      )
      SELECT 
          DESP.LOJA_ID,
          DESP.TERMINAL_ID,
          DESP.SESS_ID,
          DESP.OPER_ORDEM,
          DESP.OPER_LOG_ID,
          DESP.DESPESA_TIPO_ID,
          DESP.FORNEC_NOME,
          DESP.NUMDOC
      FROM L
      JOIN DESP ON
        L.LOJA_ID = DESP.LOJA_ID
        AND L.TERMINAL_ID = DESP.TERMINAL_ID
        AND L.LOG_ID = DESP.OPER_LOG_ID
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :SESS_ID,
      :OPER_ORDEM,
      :OPER_LOG_ID,
      :DESPESA_TIPO_ID,
      :FORNEC_NOME,
      :NUMDOC
    DO
      SUSPEND;
  END  


  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO_VALOR IMP
  PROCEDURE TEVE_CAIXA_SESSAO_OPERACAO_VALOR
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,
    SESS_ID ID_DOM,
    OPER_ORDEM SMALLINT,
    OPER_LOG_ID BIGINT,
    VALOR_LOG_ID BIGINT,
    PAGAMENTO_FORMA_ID ID_DOM,
    VALOR DINH_DOM
  )
  AS
  BEGIN
  -- TERM_LOG_HIST_PA.TEVE_CAIXA_SESSAO_OPERACAO_VALOR COD
    FOR
      WITH L AS (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, DTH,
          PESSOA_TERMINAL_ID, PESSOA_ID, MODULO_SIS_ID,
          ACAO_SIS_ID, FEATURE_SIS_ID, MACHINE_ID 
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), VALOR AS (
        SELECT LOJA_ID, TERMINAL_ID, SESS_ID, OPER_ORDEM,
          OPER_LOG_ID, VALOR_LOG_ID, PAGAMENTO_FORMA_ID, VALOR
        FROM CAIXA_SESSAO_OPERACAO_VALOR
      )
      SELECT 
          L.LOJA_ID,
          L.TERMINAL_ID,
          L.LOG_ID,
          L.DTH,
          L.PESSOA_TERMINAL_ID,
          L.PESSOA_ID,
          L.MODULO_SIS_ID,
          L.ACAO_SIS_ID,
          L.FEATURE_SIS_ID,
          L.MACHINE_ID,    
          VALOR.SESS_ID,
          VALOR.OPER_ORDEM,
          VALOR.OPER_LOG_ID,
          VALOR.VALOR_LOG_ID,
          VALOR.PAGAMENTO_FORMA_ID,
          VALOR.VALOR
      FROM L
      JOIN VALOR ON
        L.LOJA_ID = VALOR.LOJA_ID
        AND L.TERMINAL_ID = VALOR.TERMINAL_ID
        AND L.LOG_ID = VALOR.VALOR_LOG_ID
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID,
      :DTH,
      :PESSOA_TERMINAL_ID,
      :PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID,
      :SESS_ID,
      :OPER_ORDEM,
      :OPER_LOG_ID,
      :VALOR_LOG_ID,
      :PAGAMENTO_FORMA_ID,
      :VALOR
    DO
      SUSPEND;
  END

  PROCEDURE TEVE_LOG_MOVS
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    LOG_ID BIGINT,
    DTH TIMESTAMP,
    PESSOA_TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    MODULO_SIS_ID ID_CHAR_DOM,
    ACAO_SIS_ID ID_CHAR_DOM,
    FEATURE_SIS_ID ID_SHORT_DOM,
    MACHINE_ID ID_SHORT_DOM,

    ORDEM SMALLINT,
    LOJA_ID_ENVOLVIDO ID_SHORT_DOM,
    TERMINAL_ID_ENVOLVIDO ID_SHORT_DOM,
    ID_ENVOLVIDO BIGINT,
    ORDEM_ENVOLVIDO SMALLINT,
    ID_ENVOLVIDO2 BIGINT
  )
  AS
  BEGIN
    FOR
      WITH L AS
      (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, DTH,
          PESSOA_TERMINAL_ID, PESSOA_ID, MODULO_SIS_ID,
          ACAO_SIS_ID, FEATURE_SIS_ID, MACHINE_ID
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
        AND FEATURE_SIS_ID IN (17, 18, 19)
        ORDER BY LOG_ID
      ), LE AS 
      (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM,
          LOJA_ID_ENVOLVIDO, TERMINAL_ID_ENVOLVIDO,
          ID_ENVOLVIDO, ORDEM_ENVOLVIDO, ID_ENVOLVIDO2
        FROM LOG_ENVOLVE_ID
      )
      SELECT 
        L.LOJA_ID,
        L.TERMINAL_ID,
        L.LOG_ID,
        L.DTH,
        L.PESSOA_TERMINAL_ID,
        L.PESSOA_ID,
        L.MODULO_SIS_ID,
        L.ACAO_SIS_ID,
        L.FEATURE_SIS_ID,
        L.MACHINE_ID,
        LE.ORDEM,
        LE.LOJA_ID_ENVOLVIDO,
        LE.TERMINAL_ID_ENVOLVIDO,
        LE.ID_ENVOLVIDO,
        LE.ORDEM_ENVOLVIDO,
        LE.ID_ENVOLVIDO2
      FROM L
      JOIN LE ON
      L.LOJA_ID = LE.LOJA_ID
      AND L.TERMINAL_ID = LE.TERMINAL_ID
      AND L.LOG_ID = LE.LOG_ID
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID,
      :DTH,
      :PESSOA_TERMINAL_ID,
      :PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID,
      :ORDEM,
      :LOJA_ID_ENVOLVIDO,
      :TERMINAL_ID_ENVOLVIDO,
      :ID_ENVOLVIDO,
      :ORDEM_ENVOLVIDO,
      :ID_ENVOLVIDO2
    DO
      SUSPEND;  
  END

  PROCEDURE TEVE_EST_MOV_VENDA
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID              ID_SHORT_DOM,
    TERMINAL_ID          ID_SHORT_DOM,
    EST_MOV_ID           BIGINT,

    EST_MOV_TIPO_ID      ID_CHAR_DOM,
    DTH_DOC              TIMESTAMP,
    FINALIZADO           BOOLEAN,
    CANCELADO            BOOLEAN,
    CRIADO_EM            TIMESTAMP,
    ALTERADO_EM          TIMESTAMP,
    FINALIZADO_EM        TIMESTAMP,
    CANCELADO_EM         TIMESTAMP,

    VENDA_ID             ID_DOM,
    SESS_LOJA_ID         ID_SHORT_DOM,
    SESS_TERMINAL_ID     ID_SHORT_DOM,
    SESS_ID              ID_DOM,
    C                    VARCHAR(15),
    CLIENTE_LOJA_ID      ID_SHORT_DOM,
    CLIENTE_TERMINAL_ID  ID_SHORT_DOM,
    CLIENTE_ID           ID_DOM,
    ENDERECO_LOJA_ID     ID_SHORT_DOM,
    ENDERECO_TERMINAL_ID ID_SHORT_DOM,
    ENDERECO_ID          ID_DOM,
    DESCONTO_TOTAL       DINH_DOM,
    CUSTO_TOTAL          DINH_DOM,
    TOTAL_LIQUIDO        DINH_DOM,
    ENTREGA_TEM          BOOLEAN,
    ENTREGADOR_PESSOA_ID ID_DOM,
    ENTREGA_EM           TIMESTAMP
  )
  AS
  BEGIN
    FOR
      WITH L AS
      (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
        AND FEATURE_SIS_ID = 17
        ORDER BY LOG_ID
      ), LE AS (  
            SELECT LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM,
            LOJA_ID_ENVOLVIDO, TERMINAL_ID_ENVOLVIDO,
            ID_ENVOLVIDO, ORDEM_ENVOLVIDO, ID_ENVOLVIDO2
            FROM LOG_ENVOLVE_ID
            WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), E AS (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID,
          EST_MOV_TIPO_ID, DTH_DOC, FINALIZADO, CANCELADO,
          CRIADO_EM, ALTERADO_EM, FINALIZADO_EM, CANCELADO_EM
        FROM EST_MOV
      ), V AS(  
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, VENDA_ID,
        SESS_LOJA_ID, SESS_TERMINAL_ID, SESS_ID,
        C, CLIENTE_LOJA_ID, CLIENTE_TERMINAL_ID, CLIENTE_ID,
        ENDERECO_LOJA_ID, ENDERECO_TERMINAL_ID, ENDERECO_ID,
        DESCONTO_TOTAL, CUSTO_TOTAL, TOTAL_LIQUIDO,
        ENTREGA_TEM, ENTREGADOR_PESSOA_ID, ENTREGA_EM
        FROM VENDA
      )
      SELECT DISTINCT
        E.LOJA_ID,
        E.TERMINAL_ID,
        E.EST_MOV_ID,
        E.EST_MOV_TIPO_ID,
        E.DTH_DOC,
        E.FINALIZADO,
        E.CANCELADO,
        E.CRIADO_EM,
        E.ALTERADO_EM,
        E.FINALIZADO_EM,
        E.CANCELADO_EM,

        V.VENDA_ID,
        V.SESS_LOJA_ID,
        V.SESS_TERMINAL_ID,
        V.SESS_ID,
        V.C,
        V.CLIENTE_LOJA_ID,
        V.CLIENTE_TERMINAL_ID,
        V.CLIENTE_ID,
        V.ENDERECO_LOJA_ID,
        V.ENDERECO_TERMINAL_ID,
        V.ENDERECO_ID,
        V.DESCONTO_TOTAL,
        V.CUSTO_TOTAL,
        V.TOTAL_LIQUIDO,
        V.ENTREGA_TEM,
        V.ENTREGADOR_PESSOA_ID,
        V.ENTREGA_EM   

      FROM L
      JOIN LE ON
        L.LOJA_ID = LE.LOJA_ID
        AND L.TERMINAL_ID = LE.TERMINAL_ID
        AND L.LOG_ID = LE.LOG_ID
      JOIN E ON
      E.LOJA_ID = LE.LOJA_ID_ENVOLVIDO 
      AND E.TERMINAL_ID = LE.TERMINAL_ID_ENVOLVIDO
      AND E.EST_MOV_ID = LE.ID_ENVOLVIDO
      JOIN V ON
      V.LOJA_ID = E.LOJA_ID
      AND V.TERMINAL_ID = E.TERMINAL_ID
      AND V.EST_MOV_ID = E.EST_MOV_ID
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,

      :EST_MOV_TIPO_ID,
      :DTH_DOC,
      :FINALIZADO,
      :CANCELADO,
      :CRIADO_EM,
      :ALTERADO_EM,
      :FINALIZADO_EM,
      :CANCELADO_EM,

      :VENDA_ID,
      :SESS_LOJA_ID,
      :SESS_TERMINAL_ID,
      :SESS_ID,
      :C,
      :CLIENTE_LOJA_ID,
      :CLIENTE_TERMINAL_ID,
      :CLIENTE_ID,
      :ENDERECO_LOJA_ID,
      :ENDERECO_TERMINAL_ID,
      :ENDERECO_ID,
      :DESCONTO_TOTAL,
      :CUSTO_TOTAL,
      :TOTAL_LIQUIDO,
      :ENTREGA_TEM,
      :ENTREGADOR_PESSOA_ID,
      :ENTREGA_EM
    DO
      SUSPEND;
  END

  PROCEDURE TEVE_EST_MOV_ITEM_VENDA_ITEM
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    EST_MOV_ID BIGINT,
    ORDEM SMALLINT,

    PROD_ID ID_DOM,
    QTD QTD_DOM,
    CANCELADO BOOLEAN,
    CRIADO_EM TIMESTAMP,
    ALTERADO_EM TIMESTAMP,
    CANCELADO_EM TIMESTAMP,

    CUSTO_UNIT CUSTO_DOM,
    CUSTO DINH_DOM,
    PRECO_UNIT_ORIGINAL DINH_DOM,
    PRECO_UNIT_PROMO DINH_DOM,
    PRECO_UNIT DINH_DOM,
    PRECO_BRUTO DINH_DOM,
    DESCONTO DINH_DOM,
    PRECO DINH_DOM
  )
  AS
  BEGIN
    FOR
      WITH L AS
      (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
        AND FEATURE_SIS_ID = 18
        ORDER BY LOG_ID
      ), LE AS (  
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM,
          LOJA_ID_ENVOLVIDO, TERMINAL_ID_ENVOLVIDO,
          ID_ENVOLVIDO, ORDEM_ENVOLVIDO, ID_ENVOLVIDO2
        FROM LOG_ENVOLVE_ID
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), EI AS (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, ORDEM,
          PROD_ID, QTD, CANCELADO, CRIADO_EM, ALTERADO_EM,
          CANCELADO_EM
        FROM EST_MOV_ITEM
      ), VI AS(  
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, ORDEM,
          CUSTO_UNIT, CUSTO, PRECO_UNIT_ORIGINAL,
          PRECO_UNIT_PROMO, PRECO_UNIT, PRECO_BRUTO,
          DESCONTO, PRECO
        FROM VENDA_ITEM
      )
      SELECT DISTINCT
        EI.LOJA_ID,
        EI.TERMINAL_ID,
        EI.EST_MOV_ID,
        EI.ORDEM,
        
        EI.PROD_ID,
        EI.QTD,
        EI.CANCELADO,
        EI.CRIADO_EM,
        EI.ALTERADO_EM,
        EI.CANCELADO_EM,

        VI.CUSTO_UNIT,
        VI.CUSTO,
        VI.PRECO_UNIT_ORIGINAL,
        VI.PRECO_UNIT_PROMO,
        VI.PRECO_UNIT,
        VI.PRECO_BRUTO,
        VI.DESCONTO,
        VI.PRECO                
        
      FROM L
      JOIN LE ON
        L.LOJA_ID = LE.LOJA_ID
        AND L.TERMINAL_ID = LE.TERMINAL_ID
        AND L.LOG_ID = LE.LOG_ID
      JOIN EI ON
      EI.LOJA_ID = LE.LOJA_ID_ENVOLVIDO
      AND EI.TERMINAL_ID = LE.TERMINAL_ID_ENVOLVIDO
      AND EI.EST_MOV_ID = LE.ID_ENVOLVIDO
      AND EI.ORDEM = LE.ORDEM_ENVOLVIDO
      JOIN VI ON
      VI.LOJA_ID = EI.LOJA_ID
      AND VI.TERMINAL_ID = EI.TERMINAL_ID
      AND VI.EST_MOV_ID = EI.EST_MOV_ID
      AND VI.ORDEM = EI.ORDEM
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,
      :ORDEM,

      :PROD_ID,
      :QTD,
      :CANCELADO,
      :CRIADO_EM,
      :ALTERADO_EM,
      :CANCELADO_EM,

      :CUSTO_UNIT,
      :CUSTO,
      :PRECO_UNIT_ORIGINAL,
      :PRECO_UNIT_PROMO,
      :PRECO_UNIT,
      :PRECO_BRUTO,
      :DESCONTO,
      :PRECO
    DO
      SUSPEND;
  END

  PROCEDURE TEVE_VENDA_PAG
  (
    LOG_ID_INI BIGINT
    , LOG_ID_FIN BIGINT
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    EST_MOV_ID BIGINT,
    ORDEM SMALLINT,

    PAGAMENTO_FORMA_ID ID_DOM,
    VALOR_DEVIDO DINH_DOM,
    VALOR_ENTREGUE DINH_DOM,
    TROCO DINH_DOM,
    CANCELADO BOOLEAN,
    CRIADO_EM TIMESTAMP,
    CANCELADO_EM TIMESTAMP
  )
  AS
  BEGIN
    FOR
      WITH L AS
      (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID
        FROM LOG
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
        AND FEATURE_SIS_ID = 19
        ORDER BY LOG_ID
      ), LE AS (  
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, ORDEM,
          LOJA_ID_ENVOLVIDO, TERMINAL_ID_ENVOLVIDO,
          ID_ENVOLVIDO, ORDEM_ENVOLVIDO, ID_ENVOLVIDO2
        FROM LOG_ENVOLVE_ID
        WHERE LOG_ID >= :LOG_ID_INI AND LOG_ID <= :LOG_ID_FIN
      ), P AS(  
        SELECT
          LOJA_ID,
          TERMINAL_ID,
          EST_MOV_ID,
          ORDEM,
          PAGAMENTO_FORMA_ID,
          VALOR_DEVIDO,
          VALOR_ENTREGUE,
          TROCO,
          CANCELADO,
          CRIADO_EM,
          CANCELADO_EM
        FROM VENDA_PAG
      )
      SELECT DISTINCT
        P.LOJA_ID,
        P.TERMINAL_ID,
        P.EST_MOV_ID,
        P.ORDEM,
        P.PAGAMENTO_FORMA_ID,
        P.VALOR_DEVIDO,
        P.VALOR_ENTREGUE,
        P.TROCO,
        P.CANCELADO,
        P.CRIADO_EM,
        P.CANCELADO_EM

      FROM L
      JOIN LE ON
        L.LOJA_ID = LE.LOJA_ID
        AND L.TERMINAL_ID = LE.TERMINAL_ID
        AND L.LOG_ID = LE.LOG_ID
      JOIN P ON
        P.LOJA_ID = LE.LOJA_ID_ENVOLVIDO
        AND P.TERMINAL_ID = LE.TERMINAL_ID_ENVOLVIDO
        AND P.EST_MOV_ID = LE.ID_ENVOLVIDO
        AND P.ORDEM = LE.ORDEM_ENVOLVIDO
    INTO
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,
      :ORDEM,
      :PAGAMENTO_FORMA_ID,
      :VALOR_DEVIDO,
      :VALOR_ENTREGUE,
      :TROCO,
      :CANCELADO,
      :CRIADO_EM,
      :CANCELADO_EM
    DO
      SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
