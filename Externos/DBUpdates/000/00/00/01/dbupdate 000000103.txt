CAIXA_SESSAO_PDV_PA

"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\00\00\01\dbupdate 000000103.txt"

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;

--DROP PACKAGE VENDA_PAG_INICIAL_PA;

DROP PACKAGE CAIXA_SESSAO_PDV_PA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=103;
COMMIT;



/*
C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\PDV
C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\PDV\CAIXA_SESSAO_MANUT_PA.sql

"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\PDV\CAIXA_SESSAO_MANUT_PA.sql"

IN "C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\PDV\CAIXA_SESSAO_MANUT_PA.sql";
*/

-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=FINANCEIRO
DBATUALIZ_OBJETIVO=CRIAR CAIXA_SESSAO_PDV_PA
DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE CAIXA_SESSAO_PDV_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=CAIXA_SESSAO_PDV_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE CAIXA_SESSAO_PDV_PA
AS
BEGIN
  PROCEDURE FECHAR_PODE_GET
  RETURNS
  (
    PODE BOOLEAN
    , MENSAGEM_ID ID_DOM
  );
END^

---- BODY

RECREATE PACKAGE BODY CAIXA_SESSAO_PDV_PA
AS
BEGIN
  PROCEDURE FECHAR_PODE_GET
  RETURNS
  (
    PODE BOOLEAN
    , MENSAGEM_ID ID_DOM
  )
  AS
/*
  1 = 'Pode fechar o caixa';
  2 = 'Não há caixa aberto';
  3 =  'Há uma venda não finalizada';
*/  
    DECLARE RESULTADO INTEGER;
  BEGIN
    MENSAGEM_ID = 1;
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
      SELECT SESS.SESS_ID

      FROM AMBIENTE_SIS AMBI

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID  = SESS.TERMINAL_ID

      WHERE SESS.ABERTO 
    ) INTO RESULTADO;

    IF (COALESCE(RESULTADO, 0) <> 1) THEN
    BEGIN
      PODE = FALSE;
      MENSAGEM_ID = 2;
      SUSPEND;
      EXIT;
    END

    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
      SELECT SESS.SESS_ID

      FROM AMBIENTE_SIS AMBI

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID  = SESS.TERMINAL_ID

      JOIN VENDA V ON
      V.SESS_LOJA_ID = SESS.LOJA_ID
      AND V.SESS_TERMINAL_ID  = SESS.TERMINAL_ID
      AND V.SESS_ID = SESS.SESS_ID

      JOIN EST_MOV E ON
      V.LOJA_ID = E.LOJA_ID
      AND V.TERMINAL_ID = E.TERMINAL_ID
      AND V.EST_MOV_ID = E.EST_MOV_ID

      WHERE SESS.ABERTO AND (NOT E.FINALIZADO) AND (NOT E.CANCELADO)
      ) INTO RESULTADO;

    IF (COALESCE(RESULTADO, 0) = 1) THEN
    BEGIN
      PODE = FALSE;
      MENSAGEM_ID = 3;
      SUSPEND;
      EXIT;
    END
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
