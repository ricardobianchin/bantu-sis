CAIXA_SESSAO_PDV_PA

SELECT *  FROM CAIXA_SESSAO_PDV_PA.SESS_TELA_CXOPER_LISTA_GET(1,1,1);


"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\00\00\01\dbupdate 000000103.txt"

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;

--DROP PACKAGE VENDA_PAG_INICIAL_PA;

DROP PACKAGE CAIXA_SESSAO_PDV_PA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=90;
COMMIT;


/*
-- ABAIXO EH DESNECESSARIO POIS FOI FEITO DROP DA DBUPDATE_HIST
DELETE FROM DBUPDATE_HIST WHERE NUM>=103;
COMMIT;
*/

/*
"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\App\Bantu\bantu-sis\src\externos\DBUpdates Complementos\Complementos\PDV\caixa_sessao_pdv_pa.sql"

in "C:\Pr\App\Bantu\bantu-sis\src\Externos\DBUpdates Complementos\Complementos\PDV\caixa_sessao_pdv_pa.sql";
*/

-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=FINANCEIRO
DBATUALIZ_OBJETIVO=CRIAR CAIXA_SESSAO_PDV_PA
DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE CAIXA_SESSAO_PDV_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=CAIXA_SESSAO_PDV_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE CAIXA_SESSAO_PDV_PA
AS
BEGIN
  PROCEDURE TEM_CAIXA_ABERTO
  RETURNS
  (  
    TEM BOOLEAN
  );
  
  PROCEDURE TEM_VENDA_NAO_FINALIZADA
  RETURNS
  (  
    TEM BOOLEAN
  );
  
  PROCEDURE FECHAR_PODE_GET
  RETURNS
  (
    PODE BOOLEAN
    , MENSAGEM_ID ID_DOM
  );
  
/*
SELECT * FROM CAIXA_SESSAO_PDV_PA.SESS_ULTIMO_GET;
*/

  PROCEDURE SESS_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM
    , SESS_TERMINAL_ID ID_SHORT_DOM
    , SESS_ID ID_DOM
  )
  RETURNS
  (
    OPERADOR_LOJA_ID ID_SHORT_DOM
    , OPERADOR_ID ID_DOM
    , OPERADOR_APELIDO NOME_REDU_DOM
    , CRIADO_EM TIMESTAMP
  );

  PROCEDURE SESS_ULTIMO_GET
  RETURNS
  (
    SESS_LOJA_ID ID_SHORT_DOM
    , SESS_TERMINAL_ID ID_SHORT_DOM
    , SESS_ID ID_DOM

    , OPERADOR_LOJA_ID ID_SHORT_DOM
    , OPERADOR_ID ID_DOM

    , OPERADOR_APELIDO NOME_REDU_DOM

    , CRIADO_EM TIMESTAMP
  );
  
  PROCEDURE FECH_TELA_PAGFORMA_LISTA_GET
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , DESCR NOME_DOM
  );
  
  PROCEDURE SESS_RELAT_PAGFORMA_LISTA_GET
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , DESCR NOME_DOM
  );
  
  PROCEDURE SESS_TELA_VENDAS_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , TERMINAL_ID ID_SHORT_DOM
    , ID ID_DOM
    , LOG_ID BIGINT
    , ORDEM SMALLINT
    , TIPO_ID ID_CHAR_DOM
    , TIPO_STR NOME_INTERM_DOM
    , CRIADO_EM TIMESTAMP
    , VALOR DINH_DOM
    , CANCELADO BOOLEAN
    , CANCELADO_EM TIMESTAMP
    , OBS VARCHAR(200)
  );  
  
  PROCEDURE SESS_TELA_CXOPER_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , TERMINAL_ID ID_SHORT_DOM
    , ID ID_DOM
    , LOG_ID BIGINT
    , ORDEM SMALLINT
    , TIPO_ID ID_CHAR_DOM
    , TIPO_STR NOME_INTERM_DOM
    , CRIADO_EM TIMESTAMP
    , VALOR DINH_DOM
    , CANCELADO BOOLEAN
    , CANCELADO_EM TIMESTAMP
    , OBS VARCHAR(200)
  );  
  
  PROCEDURE SESS_TELA_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , TERMINAL_ID ID_SHORT_DOM
    , ID ID_DOM
    , LOG_ID BIGINT
    , ORDEM SMALLINT
    , TIPO_ID ID_CHAR_DOM
    , TIPO_STR NOME_INTERM_DOM
    , CRIADO_EM TIMESTAMP
    , VALOR DINH_DOM
    , CANCELADO BOOLEAN
    , CANCELADO_EM TIMESTAMP
    , OBS VARCHAR(200)
  );  
  
  PROCEDURE SESS_VENDA_PAG_TOTAL_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , TOTAL PRECO_DOM
  );

  PROCEDURE SESS_RELAT_FECH_TOTAIS_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , TOTAL DINH_DOM
  );
            
  PROCEDURE SESS_RELAT_EST_MOV_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , QTD_VOLUMES INTEGER
    , DTH_DOC TIMESTAMP
  );

  PROCEDURE SESS_RELAT_BYID_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LINHA VARCHAR(80)
  );

END^

---- BODY

RECREATE PACKAGE BODY CAIXA_SESSAO_PDV_PA
AS
BEGIN
/*
SELECT * FROM CAIXA_SESSAO_PDV_PA.TEM_CAIXA_ABERTO;
*/
  PROCEDURE TEM_CAIXA_ABERTO
  RETURNS
  (  
    TEM BOOLEAN
  )
  AS
    DECLARE RESULTADO INTEGER;
  BEGIN
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
      SELECT SESS.SESS_ID

      FROM AMBIENTE_SIS AMBI

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID  = SESS.TERMINAL_ID

      WHERE SESS.ABERTO 
    ) INTO :RESULTADO;
    
    :RESULTADO = COALESCE(:RESULTADO, 0);
    
    :TEM = :RESULTADO = 1;
    SUSPEND;
  END
  
/*  
SELECT * FROM CAIXA_SESSAO_PDV_PA.TEM_VENDA_NAO_FINALIZADA;
*/
  PROCEDURE TEM_VENDA_NAO_FINALIZADA
  RETURNS
  (  
    TEM BOOLEAN
  )
  AS
    DECLARE RESULTADO INTEGER;
  BEGIN
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
      SELECT SESS.SESS_ID

      FROM AMBIENTE_SIS AMBI

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID  = SESS.TERMINAL_ID

      JOIN VENDA V ON
      V.SESS_LOJA_ID = SESS.LOJA_ID
      AND V.SESS_TERMINAL_ID  = SESS.TERMINAL_ID
      AND V.SESS_ID = SESS.SESS_ID

      JOIN EST_MOV E ON
      V.LOJA_ID = E.LOJA_ID
      AND V.TERMINAL_ID = E.TERMINAL_ID
      AND V.EST_MOV_ID = E.EST_MOV_ID

      WHERE SESS.ABERTO AND (NOT E.FINALIZADO) AND (NOT E.CANCELADO)
      ) INTO :RESULTADO;
    
    :RESULTADO = COALESCE(:RESULTADO, 0);
    
    :TEM = :RESULTADO = 1;
    SUSPEND;
  END
  
/*
SELECT * FROM CAIXA_SESSAO_PDV_PA.FECHAR_PODE_GET;
*/
  PROCEDURE FECHAR_PODE_GET
  RETURNS
  (
    PODE BOOLEAN
    , MENSAGEM_ID ID_DOM
  )
  AS
/*
  1 = 'Pode fechar o caixa';
  2 = 'Nao ha caixa aberto';
  3 = 'Ha uma venda nao finalizada';
*/  
    DECLARE TEM_CX_ABERTO BOOLEAN;
    DECLARE TEM_VEN_NAO_FIN BOOLEAN;
  BEGIN
    PODE = TRUE;
    MENSAGEM_ID = 1;
    
    SELECT TEM FROM TEM_CAIXA_ABERTO INTO :TEM_CX_ABERTO;
    
    IF (NOT :TEM_CX_ABERTO) THEN
    BEGIN
      PODE = FALSE;
      MENSAGEM_ID = 2;
      SUSPEND;
      EXIT;
    END

    SELECT TEM FROM TEM_VENDA_NAO_FINALIZADA INTO :TEM_VEN_NAO_FIN;
    
    IF (:TEM_VEN_NAO_FIN) THEN
    BEGIN
      PODE = FALSE;
      MENSAGEM_ID = 3;
      SUSPEND;
      EXIT;
    END

    SUSPEND;
  END

  PROCEDURE SESS_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM
    , SESS_TERMINAL_ID ID_SHORT_DOM
    , SESS_ID ID_DOM
  )
  RETURNS
  (
    OPERADOR_LOJA_ID ID_SHORT_DOM
    , OPERADOR_ID ID_DOM
    , OPERADOR_APELIDO NOME_REDU_DOM
    , CRIADO_EM TIMESTAMP
  )
  AS
  BEGIN
    FOR
      SELECT FIRST(1)
        P.LOJA_ID
        , P.PESSOA_ID
        , P.APELIDO
        , L.DTH
        
      FROM CAIXA_SESSAO S

      JOIN LOG L ON
      S.LOJA_ID = L.LOJA_ID
      AND S.TERMINAL_ID = L.TERMINAL_ID
      AND S.SESS_LOG_ID = L.LOG_ID

      JOIN PESSOA P ON
      P.LOJA_ID = L.LOJA_ID
      AND P.PESSOA_ID = L.PESSOA_ID

      WHERE S.LOJA_ID = :SESS_LOJA_ID
      AND S.TERMINAL_ID = :SESS_TERMINAL_ID
      AND S.SESS_ID = :SESS_ID
  
    INTO
      :OPERADOR_LOJA_ID
      , :OPERADOR_ID
      , :OPERADOR_APELIDO
      , :CRIADO_EM
    DO
    BEGIN
      SUSPEND;
    END
  END




  PROCEDURE SESS_ULTIMO_GET
  RETURNS
  (
    SESS_LOJA_ID ID_SHORT_DOM
    , SESS_TERMINAL_ID ID_SHORT_DOM
    , SESS_ID ID_DOM

    , OPERADOR_LOJA_ID ID_SHORT_DOM
    , OPERADOR_ID ID_DOM

    , OPERADOR_APELIDO NOME_REDU_DOM

    , CRIADO_EM TIMESTAMP
  )
  AS
  BEGIN
    FOR
      SELECT FIRST(1)
        S.LOJA_ID
        , S.TERMINAL_ID
        , S.SESS_ID

        , P.LOJA_ID
        , P.PESSOA_ID
        , P.APELIDO

        , L.DTH

      FROM CAIXA_SESSAO S

      JOIN LOG L ON
      S.LOJA_ID = L.LOJA_ID
      AND S.TERMINAL_ID = L.TERMINAL_ID
      AND S.SESS_LOG_ID = L.LOG_ID

      JOIN PESSOA P ON
      P.LOJA_ID = L.LOJA_ID
      AND P.PESSOA_ID = L.PESSOA_ID

      ORDER BY L.DTH DESC
      INTO
        :SESS_LOJA_ID
        , :SESS_TERMINAL_ID
        , :SESS_ID

        , :OPERADOR_LOJA_ID
        , :OPERADOR_ID

        , :OPERADOR_APELIDO

        , :CRIADO_EM
    DO
    BEGIN
      SUSPEND;
    END
  END
  
  PROCEDURE FECH_TELA_PAGFORMA_LISTA_GET
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , DESCR NOME_DOM
  )
  AS
  BEGIN
    FOR
      WITH TIPO AS 
      (
        SELECT PAGAMENTO_FORMA_TIPO_ID ID, DESCR_RED
        FROM PAGAMENTO_FORMA_TIPO
        WHERE ATIVO
      ), FORMA AS
      (
          SELECT PAGAMENTO_FORMA_ID ID, PAGAMENTO_FORMA_TIPO_ID TIPO_ID, DESCR
          FROM PAGAMENTO_FORMA
          WHERE ATIVO AND PARA_VENDA
      )
      SELECT 
        FORMA.ID, 
        CASE
          WHEN TIPO.ID = '!' THEN FORMA.DESCR
          WHEN TIPO.ID = '"' THEN FORMA.DESCR || ' ' || TIPO.DESCR_RED
          WHEN TIPO.ID = '#' THEN FORMA.DESCR || ' ' || TIPO.DESCR_RED
          WHEN TIPO.ID = '$' THEN TIPO.DESCR_RED || ' ' || FORMA.DESCR
        END AS DESCR
      FROM TIPO
      JOIN FORMA ON
      TIPO.ID = FORMA.TIPO_ID
      ORDER BY FORMA.ID
    INTO :FORMA_ID, :DESCR
    DO SUSPEND;
  END
  
  PROCEDURE SESS_RELAT_PAGFORMA_LISTA_GET
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , DESCR NOME_DOM
  )
  AS
  BEGIN
    FOR
      WITH TIPO AS 
      (
        SELECT PAGAMENTO_FORMA_TIPO_ID ID, DESCR_RED
        FROM PAGAMENTO_FORMA_TIPO
        WHERE ATIVO
      ), FORMA AS
      (
          SELECT PAGAMENTO_FORMA_ID ID, PAGAMENTO_FORMA_TIPO_ID TIPO_ID,
            DESCR_RED
          FROM PAGAMENTO_FORMA
          WHERE ATIVO AND PARA_VENDA
      )
      SELECT 
        FORMA.ID, 
        CASE
          WHEN TIPO.ID = '!' THEN TRIM(FORMA.DESCR_RED)
          WHEN TIPO.ID = '"' THEN TRIM(FORMA.DESCR_RED) || ' ' || TRIM(TIPO.DESCR_RED)
          WHEN TIPO.ID = '#' THEN TRIM(FORMA.DESCR_RED) || ' ' || TRIM(TIPO.DESCR_RED)
          WHEN TIPO.ID = '$' THEN TRIM(FORMA.DESCR_RED)
        END AS DESCR
      FROM TIPO
      JOIN FORMA ON
      TIPO.ID = FORMA.TIPO_ID
      ORDER BY FORMA.ID
    INTO :FORMA_ID, :DESCR
    DO SUSPEND;
  END
  
  PROCEDURE SESS_TELA_VENDAS_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , TERMINAL_ID ID_SHORT_DOM
    , ID ID_DOM
    , LOG_ID BIGINT
    , ORDEM SMALLINT
    , TIPO_ID ID_CHAR_DOM
    , TIPO_STR NOME_INTERM_DOM
    , CRIADO_EM TIMESTAMP
    , VALOR DINH_DOM
    , CANCELADO BOOLEAN
    , CANCELADO_EM TIMESTAMP
    , OBS VARCHAR(200)
  )
  AS
  BEGIN
    FOR
      WITH E AS
      (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, CRIADO_EM, CANCELADO, CANCELADO_EM
        FROM EST_MOV
        WHERE FINALIZADO
      ), V AS
      (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, VENDA_ID, TOTAL_LIQUIDO 
        FROM VENDA
        WHERE SESS_LOJA_ID = :SESS_LOJA_ID
        AND SESS_TERMINAL_ID = :SESS_TERMINAL_ID
        AND SESS_ID = :SESS_ID
      )  
      SELECT 
        E.LOJA_ID
        , E.TERMINAL_ID
        , E.EST_MOV_ID
        , -1 AS LOG_ID
        , 0 AS ORDEM
        , '*' AS TIPO_ID
        , 'VENDA' AS TIPO_STR
        , E.CRIADO_EM
        , V.TOTAL_LIQUIDO AS VALOR
        , E.CANCELADO
        , E.CANCELADO_EM
        , '' AS OBS
      FROM E
      JOIN V
        ON E.LOJA_ID = V.LOJA_ID
        AND E.TERMINAL_ID = V.TERMINAL_ID
        AND E.EST_MOV_ID = V.EST_MOV_ID
    INTO
      :LOJA_ID
      , :TERMINAL_ID
      , :ID
      , :LOG_ID
      , :ORDEM
      , :TIPO_ID
      , :TIPO_STR
      , :CRIADO_EM
      , :VALOR
      , :CANCELADO
      , :CANCELADO_EM
      , :OBS
    DO SUSPEND;
  END
  
  PROCEDURE SESS_TELA_CXOPER_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , TERMINAL_ID ID_SHORT_DOM
    , ID ID_DOM
    , LOG_ID BIGINT
    , ORDEM SMALLINT
    , TIPO_ID ID_CHAR_DOM
    , TIPO_STR NOME_INTERM_DOM
    , CRIADO_EM TIMESTAMP
    , VALOR DINH_DOM
    , CANCELADO BOOLEAN
    , CANCELADO_EM TIMESTAMP
    , OBS VARCHAR(200)
  )
  AS
  BEGIN
    FOR
      WITH T AS
      (
        SELECT OPER_TIPO_ID, NAME
        FROM CAIXA_SESSAO_OPERACAO_TIPO
      ), DT AS
      (
        SELECT DESPESA_TIPO_ID, DESCR
        FROM DESPESA_TIPO
      ), O AS
      (
        SELECT LOJA_ID, TERMINAL_ID, SESS_ID,OPER_ORDEM, OPER_LOG_ID,
          OPER_TIPO_ID, VALOR, OBS, CANCELADO
        FROM CAIXA_SESSAO_OPERACAO
        WHERE LOJA_ID = :SESS_LOJA_ID
        AND TERMINAL_ID = :SESS_TERMINAL_ID
        AND SESS_ID = :SESS_ID
      ), L AS
      (
        SELECT LOJA_ID, TERMINAL_ID, LOG_ID, DTH
        FROM LOG
      ), D AS
      (
        SELECT LOJA_ID, TERMINAL_ID, SESS_ID, OPER_ORDEM, OPER_LOG_ID,
          DESPESA_TIPO_ID, FORNEC_NOME, NUMDOC
        FROM CAIXA_SESSAO_OPERACAO_DESPESA
      )      
      SELECT 
        O.LOJA_ID
        , O.TERMINAL_ID
        , O.SESS_ID AS ID
        , O.OPER_LOG_ID AS LOG_ID
        , O.OPER_ORDEM AS ORDEM
        , O.OPER_TIPO_ID AS TIPO_ID
        , T.NAME AS TIPO_STR
        , L.DTH AS CRIADO_EM
        , O.VALOR
        , O.CANCELADO
        , '01.01.1900' AS CANCELADO_EM
        , TRIM(O.OBS || ' ' || DT.DESCR || ' ' || D.FORNEC_NOME || ' ' || D.NUMDOC) OBS
      FROM T
      JOIN O
        ON T.OPER_TIPO_ID = O.OPER_TIPO_ID
      JOIN L
        ON O.LOJA_ID = L.LOJA_ID
        AND O.TERMINAL_ID = L.TERMINAL_ID
        AND O.OPER_LOG_ID = L.LOG_ID
      JOIN D ON
        O.LOJA_ID = D.LOJA_ID
        AND O.TERMINAL_ID = D.TERMINAL_ID
        AND O.SESS_ID = D.SESS_ID
        AND O.OPER_LOG_ID = D.OPER_LOG_ID
      JOIN DT ON
        D.DESPESA_TIPO_ID = DT.DESPESA_TIPO_ID
    INTO
      :LOJA_ID
      , :TERMINAL_ID
      , :ID
      , :LOG_ID
      , :ORDEM
      , :TIPO_ID
      , :TIPO_STR
      , :CRIADO_EM
      , :VALOR
      , :CANCELADO
      , :CANCELADO_EM
      , :OBS
    DO SUSPEND;
  END
  
  PROCEDURE SESS_TELA_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM
    , TERMINAL_ID ID_SHORT_DOM
    , ID ID_DOM
    , LOG_ID BIGINT
    , ORDEM SMALLINT
    , TIPO_ID ID_CHAR_DOM
    , TIPO_STR NOME_INTERM_DOM
    , CRIADO_EM TIMESTAMP
    , VALOR DINH_DOM
    , CANCELADO BOOLEAN
    , CANCELADO_EM TIMESTAMP
    , OBS VARCHAR(200)
  )
  AS
  BEGIN
    FOR
      SELECT 
        LOJA_ID
        , TERMINAL_ID
        , ID
        , LOG_ID
        , ORDEM
        , TIPO_ID
        , TIPO_STR
        , CRIADO_EM
        , VALOR
        , CANCELADO
        , CANCELADO_EM
        , OBS
      FROM SESS_TELA_VENDAS_LISTA_GET(
        :SESS_LOJA_ID
        , :SESS_TERMINAL_ID
        , :SESS_ID
      )
      UNION ALL
      SELECT 
        LOJA_ID
        , TERMINAL_ID
        , ID
        , LOG_ID
        , ORDEM
        , TIPO_ID
        , TIPO_STR
        , CRIADO_EM
        , VALOR
        , CANCELADO
        , CANCELADO_EM
        , OBS
      FROM SESS_TELA_CXOPER_LISTA_GET(
        :SESS_LOJA_ID
        , :SESS_TERMINAL_ID
        , :SESS_ID
      )
    INTO
      :LOJA_ID
      , :TERMINAL_ID
      , :ID
      , :LOG_ID
      , :ORDEM
      , :TIPO_ID
      , :TIPO_STR
      , :CRIADO_EM
      , :VALOR
      , :CANCELADO
      , :CANCELADO_EM
      , :OBS
    DO SUSPEND;
  END
  
  PROCEDURE SESS_VENDA_PAG_TOTAL_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , TOTAL PRECO_DOM
  )
  AS
  BEGIN
    FOR 
      WITH V AS (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, VENDA_ID
        FROM VENDA
        WHERE 
          SESS_LOJA_ID = :SESS_LOJA_ID
          AND SESS_TERMINAL_ID = :SESS_TERMINAL_ID
          AND SESS_ID = :SESS_ID
      ), 
      PAG AS (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID, PAGAMENTO_FORMA_ID, VALOR_DEVIDO
        FROM VENDA_PAG
        WHERE NOT CANCELADO
      ),
      E AS (
        SELECT LOJA_ID, TERMINAL_ID, EST_MOV_ID
        FROM EST_MOV
        WHERE NOT CANCELADO AND FINALIZADO
      )
      SELECT 
        PAG.PAGAMENTO_FORMA_ID, 
        SUM(PAG.VALOR_DEVIDO) AS TOTAL
      FROM V
      JOIN PAG 
        ON V.LOJA_ID = PAG.LOJA_ID 
        AND V.TERMINAL_ID = PAG.TERMINAL_ID 
        AND V.EST_MOV_ID = PAG.EST_MOV_ID
      JOIN E 
        ON V.LOJA_ID = E.LOJA_ID 
        AND V.TERMINAL_ID = E.TERMINAL_ID 
        AND V.EST_MOV_ID = E.EST_MOV_ID
      GROUP BY PAG.PAGAMENTO_FORMA_ID
    INTO :FORMA_ID, :TOTAL
    DO SUSPEND;
  END
  
  PROCEDURE SESS_RELAT_FECH_TOTAIS_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    FORMA_ID ID_SHORT_DOM
    , TOTAL DINH_DOM
  )
  AS
  BEGIN
    FOR 
      SELECT OV.PAGAMENTO_FORMA_ID FORMA_ID, SUM(OV.VALOR) TOTAL
      FROM CAIXA_SESSAO_OPERACAO O
      JOIN CAIXA_SESSAO_OPERACAO_VALOR OV
      ON O.LOJA_ID = OV.LOJA_ID
      AND O.TERMINAL_ID = OV.TERMINAL_ID
      AND O.SESS_ID = OV.SESS_ID
      AND O.OPER_ORDEM = OV.OPER_ORDEM
      WHERE O.LOJA_ID = :LOJA_ID
      AND O.TERMINAL_ID = :TERMINAL_ID
      AND O.SESS_ID = :SESS_ID
      AND NOT O.CANCELADO
      AND O.OPER_TIPO_ID = '('
      GROUP BY FORMA_ID
    INTO
      :FORMA_ID
      , :TOTAL
    DO
    BEGIN
      SUSPEND;
    END
  END

  PROCEDURE SESS_RELAT_EST_MOV_LISTA_GET
  (
    SESS_LOJA_ID ID_SHORT_DOM NOT NULL
    , SESS_TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , QTD_VOLUMES INTEGER
    , DTH_DOC TIMESTAMP
  )
  AS
  BEGIN
    FOR
      SELECT E.LOJA_ID, E.TERMINAL_ID, E.EST_MOV_ID,
        SUM(CASE 
          WHEN I.QTD = CAST(I.QTD AS INTEGER) THEN I.QTD 
          ELSE 1 
        END) QTD_VOLUMES
        , E.DTH_DOC

      FROM EST_MOV E

      JOIN EST_MOV_ITEM I ON  
      E.LOJA_ID = I.LOJA_ID
      AND E.TERMINAL_ID = I.TERMINAL_ID
      AND E.EST_MOV_ID = I.EST_MOV_ID

      JOIN VENDA V ON
      V.LOJA_ID = E.LOJA_ID
      AND V.TERMINAL_ID = E.TERMINAL_ID
      AND V.EST_MOV_ID = E.EST_MOV_ID

      WHERE V.LOJA_ID = :SESS_LOJA_ID
      AND V.TERMINAL_ID = :SESS_TERMINAL_ID
      AND V.SESS_ID = :SESS_ID
      AND E.FINALIZADO
      AND NOT E.CANCELADO
      GROUP BY E.LOJA_ID, E.TERMINAL_ID, E.EST_MOV_ID, E.DTH_DOC

    INTO :LOJA_ID, :TERMINAL_ID, :EST_MOV_ID, :QTD_VOLUMES, :DTH_DOC
    DO
      SUSPEND;
  END

  PROCEDURE SESS_RELAT_BYID_GET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , SESS_ID ID_DOM NOT NULL
  )
  RETURNS
  (
    LINHA VARCHAR(80)
  )
  AS
    -- INICIO DO RELATORIO INICIO
    DECLARE OPERADOR_LOJA_ID ID_SHORT_DOM;
    DECLARE OPERADOR_ID ID_DOM;
    DECLARE OPERADOR_APELIDO NOME_REDU_DOM;
    DECLARE CRIADO_EM TIMESTAMP;
    DECLARE FECHADO_EM TIMESTAMP;
    -- INICIO DO RELATORIO FIM

    DECLARE TIPO_ID ID_CHAR_DOM;
    DECLARE TIPO_NAME NOME_INTERM_DOM;
    DECLARE TIPO_SINAL_NUMERICO SMALLINT; 
    DECLARE TOTAL DINH_DOM;

    DECLARE COMPARE_FORMA_ID ID_SHORT_DOM;
    DECLARE COMPARE_DESCR NOME_DOM;
    DECLARE COMPARE_PAG_TOTAL DINH_DOM;
    DECLARE COMPARE_DIGITADO DINH_DOM;
    DECLARE COMPARE_DIF DINH_DOM;

    DECLARE POR_HORA_HORA SMALLINT;
    DECLARE POR_HORA_VOLUMES INTEGER;
    DECLARE POR_HORA_TICKETS INTEGER;
    DECLARE POR_HORA_TOTAL DINH_DOM;

  BEGIN
    -- INICIO DO RELATORIO INICIO
    SELECT
      OPERADOR_LOJA_ID
      , OPERADOR_ID
      , OPERADOR_APELIDO
      , CRIADO_EM
    FROM CAIXA_SESSAO_PDV_PA.SESS_GET
    (
      :LOJA_ID
      , :TERMINAL_ID
      , :SESS_ID
    )
    INTO
      :OPERADOR_LOJA_ID
      , :OPERADOR_ID
      , :OPERADOR_APELIDO
      , :CRIADO_EM;

    LINHA = :OPERADOR_LOJA_ID;
    SUSPEND;
    
    LINHA = :OPERADOR_ID;
    SUSPEND;
    
    LINHA = :OPERADOR_APELIDO;
    SUSPEND;
    
    LINHA = :CRIADO_EM;
    SUSPEND;
    -- INICIO DO RELATORIO FIM

    SELECT L.DTH 

    FROM CAIXA_SESSAO_OPERACAO O

    JOIN LOG L ON
    O.LOJA_ID = L.LOJA_ID
    AND O.TERMINAL_ID = L.TERMINAL_ID
    AND O.OPER_LOG_ID = L.LOG_ID

    WHERE O.LOJA_ID = :LOJA_ID
    AND O.TERMINAL_ID = :TERMINAL_ID 
    AND O.SESS_ID = :SESS_ID
    AND O.OPER_TIPO_ID = '('
    AND NOT O.CANCELADO
    INTO
      :FECHADO_EM;

    :FECHADO_EM = COALESCE(:FECHADO_EM, '1900-01-01 00:00:00.000');  

    LINHA = :FECHADO_EM;
    SUSPEND;
    
    FOR 
      SELECT 
        O.OPER_TIPO_ID
        , T.NAME
        , T.SINAL_NUMERICO
        , SUM(V.VALOR) AS TOTAL

      FROM CAIXA_SESSAO_OPERACAO_TIPO T

      JOIN CAIXA_SESSAO_OPERACAO O ON
      T.OPER_TIPO_ID = O.OPER_TIPO_ID

      JOIN CAIXA_SESSAO_OPERACAO_VALOR V ON
      O.LOJA_ID = V.LOJA_ID
      AND O.TERMINAL_ID = V.TERMINAL_ID
      AND O.SESS_ID = V.SESS_ID
      AND O.OPER_ORDEM = V.OPER_ORDEM

      WHERE NOT O.CANCELADO
      AND O.OPER_TIPO_ID <> '('

      GROUP BY 
        O.OPER_TIPO_ID
        , T.NAME
        , T.SINAL_NUMERICO
      ORDER BY
        O.OPER_TIPO_ID
    INTO
      :TIPO_ID
      , :TIPO_NAME
      , :TIPO_SINAL_NUMERICO
      , :TOTAL
     DO
     BEGIN
        LINHA = '2;' || :TIPO_NAME || ';' || :TIPO_SINAL_NUMERICO || ';' || :TOTAL;
        SUSPEND;
     END

    FOR
      SELECT 
        F.FORMA_ID
        , F.DESCR
        , COALESCE(D.TOTAL, 0) DIGITADO
        , P.TOTAL PAG_TOTAL
        , COALESCE(D.TOTAL, 0) - P.TOTAL DIF
      FROM CAIXA_SESSAO_PDV_PA.SESS_RELAT_PAGFORMA_LISTA_GET F

      LEFT JOIN CAIXA_SESSAO_PDV_PA.SESS_RELAT_FECH_TOTAIS_GET(1,1,1) D ON
      F.FORMA_ID = D.FORMA_ID

      JOIN CAIXA_SESSAO_PDV_PA.SESS_VENDA_PAG_TOTAL_GET(1,1,1) P ON
      F.FORMA_ID = P.FORMA_ID

      ORDER BY F.FORMA_ID
    INTO
      :COMPARE_FORMA_ID
      , :COMPARE_DESCR
      , :COMPARE_DIGITADO
      , :COMPARE_PAG_TOTAL
      , :COMPARE_DIF
    DO
    BEGIN
      LINHA = '3;' || :COMPARE_DESCR || ';' || :COMPARE_DIGITADO || ';' || :COMPARE_PAG_TOTAL || ';' || :COMPARE_DIF;
      SUSPEND;
    END

    FOR
      SELECT EXTRACT(HOUR FROM E.DTH_DOC) AS HORA
        , SUM(E.QTD_VOLUMES) QTD_VOLUMES
        , COUNT(E.EST_MOV_ID) QTD_TICKETS
        , SUM(V.TOTAL_LIQUIDO) TOTAL
      FROM VENDA V
      JOIN CAIXA_SESSAO_PDV_PA.SESS_RELAT_EST_MOV_LISTA_GET(1,1,1) E ON
      V.LOJA_ID = E.LOJA_ID
      AND V.TERMINAL_ID = E.TERMINAL_ID
      AND V.EST_MOV_ID = E.EST_MOV_ID
      AND V.LOJA_ID = :LOJA_ID
      AND V.TERMINAL_ID = :TERMINAL_ID
      AND V.SESS_ID = :SESS_ID
      GROUP BY EXTRACT(HOUR FROM E.DTH_DOC)
      ORDER BY EXTRACT(HOUR FROM E.DTH_DOC)
    INTO  
      :POR_HORA_HORA
      , :POR_HORA_VOLUMES
      , :POR_HORA_TICKETS
      , :POR_HORA_TOTAL
    DO
    BEGIN
      LINHA = '4;' || :POR_HORA_HORA 
        || ';' || :POR_HORA_VOLUMES
        || ';' || :POR_HORA_TICKETS
        || ';' || :POR_HORA_TOTAL;
      SUSPEND;
    END
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
