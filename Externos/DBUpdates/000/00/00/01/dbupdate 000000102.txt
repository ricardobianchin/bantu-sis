VENDA_PAG_INS_PA

"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES\000\00\00\01\DBUPDATE 000000101.TXT"

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;

--DROP PACKAGE VENDA_PAG_INICIAL_PA;

DROP PACKAGE VENDA_PAG_INS_PA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=101;
COMMIT;



/*

C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\FIN
C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\FIN\VENDA_PAG_INS_PA.SQL

"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\FIN\VENDA_PAG_INS_PA.SQL"

IN "C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES COMPLEMENTOS\COMPLEMENTOS\FIN\VENDA_PAG_INS_PA.SQL";


*/




-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=FINANCEIRO
DBATUALIZ_OBJETIVO=CRIAR VENDA_PAG_INS_PA
DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE VENDA_PAG_INS_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=VENDA_PAG_INS_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE VENDA_PAG_INS_PA
AS
BEGIN
  PROCEDURE FINALIZE_SO_DIN
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    TERMINAL_ID ID_SHORT_DOM NOT NULL,
    EST_MOV_ID BIGINT NOT NULL
  )
  RETURNS
  (
    FINALIZADO_EM_RET TIMESTAMP,
    DESCONTO_TOTAL_RET NUMERIC(12, 2),
    CUSTO_TOTAL_RET NUMERIC(12, 2),
    TOTAL_LIQUIDO_RET NUMERIC(12, 2)
  );

  PROCEDURE CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    TERMINAL_ID ID_SHORT_DOM NOT NULL,
    EST_MOV_ID BIGINT NOT NULL,
    ORDEM SMALLINT NOT NULL
  )
  RETURNS
  (
    CANCELADO_EM TIMESTAMP
  );
END^

---- BODY

RECREATE PACKAGE BODY VENDA_PAG_INS_PA
AS
BEGIN
  PROCEDURE FINALIZE_SO_DIN
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    TERMINAL_ID ID_SHORT_DOM NOT NULL,
    EST_MOV_ID BIGINT NOT NULL
  )
  RETURNS
  (
    FINALIZADO_EM_RET TIMESTAMP,
    DESCONTO_TOTAL_RET NUMERIC(12, 2),
    CUSTO_TOTAL_RET NUMERIC(12, 2),
    TOTAL_LIQUIDO_RET NUMERIC(12, 2)
  )
  AS
  BEGIN
    SELECT FINALIZADO_EM_RET, DESCONTO_TOTAL_RET, CUSTO_TOTAL_RET, TOTAL_LIQUIDO_RET
    FROM VENDA_PDV_INS_PA.FINALIZE
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID
    )
    INTO
      :FINALIZADO_EM_RET,
      :DESCONTO_TOTAL_RET,
      :CUSTO_TOTAL_RET,
      :TOTAL_LIQUIDO_RET;

    INSERT INTO VENDA_PAG
    (
      LOJA_ID,
      TERMINAL_ID,
      EST_MOV_ID,
      ORDEM,
      PAGAMENTO_FORMA_ID,
      VALOR_DEVIDO,
      VALOR_ENTREGUE,
      TROCO,
      CANCELADO
    )
    VALUES
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,
      0,
      1,
      :TOTAL_LIQUIDO_RET,
      :TOTAL_LIQUIDO_RET,
      0,
      FALSE
    );

    SUSPEND;
  END

  PROCEDURE CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    TERMINAL_ID ID_SHORT_DOM NOT NULL,
    EST_MOV_ID BIGINT NOT NULL,
    ORDEM SMALLINT NOT NULL
  )
  RETURNS
  (
    CANCELADO_EM TIMESTAMP
  )
  AS
  BEGIN
    CANCELADO_EM = 'NOW';

    UPDATE VENDA_PAG SET
      CANCELADO = TRUE
      , CANCELADO_EM = :CANCELADO_EM
    WHERE
      LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID
      AND ORDEM = :ORDEM
      ;
    
    UPDATE VENDA SET 
      ALTERADO_EM = :CANCELADO_EM
    WHERE
      LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID
      ;

    SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
