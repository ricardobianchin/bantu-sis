VENDA_PAG_INS_PA

"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\PR\APP\BANTU\BANTU-SIS\SRC\EXTERNOS\DBUPDATES\000\00\00\01\DBUPDATE 000000101.TXT"

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;

--DROP PACKAGE VENDA_PAG_INICIAL_PA;

DROP PACKAGE VENDA_PAG_INS_PA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=101;
COMMIT;



/*

C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\VENDA_PAG_INS_PA.sql

"C:\PROGRAM FILES\NOTEPAD++\NOTEPAD++.EXE" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\VENDA_PAG_INS_PA.sql"

IN "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Estoque\VENDA_PAG_INS_PA.sql";


*/




-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=FINANCEIRO
DBATUALIZ_OBJETIVO=CRIAR VENDA_PAG_INS_PA
DBATUALIZ_PONTO_ALVO=TERMINAL
DBATUALIZ_OBS=




/////////////////////////
//
// PACKAGE VENDA_PAG_INS_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=VENDA_PAG_INS_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE VENDA_PAG_INS_PA
AS
BEGIN
  PROCEDURE FINALIZE_SO_DIN
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    FINALIZADO_EM_RET TIMESTAMP,
    DESCONTO_TOTAL_RET DINH_DOM,
    CUSTO_TOTAL_RET DINH_DOM,
    TOTAL_LIQUIDO_RET DINH_DOM
  );

  PROCEDURE CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , ORDEM SMALLINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    CANCELADO_EM TIMESTAMP
  );
  
  PROCEDURE VENDA_PAG_INSERIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , ORDEM SMALLINT NOT NULL

    , PAGAMENTO_FORMA_ID ID_DOM NOT NULL
    , VALOR_DEVIDO DINH_DOM NOT NULL
    , VALOR_ENTREGUE DINH_DOM NOT NULL
    , TROCO DINH_DOM NOT NULL
  
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  );
END^

---- BODY

RECREATE PACKAGE BODY VENDA_PAG_INS_PA
AS
BEGIN
  PROCEDURE FINALIZE_SO_DIN
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  RETURNS
  (
    FINALIZADO_EM_RET TIMESTAMP,
    DESCONTO_TOTAL_RET DINH_DOM,
    CUSTO_TOTAL_RET DINH_DOM,
    TOTAL_LIQUIDO_RET DINH_DOM
  )
  AS
    -- VENDA_PAG_INS_PA FINALIZE_SO_DIN LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 19; -- VENDA_PAG
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    DECLARE LOG_ID_RET BIGINT;
    DECLARE ORDEM SMALLINT;
  BEGIN
    :ORDEM = 0;

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID, -- ID_ENVOLVIDO INTEGER,
      :ORDEM -- ORDEM_ENVOLVIDO SMALLINT
    );

    SELECT FINALIZADO_EM_RET, DESCONTO_TOTAL_RET, CUSTO_TOTAL_RET, TOTAL_LIQUIDO_RET
    FROM VENDA_PDV_INS_PA.FINALIZE_E_TOTALIZE
    (
      :LOJA_ID
      , :TERMINAL_ID
      , :EST_MOV_ID

      , :LOG_PESSOA_ID
      , :MACHINE_ID
      --, :MODULO_SIS_ID
    )
    INTO
      :FINALIZADO_EM_RET,
      :DESCONTO_TOTAL_RET,
      :CUSTO_TOTAL_RET,
      :TOTAL_LIQUIDO_RET;

    INSERT INTO VENDA_PAG
    (
      LOJA_ID,
      TERMINAL_ID,
      EST_MOV_ID,
      ORDEM,
      PAGAMENTO_FORMA_ID,
      VALOR_DEVIDO,
      VALOR_ENTREGUE,
      TROCO,
      CANCELADO
    )
    VALUES
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,
      :ORDEM,
      1,
      :TOTAL_LIQUIDO_RET,
      :TOTAL_LIQUIDO_RET,
      0,
      FALSE
    );

    SUSPEND;
  END

  PROCEDURE CANCELE
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , ORDEM SMALLINT NOT NULL

    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL --202500014402207
  )
  RETURNS
  (
    CANCELADO_EM TIMESTAMP
  )
  AS
    -- VENDA_PAG_INS_PA CANCELE LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 19; -- VENDA_PAG
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ')'; -- CANCELAR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    SELECT LOG_ID_RET, DTH
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET, CANCELADO_EM;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID, -- ID_ENVOLVIDO INTEGER,
      :ORDEM -- ORDEM_ENVOLVIDO SMALLINT
    );


    UPDATE VENDA_PAG SET
      CANCELADO = TRUE
      , CANCELADO_EM = :CANCELADO_EM
    WHERE
      LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID
      AND ORDEM = :ORDEM
      ;
    
    UPDATE EST_MOV SET 
      ALTERADO_EM = :CANCELADO_EM
    WHERE
      LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = :TERMINAL_ID
      AND EST_MOV_ID = :EST_MOV_ID
      ;

    SUSPEND;
  END

  PROCEDURE VENDA_PAG_INSERIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , TERMINAL_ID ID_SHORT_DOM NOT NULL
    , EST_MOV_ID BIGINT NOT NULL
    , ORDEM SMALLINT NOT NULL

    , PAGAMENTO_FORMA_ID ID_DOM NOT NULL
    , VALOR_DEVIDO DINH_DOM NOT NULL
    , VALOR_ENTREGUE DINH_DOM NOT NULL
    , TROCO DINH_DOM NOT NULL
  
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    --, MODULO_SIS_ID ID_CHAR_DOM NOT NULL
  )
  AS
    -- VENDA_PAG_INS_PA VENDA_PAG_INSERIR LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 19; -- VENDA_PAG
    --DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- CONFIG
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- RETAGUARDA
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '#'; -- PDV
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%'; -- INSERIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      :TERMINAL_ID, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :EST_MOV_ID, -- ID_ENVOLVIDO INTEGER,
      :ORDEM -- ORDEM_ENVOLVIDO SMALLINT
    );

    INSERT INTO VENDA_PAG(
      LOJA_ID,
      TERMINAL_ID,
      EST_MOV_ID,
      ORDEM,
      PAGAMENTO_FORMA_ID,
      VALOR_DEVIDO,
      VALOR_ENTREGUE,
      TROCO,
      CANCELADO
    ) VALUES (
      :LOJA_ID,
      :TERMINAL_ID,
      :EST_MOV_ID,
      :ORDEM,
      :PAGAMENTO_FORMA_ID,
      :VALOR_DEVIDO,
      :VALOR_ENTREGUE,
      :TROCO,
      FALSE
    );
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
