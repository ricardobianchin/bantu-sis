DESPESA_TIPO_PA

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;

SHOW PACKAGE DESPESA_TIPO_PA;

DROP PACKAGE DESPESA_TIPO_PA;
DELETE FROM DBUPDATE_HIST WHERE NUM>=105;
COMMIT;


//INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_PONTO_ALVO=SERVIDOR
DBATUALIZ_ASSUNTO=FINANCEIRO, DESPESAS, CAIXA
DBATUALIZ_OBJETIVO=CRIA DESPESA_TIPO_PA
DBATUALIZ_OBS=



COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_DESCR=DESPESA_TIPO_PA

```FIREBIRD
/*
"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\App\Bantu\bantu-sis\src\externos\DBUpdates Complementos\Complementos\Retag\Fin\despesa_tipo_pa.sql"

in "C:\Pr\App\Bantu\bantu-sis\src\externos\DBUpdates Complementos\Complementos\Retag\Fin\despesa_tipo_pa.sql";
*/

SET TERM ^;

CREATE OR ALTER PACKAGE DESPESA_TIPO_PA
AS
BEGIN
  PROCEDURE LISTA_GET
  (
    DESCR_BUSCA NOME_REDU_DOM NOT NULL
  )
  RETURNS
  (
    DESPESA_TIPO_ID SMALLINT,
    DESCR NOME_REDU_DOM
  );  

  PROCEDURE BYID_GET
  (
    DESPESA_TIPO_ID ID_SHORT_DOM NOT NULL
  )
  RETURNS
  (
    DESCR NOME_REDU_DOM
  );

  PROCEDURE GARANTIR
  (
    DESPESA_TIPO_ID ID_SHORT_DOM NOT NULL
    , DESCR NOME_REDU_DOM NOT NULL
    , LOJA_ID SMALLINT NOT NULL
    , LOG_PESSOA_ID ID_SHORT_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  )
  RETURNS
  (
    ID_GRAVADO SMALLINT
  );


  PROCEDURE BYDESCR_GET
  (
    DESCR NOME_REDU_DOM
  )
  RETURNS
  (
    DESPESA_TIPO_ID SMALLINT
  );
END^

---- BODY

RECREATE PACKAGE BODY DESPESA_TIPO_PA
AS
BEGIN
  PROCEDURE LISTA_GET
  (
    DESCR_BUSCA NOME_REDU_DOM NOT NULL
  )
  RETURNS
  (
    DESPESA_TIPO_ID SMALLINT,
    DESCR NOME_REDU_DOM
  )
  AS 
  BEGIN 
    IF (TRIM(DESCR_BUSCA) = '') THEN 
    BEGIN
      FOR
        SELECT D.DESPESA_TIPO_ID, D.DESCR
        FROM DESPESA_TIPO D
      INTO :DESPESA_TIPO_ID, :DESCR
      DO SUSPEND;
    END
    ELSE 
    BEGIN
      FOR
        SELECT D.DESPESA_TIPO_ID, D.DESCR
        FROM DESPESA_TIPO D 
        WHERE D.DESCR LIKE '%'||:DESCR_BUSCA||'%'
      INTO :DESPESA_TIPO_ID, :DESCR
      DO SUSPEND;
    END
  END

  PROCEDURE BYID_GET
  (
    DESPESA_TIPO_ID ID_SHORT_DOM NOT NULL
  )
  RETURNS
  (
    DESCR NOME_REDU_DOM
  )
  AS  
  BEGIN  
    SELECT FIRST(1) D.DESCR
    FROM DESPESA_TIPO D WHERE D.DESPESA_TIPO_ID = :DESPESA_TIPO_ID
    INTO :DESCR;  
    SUSPEND;
  END

  PROCEDURE GARANTIR
  (
    DESPESA_TIPO_ID ID_SHORT_DOM NOT NULL
    , DESCR NOME_REDU_DOM NOT NULL
    , LOJA_ID SMALLINT NOT NULL
    , LOG_PESSOA_ID ID_SHORT_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  )
  RETURNS
  (
    ID_GRAVADO SMALLINT
  )
  AS
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 16; -- FEATURE DESPESA_TIPO

    DECLARE LOG_ID BIGINT;
    
  BEGIN
    IF (DESPESA_TIPO_ID < 1) THEN
    BEGIN
      ID_GRAVADO = NEXT VALUE FOR DESPESA_TIPO_SEQ;
    END
    ELSE
    BEGIN
      ID_GRAVADO = DESPESA_TIPO_ID;
    END	
	
    UPDATE OR INSERT INTO DESPESA_TIPO (DESPESA_TIPO_ID, DESCR)
    VALUES (:ID_GRAVADO, :DESCR)
    MATCHING (DESPESA_TIPO_ID);

    SELECT LOG_ID_RET 
    FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      0,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      0,
      :LOG_ID,
      0,
      
      :LOJA_ID, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      :ID_GRAVADO, -- ID_ENVOLVIDO INTEGER,
      0 -- ORDEM_ENVOLVIDO SMALLINT
    );    

    SUSPEND;
  END

  PROCEDURE BYDESCR_GET
  (
    DESCR NOME_REDU_DOM
  )
  RETURNS
  (
    DESPESA_TIPO_ID SMALLINT
  )
  AS
  BEGIN
    SELECT FIRST(1) DESPESA_TIPO_ID
    FROM DESPESA_TIPO
    WHERE DESCR = :DESCR
    INTO :DESPESA_TIPO_ID;
    SUSPEND;
  END  
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
