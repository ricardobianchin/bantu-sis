MACHINE
MAQUINA, NOME DA MAQUINA NA REDE

//INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=MACHINE
DBATUALIZ_OBJETIVO=CRIA MACHINE
DBATUALIZ_OBS=


/////////////////////////
// SEQUENCE MACHINE_SEQ
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE SEQUENCE
OBJETO_NOME=MACHINE_SEQ
//VALOR_INICIAL=0
COMANDO FIM
// SEQUENCE MACHINE_SEQ FIM



/////////////////////////
//
// TABELA MACHINE
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE TABLE
OBJETO_NOME=MACHINE

COLUNAS INI
//NOME;TIPO;NOT NULL;PRIM;UNIQUE

MACHINE_ID;ID_SHORT_DOM;S;S;N
IDENT;NOME_CURTO_DOM;S;N;N
COLUNAS FIM
COMANDO FIM




// PACKAGE MACHINE_PA
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=MACHINE_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE MACHINE_PA
AS
BEGIN
  PROCEDURE BYIDENT_GET
  (
    IDENT VARCHAR(15) NOT NULL
  )
  RETURNS
  (
    MACHINE_ID_RET ID_SHORT_DOM
  );

  PROCEDURE BYIDENTS_GET
  (
    IDENT_SERVER VARCHAR(15) NOT NULL
    , IDENT_TERMINAL VARCHAR(15) NOT NULL
  ) 
  RETURNS 
  (
    MACHINE_ID_SERVER_RET ID_SHORT_DOM
    , MACHINE_ID_TERMINAL_RET ID_SHORT_DOM
  );
END^

RECREATE PACKAGE BODY MACHINE_PA
AS
BEGIN
  PROCEDURE BYIDENT_GET(IDENT VARCHAR(15) NOT NULL) RETURNS (MACHINE_ID_RET ID_SHORT_DOM)
  AS
  BEGIN
    SELECT MACHINE_ID FROM MACHINE WHERE IDENT = :IDENT INTO :MACHINE_ID_RET;
    
    IF (:MACHINE_ID_RET IS NULL) THEN
    BEGIN
      MACHINE_ID_RET = NEXT VALUE FOR MACHINE_SEQ;

      INSERT INTO MACHINE(MACHINE_ID, IDENT) VALUES (:MACHINE_ID_RET, :IDENT);
    END
    
    SUSPEND;
  END

  PROCEDURE BYIDENTS_GET
  (
    IDENT_SERVER VARCHAR(15) NOT NULL
    , IDENT_TERMINAL VARCHAR(15) NOT NULL
  ) 
  RETURNS 
  (
    MACHINE_ID_SERVER_RET ID_SHORT_DOM
    , MACHINE_ID_TERMINAL_RET ID_SHORT_DOM
  )
  AS
  BEGIN
    EXECUTE PROCEDURE BYIDENT_GET(:IDENT_SERVER) RETURNING_VALUES (:MACHINE_ID_SERVER_RET);
    
    IF (:MACHINE_ID_SERVER_RET IS NULL) THEN
    BEGIN
      EXCEPTION;
      -- Pode-se adicionar um tratamento de excecao personalizado aqui
    END

    EXECUTE PROCEDURE BYIDENT_GET(:IDENT_TERMINAL) RETURNING_VALUES (:MACHINE_ID_TERMINAL_RET);
    
    IF (:MACHINE_ID_TERMINAL_RET IS NULL) THEN
    BEGIN
      EXCEPTION;
      -- Pode-se adicionar um tratamento de excecao personalizado aqui
    END

    SUSPEND;
  END
END^
SET TERM ;^
```

COMANDO FIM

DBATUALIZ FIM
