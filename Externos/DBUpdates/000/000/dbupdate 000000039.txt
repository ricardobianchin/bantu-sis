USUARIO

DELETE FROM DBUPDATE_HIST WHERE NUM >=39;
COMMIT;

SELECT MAX(NUM) FROM DBUPDATE_HIST;



EXECUTE PROCEDURE LOG_PA.LOG_INSERIR
    (
      :LOJA_ID
      , 0 -- RETAGUARDA_TERMINAL_ID
      , :LOG_PESSOA_ID
      , '"' -- MODULO RETAGUARDA
      , '''' -- 39 ACAO_SIS_ID GARANTIR
      , 4 -- FEATURE_SIS_ID USUARIO
      , :MACHINE_ID
      , NULL -- LOG_ORDEM SMALLINT
      , NULL -- ENVOLVIDO_LOJA_ID ID_SHORT_DOM
      , NULL --ENVOLVIDO_TERMINAL_ID ID_SHORT_DOM
      , :PESSOA_ID_RET -- ENVOLVIDO_ID INTEGER
      , NULL -- ENVOLVDO_ORDEM SMALLINT
    ) RETURNING_VALUES :LOG_ID_RET;

select log_id_ret from LOG_PA.LOG_INSERIR (
  1, 0, 2, '"', '''', 4, 1, 0, null, null, 1, null
  );

select * from LOG_ENVOLVE_ID;




SELECT PESSOA_ID_RET FROM USUARIO_PA.GARANTIR_NOMES(1, 'SUPORTE TECNICO', 'SUP', '2BD52D823201', 1, 'SUPORTE', NULL, 0, 1);

EXECUTE PROCEDURE USUARIO_PA.USUARIO_TEM_PERFIL_DE_USO_GARANTIR(1, 1, 1, 0, 1);




select nome, apelido from pessoa;

select nome_de_usuario from usuario;

select * from funcionario;

select * from LOG;

select * from LOG_ENVOLVE_ID;


rollback;

      :LOJA_ID
      , 0 -- RETAGUARDA_TERMINAL_ID
      , :LOG_PESSOA_ID
      , '"' -- MODULO RETAGUARDA
      , '''' -- 39 ACAO_SIS_ID GARANTIR
      , 4 -- FEATURE_SIS_ID USUARIO
      , :MACHINE_ID
      , NULL -- LOG_ORDEM SMALLINT
      , NULL -- ENVOLVIDO_LOJA_ID ID_SHORT_DOM
      , NULL --ENVOLVIDO_TERMINAL_ID ID_SHORT_DOM
      , :PESSOA_ID_RET -- ENVOLVIDO_ID INTEGER
      , NULL -- ENVOLVDO_ORDEM SMALLINT
    ) RETURNING_VALUES :LOG_ID_RET;    

FEADURE
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\000\dbupdate 000000032.txt


//INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=USUARIOS
DBATUALIZ_OBJETIVO=CRIA USUARIO_PA
DBATUALIZ_OBS=




//////////////////////////////////
//
// PACKAGE USUARIO_PA
//
//////////////////////////////////

/*

C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\usuario_pa.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\usuario_pa.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\usuario_pa.sql";
in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\usuario_pa_teste.sql";

*/

COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=USUARIO_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE USUARIO_PA
AS
BEGIN
  {SE ALVO=SERVIDOR}
  -- USUARIO_PA.GARANTIR_NOMES DEF
  PROCEDURE GARANTIR_NOMES
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    NOME NOME_DOM NOT NULL,
    NOME_DE_USUARIO NOME_REDU_DOM NOT NULL,
    SENHA SENHA_DOM NOT NULL,
    CRY_VER ID_SHORT_DOM NOT NULL,
    APELIDO NOME_REDU_DOM NOT NULL,
    USUARIO_PESSOA_ID ID_DOM,

    LOG_PESSOA_ID ID_DOM,
    MACHINE_ID ID_SHORT_DOM
  )
  RETURNS
  (
    PESSOA_ID_RET INTEGER 
  );

  -- USUARIO_PA.GARANTIR DEF
  PROCEDURE GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    NOME VARCHAR(60),
    NOME_FANTASIA VARCHAR(60),
    APELIDO VARCHAR(20),
    GENERO_ID CHAR(1),
    ESTADO_CIVIL_ID CHAR(1),
    C VARCHAR(15),
    I VARCHAR(15),
    M VARCHAR(15),
    M_UF CHAR(2),
    EMAIL VARCHAR(50),
    DT_NASC DATE,
    ATIVO BOOLEAN,
    PESSOA_ID ID_DOM,

    LOGRADOURO        VARCHAR(70),
    NUMERO            NOME_DOM,
    COMPLEMENTO       NOME_DOM,
    BAIRRO            NOME_DOM,
    UF_SIGLA          CHAR(2),
    CEP               CHAR(8),
    MUNICIPIO_IBGE_ID CHAR(7),
    DDD               CHAR(2),
    FONE1             NOME_CURTO_DOM,
    FONE2             NOME_CURTO_DOM,
    FONE3             NOME_CURTO_DOM,
    CONTATO           NOME_DOM,
    REFERENCIA        OBS1_DOM,
    
    NOME_DE_USUARIO NOME_REDU_DOM,
    SENHA SENHA_DOM,
    CRY_VER ID_SHORT_DOM,
    LOG_PESSOA_ID ID_DOM,
    MACHINE_ID ID_SHORT_DOM
  )
  RETURNS
  (
    PESSOA_ID_RET ID_DOM
  );

  PROCEDURE TRAGA_OPCOES_DOS_PERFIS_DO_USUARIO
  (
    USUARIO_LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  );

  PROCEDURE USUARIO_TEM_PERFIL_DE_USO_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , PERFIL_DE_USO_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  );

  PROCEDURE TEM_PERFIS_GARANTIR
  (
      LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , STR_PERFIS_ID VARCHAR(15000) NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  );
  
  PROCEDURE PODE_OPCOES_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , STR_OPCOES_ID VARCHAR(15000) NOT NULL
  );

  PROCEDURE SENHA_SET (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    
    , SENHA SENHA_DOM NOT NULL
    , CRY_VER ID_SHORT_DOM NOT NULL
  );
  
  {FIMSE}  

  PROCEDURE BY_NOME_DE_USUARIO_GET 
  (
    NOME_DE_USUARIO NOME_REDU_DOM NOT NULL
  )
  RETURNS 
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    NOME NOME_DOM,
    APELIDO NOME_REDU_DOM,
    SENHA_ZERADA BOOLEAN
  );

  PROCEDURE USUARIO_PODE_OPCAO_SIS_GET 
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    PESSOA_ID ID_DOM NOT NULL,
    OPCAO_SIS_ID ID_DOM NOT NULL
  )
  RETURNS 
  (
    ACESSA BOOLEAN
  );
  
  PROCEDURE LOGIN_VALID_GET 
  (
    LOJA_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    
    NOME_DE_USUARIO NOME_REDU_DOM,
    OPCAO_SIS_ID_MODULO_TENTANDO INTEGER
  )
  RETURNS 
  (
    NOME_DE_USUARIO_OK BOOLEAN,
    CRY_VER ID_SHORT_DOM,
    SENHA SENHA_DOM,
    OPCAO_SIS_ID_MODULO_PODE BOOLEAN
  );

END^

/*

  -------- BODY
  
*/

RECREATE PACKAGE BODY USUARIO_PA
AS
BEGIN
  {SE ALVO=SERVIDOR}
  -- USUARIO_PA.GARANTIR_NOMES IMP
  PROCEDURE GARANTIR_NOMES
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    NOME NOME_DOM NOT NULL,
    NOME_DE_USUARIO NOME_REDU_DOM NOT NULL,
    SENHA SENHA_DOM NOT NULL,
    CRY_VER ID_SHORT_DOM NOT NULL,
    APELIDO NOME_REDU_DOM NOT NULL,
    USUARIO_PESSOA_ID ID_DOM,

    LOG_PESSOA_ID ID_DOM,
    MACHINE_ID ID_SHORT_DOM
  )
  RETURNS
  (
    PESSOA_ID_RET INTEGER 
  )
  AS
    -- USUARIO GAR NOMES LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 4; -- USUARIO
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- TERMINAL RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- MODULO CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    -- USUARIO_PA.GARANTIR_NOMES COD
    EXECUTE PROCEDURE FUNCIONARIO_PA.GARANTIR_NOMES(:LOJA_ID, :NOME, :APELIDO,
      :LOG_PESSOA_ID, :MACHINE_ID, :USUARIO_PESSOA_ID)
    RETURNING_VALUES :PESSOA_ID_RET;

    UPDATE OR INSERT INTO USUARIO (LOJA_ID, TERMINAL_ID, PESSOA_ID,
    NOME_DE_USUARIO, SENHA, CRY_VER)
    VALUES (:LOJA_ID, 0, :PESSOA_ID_RET, :NOME_DE_USUARIO, :SENHA, :CRY_VER)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID);
    
    SUSPEND; -- RETORNA O VALOR DE PESSOA_ID_RET

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PESSOA_ID_RET, -- ID_ENVOLVIDO INTEGER,
      NULL -- ORDEM_ENVOLVIDO SMALLINT
    );
  END

  -- USUARIO_PA.GARANTIR IMP
  PROCEDURE GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    NOME VARCHAR(60),
    NOME_FANTASIA VARCHAR(60),
    APELIDO VARCHAR(20),
    GENERO_ID CHAR(1),
    ESTADO_CIVIL_ID CHAR(1),
    C VARCHAR(15),
    I VARCHAR(15),
    M VARCHAR(15),
    M_UF CHAR(2),
    EMAIL VARCHAR(50),
    DT_NASC DATE,
    ATIVO BOOLEAN,
    PESSOA_ID ID_DOM,

    LOGRADOURO        VARCHAR(70),
    NUMERO            NOME_DOM,
    COMPLEMENTO       NOME_DOM,
    BAIRRO            NOME_DOM,
    UF_SIGLA          CHAR(2),
    CEP               CHAR(8),
    MUNICIPIO_IBGE_ID CHAR(7),
    DDD               CHAR(2),
    FONE1             NOME_CURTO_DOM,
    FONE2             NOME_CURTO_DOM,
    FONE3             NOME_CURTO_DOM,
    CONTATO           NOME_DOM,
    REFERENCIA        OBS1_DOM,
    
    NOME_DE_USUARIO NOME_REDU_DOM,
    SENHA SENHA_DOM,
    CRY_VER ID_SHORT_DOM,
    LOG_PESSOA_ID ID_DOM,
    MACHINE_ID ID_SHORT_DOM
  )
  RETURNS
  (
    PESSOA_ID_RET ID_DOM
  )
  AS
    -- USUARIO GAR LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 4; -- USUARIO
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- TERMINAL RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- MODULO CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    -- USUARIO_PA.GARANTIR COD
    EXECUTE PROCEDURE FUNCIONARIO_PA.GARANTIR(
      :LOJA_ID,
      :NOME,
      :APELIDO,
      :NOME_FANTASIA,
      :GENERO_ID,
      :ESTADO_CIVIL_ID,
      :C,
      :I,
      :M,
      :M_UF,
      :EMAIL,
      :DT_NASC,
      :ATIVO,
      :LOGRADOURO,
      :NUMERO,
      :COMPLEMENTO,
      :BAIRRO,
      :UF_SIGLA,
      :CEP,
      :MUNICIPIO_IBGE_ID,
      :DDD,
      :FONE1,
      :FONE2,
      :FONE3,
      :CONTATO,
      :REFERENCIA,
      :LOG_PESSOA_ID,
      :MACHINE_ID,
      :PESSOA_ID
    )
    RETURNING_VALUES :PESSOA_ID_RET;

    UPDATE OR INSERT INTO USUARIO (LOJA_ID, TERMINAL_ID, PESSOA_ID, NOME_DE_USUARIO, SENHA, CRY_VER)
    VALUES (:LOJA_ID, 0, :PESSOA_ID_RET, :NOME_DE_USUARIO, :SENHA, :CRY_VER)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID);

    SUSPEND; -- RETORNA O VALOR DE PESSOA_ID_RET

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PESSOA_ID_RET, -- ID_ENVOLVIDO INTEGER,
      NULL -- ORDEM_ENVOLVIDO SMALLINT
    );
  END

  PROCEDURE TRAGA_OPCOES_DOS_PERFIS_DO_USUARIO
  (
    USUARIO_LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  )
  AS
    DECLARE VARIABLE OPCAO_SIS_ID ID_DOM;

    -- USUARIO TRAGA_OPCOES_DOS_PERFIS_DO_USUARIO USUARIO_PODE_OPCAO_SIS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 5; -- USUARIO_PODE_OPCAO_SIS
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- TERMINAL RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- MODULO CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    DELETE FROM USUARIO_PODE_OPCAO_SIS
    WHERE LOJA_ID = :USUARIO_LOJA_ID
    AND TERMINAL_ID = 0
    AND PESSOA_ID = :USUARIO_PESSOA_ID;
    
    FOR
      SELECT DISTINCT O.OPCAO_SIS_ID

      FROM PERFIL_DE_USO_PODE_OPCAO_SIS O

      JOIN USUARIO_TEM_PERFIL_DE_USO U
      ON O.PERFIL_DE_USO_ID = U.PERFIL_DE_USO_ID

      WHERE U.LOJA_ID = :USUARIO_LOJA_ID
        AND U.TERMINAL_ID = 0
        AND U.PESSOA_ID = :USUARIO_PESSOA_ID

    INTO :OPCAO_SIS_ID
    DO
    BEGIN
      INSERT INTO USUARIO_PODE_OPCAO_SIS
      (LOJA_ID, TERMINAL_ID, PESSOA_ID, OPCAO_SIS_ID)
      VALUES (:USUARIO_LOJA_ID, 0, :USUARIO_PESSOA_ID, :OPCAO_SIS_ID);
    END
  
    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :USUARIO_LOJA_IDLOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :USUARIO_LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PESSOA_ID_RET, -- ID_ENVOLVIDO INTEGER,
      NULL -- ORDEM_ENVOLVIDO SMALLINT
    );
  END
  
  PROCEDURE USUARIO_TEM_PERFIL_DE_USO_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , PERFIL_DE_USO_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  )
  AS
    -- USUARIO USUARIO_TEM_PERFIL_DE_USO_GARANTIR USUARIO_PODE_OPCAO_SIS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 5; -- USUARIO_PODE_OPCAO_SIS
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- TERMINAL RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- MODULO CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    UPDATE OR INSERT INTO USUARIO_TEM_PERFIL_DE_USO (LOJA_ID, TERMINAL_ID, PESSOA_ID, PERFIL_DE_USO_ID)
    VALUES (:LOJA_ID, 0, :USUARIO_PESSOA_ID, :PERFIL_DE_USO_ID)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID, PERFIL_DE_USO_ID);

    EXECUTE PROCEDURE TRAGA_OPCOES_DOS_PERFIS_DO_USUARIO (:LOJA_ID,
      :USUARIO_PESSOA_ID, :LOG_PESSOA_ID, :MACHINE_ID);

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PESSOA_ID_RET, -- ID_ENVOLVIDO INTEGER,
      NULL -- ORDEM_ENVOLVIDO SMALLINT
    );
END

  PROCEDURE TEM_PERFIS_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , STR_PERFIS_ID VARCHAR(15000) NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
  )
  AS
    DECLARE VARIABLE PERFIL_DE_USO_ID_STR CHAR(11);
    DECLARE VARIABLE PERFIL_DE_USO_ID ID_DOM;
    DECLARE VARIABLE POSICAO INTEGER;
  BEGIN
    DELETE FROM USUARIO_TEM_PERFIL_DE_USO
    WHERE LOJA_ID = :LOJA_ID
    AND TERMINAL_ID = 0
    AND PESSOA_ID = :USUARIO_PESSOA_ID;
    
    WHILE (STR_PERFIS_ID <> '') DO
    BEGIN
      POSICAO = POSITION(';' IN STR_PERFIS_ID);
      
      IF (POSICAO = 0) THEN
      BEGIN
        PERFIL_DE_USO_ID_STR = TRIM(STR_PERFIS_ID);
        STR_PERFIS_ID = '';
      END
      ELSE
      BEGIN
        PERFIL_DE_USO_ID_STR = TRIM(SUBSTRING(STR_PERFIS_ID FROM 1 FOR POSICAO - 1));
        STR_PERFIS_ID = SUBSTRING(STR_PERFIS_ID FROM POSICAO + 1);
      END
      
      IF (PERFIL_DE_USO_ID_STR <> '') THEN
      BEGIN
        PERFIL_DE_USO_ID = CAST(PERFIL_DE_USO_ID_STR AS ID_DOM);
        
        INSERT INTO USUARIO_TEM_PERFIL_DE_USO
        (LOJA_ID, TERMINAL_ID, PESSOA_ID, PERFIL_DE_USO_ID) 
        VALUES (:LOJA_ID, 0, :USUARIO_PESSOA_ID, :PERFIL_DE_USO_ID);
      END
    END
    EXECUTE PROCEDURE TRAGA_OPCOES_DOS_PERFIS_DO_USUARIO (:LOJA_ID,
      :USUARIO_PESSOA_ID, :LOG_PESSOA_ID, :MACHINE_ID);
  END
  
  PROCEDURE PODE_OPCOES_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    , STR_OPCOES_ID VARCHAR(15000) NOT NULL
  )
  AS
    DECLARE VARIABLE OPCAO_SIS_ID_STR CHAR(11);
    DECLARE VARIABLE OPCAO_SIS_ID ID_DOM;
    DECLARE VARIABLE POSICAO ID_DOM;

    -- USUARIO PODE_OPCOES_GARANTIR USUARIO_PODE_OPCAO_SIS LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 5; -- USUARIO_PODE_OPCAO_SIS
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- TERMINAL RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- MODULO CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    DELETE FROM USUARIO_PODE_OPCAO_SIS 
    WHERE LOJA_ID = :LOJA_ID
    AND TERMINAL_ID = 0
    AND PESSOA_ID = :USUARIO_PESSOA_ID;

    WHILE (STR_OPCOES_ID <> '') DO
    BEGIN
      POSICAO = POSITION(';' IN STR_OPCOES_ID);
      
      IF (POSICAO = 0) THEN
      BEGIN
        OPCAO_SIS_ID_STR = TRIM(STR_OPCOES_ID);
        STR_OPCOES_ID = '';
      END
      ELSE
      BEGIN
        OPCAO_SIS_ID_STR = TRIM(SUBSTRING(STR_OPCOES_ID FROM 1 FOR POSICAO - 1));
        STR_OPCOES_ID = SUBSTRING(STR_OPCOES_ID FROM POSICAO + 1);
      END
      
      IF (OPCAO_SIS_ID_STR <> '') THEN
      BEGIN
        OPCAO_SIS_ID = CAST(OPCAO_SIS_ID_STR AS ID_DOM);
        
        INSERT INTO USUARIO_PODE_OPCAO_SIS (LOJA_ID, TERMINAL_ID, PESSOA_ID, OPCAO_SIS_ID) 
        VALUES(:LOJA_ID, 0, :USUARIO_PESSOA_ID, :OPCAO_SIS_ID);
      END
    END
  
    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PESSOA_ID_RET, -- ID_ENVOLVIDO INTEGER,
      NULL -- ORDEM_ENVOLVIDO SMALLINT
    );
  END

  PROCEDURE SENHA_SET
  (
    LOJA_ID ID_SHORT_DOM NOT NULL
    , USUARIO_PESSOA_ID ID_DOM NOT NULL
    , LOG_PESSOA_ID ID_DOM NOT NULL
    , MACHINE_ID ID_SHORT_DOM NOT NULL
    
    , SENHA SENHA_DOM NOT NULL
    , CRY_VER ID_SHORT_DOM NOT NULL
  )
  AS
    -- USUARIO SENHA_SET LOGVAR LOGVARS VARS LOG VAR LOG VARLOG VARSLOG
    DECLARE FEATURE_SIS_ID ID_SHORT_DOM = 4; -- USUARIO
    DECLARE TERMINAL_ID ID_SHORT_DOM = 0; -- TERMINAL RETAGUARDA
    --DECLARE MODULO_SIS_ID ID_CHAR_DOM = '!'; -- MODULO CONFIG
    DECLARE MODULO_SIS_ID ID_CHAR_DOM = '"'; -- MODULO RETAGUARDA
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = ''''; -- GARANTIR
    DECLARE LOG_ID_RET BIGINT;
  BEGIN
    UPDATE USUARIO SET
      SENHA = :SENHA,
      CRY_VER = :CRY_VER
    WHERE LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = 0
      AND PESSOA_ID = :USUARIO_PESSOA_ID;

    SELECT LOG_ID_RET FROM LOG_PA.LOG_NOVO_GET
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_PESSOA_ID,
      :MODULO_SIS_ID,
      :ACAO_SIS_ID,
      :FEATURE_SIS_ID,
      :MACHINE_ID
    ) INTO :LOG_ID_RET;

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :LOJA_ID,
      :TERMINAL_ID,
      :LOG_ID_RET,
      0, -- LOG_ORDEM

      NULL, -- LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, -- TERMINAL_ID_ENVOLVIDO SMALLINT,
      PESSOA_ID_RET, -- ID_ENVOLVIDO INTEGER,
      NULL -- ORDEM_ENVOLVIDO SMALLINT
    );
  END

  {FIMSE}
  
  PROCEDURE LOGIN_VALID_GET
  (
    LOJA_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    
    NOME_DE_USUARIO NOME_REDU_DOM,
    OPCAO_SIS_ID_MODULO_TENTANDO INTEGER
  )
  RETURNS 
  (
    NOME_DE_USUARIO_OK BOOLEAN,
    CRY_VER ID_SHORT_DOM,
    SENHA SENHA_DOM,
    OPCAO_SIS_ID_MODULO_PODE BOOLEAN
  )
  AS
    DECLARE VARIABLE OPCAO_SIS_ID_EXISTE INTEGER;
  BEGIN
    SELECT 
      (NOME_DE_USUARIO = NOME_DE_USUARIO) NOME_OK
      , CRY_VER
      , SENHA
    FROM USUARIO
    WHERE 
      LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = 0
      AND PESSOA_ID = :PESSOA_ID
    INTO 
      :NOME_DE_USUARIO_OK
      , :CRY_VER
      , :SENHA;
      
    SELECT 1
    FROM USUARIO_PODE_OPCAO_SIS
    WHERE LOJA_ID = :LOJA_ID
      AND TERMINAL_ID = 0
      AND PESSOA_ID = :PESSOA_ID
      AND OPCAO_SIS_ID = :OPCAO_SIS_ID_MODULO_TENTANDO
    INTO :OPCAO_SIS_ID_EXISTE;

    OPCAO_SIS_ID_MODULO_PODE = COALESCE(OPCAO_SIS_ID_EXISTE = 1, FALSE);

    SUSPEND;
  END

  PROCEDURE BY_NOME_DE_USUARIO_GET
  (
    NOME_DE_USUARIO NOME_REDU_DOM NOT NULL
  )
  RETURNS 
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM,
    NOME NOME_DOM,
    APELIDO NOME_REDU_DOM,
    SENHA_ZERADA BOOLEAN
  )
  AS
  BEGIN
    FOR 
      WITH P AS(   
        SELECT LOJA_ID, TERMINAL_ID, PESSOA_ID, NOME, APELIDO
        FROM PESSOA
        WHERE TERMINAL_ID = 0
      ), U AS (  
        SELECT LOJA_ID, TERMINAL_ID, PESSOA_ID, (SENHA = 'ZERADA') SENHA_ZERADA
        FROM USUARIO
        WHERE NOME_DE_USUARIO = :NOME_DE_USUARIO
      )
      SELECT 
        P.LOJA_ID,
        P.TERMINAL_ID,
        P.PESSOA_ID,
        P.NOME,
        P.APELIDO,
        U.SENHA_ZERADA
      FROM P
      JOIN U ON
        P.LOJA_ID = U.LOJA_ID 
        AND P.TERMINAL_ID = U.TERMINAL_ID 
        AND P.PESSOA_ID = U.PESSOA_ID
    INTO :LOJA_ID, :TERMINAL_ID, :PESSOA_ID, :NOME, :APELIDO, :SENHA_ZERADA
    DO
    BEGIN
      SUSPEND;
    END
  END

  PROCEDURE USUARIO_PODE_OPCAO_SIS_GET 
  (
    LOJA_ID ID_SHORT_DOM NOT NULL,
    PESSOA_ID ID_DOM NOT NULL,
    OPCAO_SIS_ID ID_DOM NOT NULL
  )
  RETURNS 
  (
    ACESSA BOOLEAN
  )
  AS
    DECLARE VARIABLE RESULTADO INTEGER;
  BEGIN
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
    SELECT PESSOA_ID
    FROM USUARIO_PODE_OPCAO_SIS
    WHERE LOJA_ID = :LOJA_ID
    AND TERMINAL_ID = 0
    AND PESSOA_ID = :PESSOA_ID
    AND OPCAO_SIS_ID = :OPCAO_SIS_ID
    ) INTO :RESULTADO;

    :ACESSA = :RESULTADO = 1;
    SUSPEND;
  END
  
END^
SET TERM ;^
```

COMANDO FIM
//PACKAGE USUARIO_PA FIM


DBATUALIZ FIM
