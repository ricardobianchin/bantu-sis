DBUPDATE_HIST
DBUPDATE_PA

-------
feature_sis arquivo
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates\000\000\dbupdate 000000032.txt
-------

VERSAO DO BANCO DE DADOS.

'USA_TABPRECO=N'#13#10'USA_NATU=N'#13#10;

---------------------------------------
TESTES DBUPDATE_HIST
---------------------------------------
DBUPDATE_HIST

TESTES

# versao 000.000.000

## objetivo

versao do banco de dados

cria package DBUPDATE_PA;
cria tabela DBUPDATE_HIST;

## Teste

```SQL

SELECT DBUPDATE_PA.VERSAO_GET() FROM RDB$DATABASE;


SHOW PACKAGE DBUPDATE_PA;

SHOW TABLE DBUPDATE_HIST;
SELECT * FROM DBUPDATE_HIST;

SHOW DOMAIN FRASE_DOM;
SHOW DOMAIN ID_DOM;
SHOW DOMAIN ID_SHORT_DOM;
SHOW DOMAIN NOME_LONGO_DOM;
SHOW DOMAIN NOME_RED_DOM;
SHOW DOMAIN NOME_RED_NOTN_DOM;
SHOW DOMAIN OBS1_DOM;
SHOW DOMAIN PATH_DOM;


SELECT 
    NUM,
    DTH_INS,
    SUBSTRING(ASSUNTO FROM 1 FOR 20) AS ASSUNTO,
    SUBSTRING(OBJETIVO FROM 1 FOR 30) AS OBJETIVO,
    SUBSTRING(OBS FROM 1 FOR 10) AS OBS
FROM 
    DBUPDATE_HIST
ORDER BY NUM;



SELECT FIRST(1)
    NUM,
    DTH_INS,
    SUBSTRING(ASSUNTO FROM 1 FOR 20) AS ASSUNTO,
    SUBSTRING(OBJETIVO FROM 1 FOR 30) AS OBJETIVO,
    SUBSTRING(OBS FROM 1 FOR 10) AS OBS
FROM 
    DBUPDATE_HIST
ORDER BY NUM DESC;

```

## desfazer

```SQL
DROP PACKAGE DBUPDATE_PA;

DROP TABLE DBUPDATE_HIST;

DROP DOMAIN ID_DOM;
DROP DOMAIN ID_SHORT_DOM;
DROP DOMAIN NOME_RED_DOM;
DROP DOMAIN NOME_RED_NOTN_DOM;
DROP DOMAIN NOME_LONGO_DOM;
DROP DOMAIN PATH_DOM;
DROP DOMAIN FRASE_DOM;
DROP DOMAIN OBS1_DOM;

/*
-- ABAIXO EH DESNECESSARIO POIS FOI FEITO DROP DA DBUPDATE_HIST
DELETE FROM DBUPDATE_HIST WHERE NUM>=0;
COMMIT;
*/
```


SHOW DOMAINS;
SHOW TABLE DBUPDATE_HIST;
SELECT * FROM DBUPDATE_HIST;
SHOW PACKAGE DBUPDATE_PA;

DESFAZER
DROP PACKAGHE DBUPDATE_PA;
DROP TABLE DBUPDATE_HIST;

---------------------------------------
FIM TESTES
---------------------------------------

-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=VERSAO DATABASE
DBATUALIZ_OBJETIVO=CRIAR VERSAO DATABASE, DBUPDATE_HIST, PACKAGE DBUPDATE_PA, DOMAINS BASICOS, COMO O ID_DOM
//DBATUALIZ_DESTINO=TERMINAL
DBATUALIZ_OBS=



/////////////////////////
//
// CREATE DOMAINS
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE DOMAINS
```FIREBIRD
CREATE DOMAIN ATIVO_DOM AS BOOLEAN DEFAULT TRUE;
CREATE DOMAIN FRASE_DOM AS VARCHAR(200);
CREATE DOMAIN ID_CHAR_DOM AS CHAR(1);
CREATE DOMAIN ID_DOM AS INTEGER;
CREATE DOMAIN ID_SHORT_DOM AS SMALLINT;
CREATE DOMAIN IPV6_DOM AS CHAR(39);
CREATE DOMAIN NOME_CURTO_DOM AS VARCHAR(15);
CREATE DOMAIN NOME_DOM AS VARCHAR(60);
CREATE DOMAIN NOME_INTERM_DOM AS VARCHAR(40);
CREATE DOMAIN NOME_LONGO_DOM AS VARCHAR(200);
CREATE DOMAIN NOME_REDU_DOM AS VARCHAR(20);
CREATE DOMAIN OBS1_DOM AS VARCHAR(1000);
CREATE DOMAIN PATH_DOM AS VARCHAR(220);
CREATE DOMAIN PERC_DOM AS NUMERIC(5,2);
CREATE DOMAIN SELECIONADO_DOM AS BOOLEAN DEFAULT FALSE;
CREATE DOMAIN SENHA_DOM AS VARCHAR(80);
```
COMANDO FIM



/////////////////////////
//
// TABELA DBUPDATE_HIST
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE TABLE
OBJETO_NOME=DBUPDATE_HIST
COLUNAS INI
//NOME;TIPO;NOT NULL;PRIM

NUM;ID_DOM;N;S
DTH_INS;TIMESTAMP DEFAULT 'NOW'
ASSUNTO;FRASE_DOM;S
OBJETIVO;OBS1_DOM;S
OBS;OBS1_DOM;S

COLUNAS FIM
COMANDO FIM



/////////////////////////
//
// PACKAGE DBUPDATE_PA
//
/////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=DBUPDATE_PA
/*
IN "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Retag\Sis\DBUPDATE_PA.SQL";

*/
```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE DBUPDATE_PA
AS
BEGIN
  FUNCTION VERSAO_GET() RETURNS INTEGER;
  
  PROCEDURE HIST_INS
  (
    NUM ID_DOM NOT NULL
    , ASSUNTO FRASE_DOM NOT NULL
    , OBJETIVO OBS1_DOM NOT NULL
    , OBS OBS1_DOM NOT NULL
  ); 

  PROCEDURE LISTA_GET
  (
    TEXTO_BUSCA VARCHAR(100)
  )
  RETURNS
  (
    NUM Integer
    , DTH_INS TIMESTAMP
    , ASSUNTO VARCHAR(200)
    , OBJETIVO OBS1_DOM
    , OBS VARCHAR(1000)
  );
END^

RECREATE PACKAGE BODY DBUPDATE_PA
AS
BEGIN
  FUNCTION VERSAO_GET() RETURNS INTEGER 
  AS
  DECLARE VARIABLE MAX_NUM INTEGER;
  BEGIN
    SELECT MAX(NUM) FROM DBUPDATE_HIST INTO :MAX_NUM;
    RETURN COALESCE(MAX_NUM, -1);
  END	

  PROCEDURE HIST_INS
  (
    NUM ID_DOM NOT NULL
    , ASSUNTO FRASE_DOM NOT NULL
    , OBJETIVO OBS1_DOM NOT NULL
    , OBS OBS1_DOM NOT NULL
  )
  AS
  BEGIN
    INSERT INTO DBUPDATE_HIST(
      NUM
      , ASSUNTO
      , OBJETIVO
      , OBS
    )VALUES(
      :NUM
      , :ASSUNTO
      , :OBJETIVO
      , :OBS
    );
  END

  PROCEDURE LISTA_GET
  (
    TEXTO_BUSCA VARCHAR(100)
  )
  RETURNS
  (
    NUM Integer
    , DTH_INS TIMESTAMP
    , ASSUNTO VARCHAR(200)
    , OBJETIVO OBS1_DOM
    , OBS VARCHAR(1000)
  )
  AS 
  BEGIN 
    FOR
    SELECT NUM, DTH_INS, ASSUNTO, OBJETIVO, OBS 
    FROM DBUPDATE_HIST
    WHERE (ASSUNTO LIKE '%'||:TEXTO_BUSCA||'%') 
    OR (OBJETIVO LIKE '%'||:TEXTO_BUSCA||'%') 
    OR (OBS LIKE '%'||:TEXTO_BUSCA||'%') 
    OR (:TEXTO_BUSCA = '') 
    INTO :NUM, :DTH_INS, :ASSUNTO, :OBJETIVO, :OBS
    DO
    SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM
