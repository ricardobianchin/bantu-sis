CUSTOS

DBATUALIZ INI
DBATUALIZ_ALVO=SERVIDOR
DBATUALIZ_ASSUNTO=CUSTOS
DBATUALIZ_OBJETIVO=CRIAR TABELAS PARA CUSTO
DBATUALIZ_OBS=




/////////////////////////
//
// TABELA PROD_CUSTO_HIST
//
/////////////////////////

COMANDO INI
COMANDO_TIPO=CREATE TABLE
OBJETO_NOME=PROD_CUSTO_HIST

COLUNAS INI
//NOME;TIPO;NOT NULL;PRIM;UNIQUE

//NOME    TIPO    NOTNULL    PRIM    UNIQUE

PROD_ID;ID_DOM;S;S
LOJA_ID;ID_SHORT_DOM;S;S
TERMINAL_ID;ID_SHORT_DOM;S;S
LOG_ID;BIGINT;S;S

CUSTO;CUSTO_DOM;S

FORNEC_ID;INTEGER

COMPRA_ID;INTEGER
COMPRA_ITEM_ORDEM;SMALLINT

CRIADO_EM;DTH_INS_DOM

COLUNAS FIM
COMANDO FIM
//TABELA PROD_BARRAS FIM


//////////////////////////////////
//
// FOREIGN KEY PROD_CUSTO_HIST PROD
//
//////////////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=PROD_CUSTO_HIST
CAMPOS_FK=PROD_ID
TABELA_PK=PROD
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY PROD_CUSTO_HIST PROD FIM


//////////////////////////////////
//
// FOREIGN KEY PROD_CUSTO_HIST LOG
//
//////////////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=PROD_CUSTO_HIST
CAMPOS_FK=LOJA_ID,TERMINAL_ID,LOG_ID
TABELA_PK=LOG
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY PROD_CUSTO_HIST PROD FIM






/////////////////////////
//
// TABELA PROD_CUSTO
//
/////////////////////////

COMANDO INI
COMANDO_TIPO=CREATE TABLE
OBJETO_NOME=PROD_CUSTO

COLUNAS INI
//NOME;TIPO;NOT NULL;PRIM;UNIQUE

//NOME    TIPO    NOTNULL    PRIM    UNIQUE

PROD_ID;ID_DOM;S;S
LOJA_ID;ID_SHORT_DOM;S
TERMINAL_ID;ID_SHORT_DOM;S
LOG_ID;BIGINT;S

CUSTO;CUSTO_DOM;S

FORNEC_ID;INTEGER

COMPRA_ID;INTEGER
COMPRA_ITEM_ORDEM;SMALLINT

CRIADO_EM;DTH_INS_DOM

COLUNAS FIM
COMANDO FIM
//TABELA PROD_BARRAS FIM


//////////////////////////////////
//
// FOREIGN KEY PROD_CUSTO PROD
//
//////////////////////////////////
COMANDO INI
COMANDO_TIPO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=PROD_CUSTO
CAMPOS_FK=PROD_ID
TABELA_PK=PROD
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY PROD_CUSTO PROD FIM



//PACKAGE PROD_CUSTO_PA

COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=PROD_CUSTO_PA
```FIREBIRD

SET TERM ^;
CREATE OR ALTER PACKAGE PROD_CUSTO_PA
AS
BEGIN
  PROCEDURE PROD_CUSTO_HIST_INS
  (
    P_PROD_ID INTEGER,
    P_LOJA_ID SMALLINT,
    P_PESSOA_ID ID_DOM,
    P_MACHINE_ID ID_SHORT_DOM,
    P_CUSTO CUSTO_DOM,
    P_FORNEC_ID INTEGER,
    P_COMPRA_ID INTEGER,
    P_COMPRA_ITEM_ORDEM SMALLINT
  )
  RETURNS
  (
    LOG_ID_RET BIGINT
  );
END^

RECREATE PACKAGE BODY PROD_CUSTO_PA
AS
BEGIN
  PROCEDURE PROD_CUSTO_HIST_INS
  (
    P_PROD_ID INTEGER,
    P_LOJA_ID SMALLINT,
    P_PESSOA_ID ID_DOM,
    P_MACHINE_ID ID_SHORT_DOM,
    P_CUSTO CUSTO_DOM,
    P_FORNEC_ID INTEGER,
    P_COMPRA_ID INTEGER,
    P_COMPRA_ITEM_ORDEM SMALLINT
  )
  RETURNS
  (
    LOG_ID_RET BIGINT
  )  
  AS
    // VARS LOG VAR LOG VARLOG VARSLOG custo
    DECLARE FEATURE_ID ID_SHORT_DOM = 8;//CUSTO
    DECLARE RETAGUARDA_TERMINAL_ID ID_SHORT_DOM = 0;
    DECLARE RETAGUARDA_MODULO_ID ID_CHAR_DOM = '"';
    DECLARE ACAO_SIS_ID ID_CHAR_DOM = '%';//INSERIR
    DECLARE DTH TIMESTAMP;
  BEGIN
    IF (P_CUSTO = 0) THEN
    BEGIN
      LOG_ID_RET = 0;
      EXIT;
    END

    SELECT LOG_ID_RET, DTH FROM LOG_PA.LOG_NOVO_GET
    (
      :P_LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :P_PESSOA_ID,
      :RETAGUARDA_MODULO_ID,
      :ACAO_SIS_ID,
      :FEATURE_ID,
      :P_MACHINE_ID
    ) INTO :LOG_ID_RET, :DTH;

    INSERT INTO PROD_CUSTO_HIST
    (
      PROD_ID,

      LOJA_ID,
      TERMINAL_ID,
      LOG_ID,

      CUSTO,

      FORNEC_ID,
      COMPRA_ID,
      COMPRA_ITEM_ORDEM,

      CRIADO_EM
    )
    VALUES(
      :P_PROD_ID,

      :P_LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :LOG_ID_RET,

      :P_CUSTO,

      :P_FORNEC_ID,
      :P_COMPRA_ID,
      :P_COMPRA_ITEM_ORDEM,

      :DTH
    );

    UPDATE OR INSERT INTO PROD_CUSTO (PROD_ID, LOJA_ID, TERMINAL_ID, LOG_ID,
      CUSTO, FORNEC_ID, COMPRA_ID, COMPRA_ITEM_ORDEM, CRIADO_EM)
    VALUES (:P_PROD_ID, :P_LOJA_ID, :RETAGUARDA_TERMINAL_ID, :LOG_ID_RET, 
      :P_CUSTO, :P_FORNEC_ID, :P_COMPRA_ID, :P_COMPRA_ITEM_ORDEM, :DTH)
    MATCHING (PROD_ID);  

    EXECUTE PROCEDURE LOG_PA.LOG_ENVOLVE_ID_INS
    (
      :P_LOJA_ID,
      :RETAGUARDA_TERMINAL_ID,
      :LOG_ID_RET,
      0,

      NULL, //LOJA_ID_ENVOLVIDO SMALLINT,
      NULL, //TERMINAL_ID_ENVOLVIDO SMALLINT,
      P_PROD_ID, //ID_ENVOLVIDO INTEGER,
      NULL //ORDEM_ENVOLVIDO SMALLINT
    );
  END
END^
SET TERM ;^

```
COMANDO FIM
//PACKAGE PROD_CUSTO_PA FIM

DBATUALIZ FIM


