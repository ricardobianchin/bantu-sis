ICMS

//INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=ICMS
DBATUALIZ_OBJETIVO=CRIA ICMS
DBATUALIZ_OBS=

/////////////////////////
// SEQUENCE ICMS_SEQ
/////////////////////////
COMANDO INI
TIPO_COMANDO=CREATE SEQUENCE
OBJETO_NOME=ICMS_SEQ
VALOR_INICIAL=9
COMANDO FIM
// SEQUENCE ICMS_SEQ FIM

/////////////////////////
//
// TABELA ICMS
//
/////////////////////////
COMANDO INI
TIPO_COMANDO=CREATE TABLE
OBJETO_NOME=ICMS

COLUNAS INI
//NOME;TIPO;NOT NULL;PRIM;UNIQUE

ICMS_ID;ID_SHORT_DOM;N;S;N
SIGLA;CHAR(1);N;N;N
DESCR;NOME_INTERM_DOM;S;N;N
PERC;NUMERIC(4,2);S;N;N
ATIVO;BOOLEAN;S;N;N
COLUNAS FIM
COMANDO FIM



// PACKAGE ICMS_PA
COMANDO INI
TIPO_COMANDO=CREATE OR ALTER PACKAGE
OBJETO_NOME=ICMS_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE ICMS_PA
AS
BEGIN
  PROCEDURE LISTA_GET
  RETURNS
  (
    ICMS_ID SMALLINT
    , SIGLA CHAR(1)
    , DESCR NOME_INTERM_DOM
    , PERC NUMERIC(4,2)
    , ATIVO BOOLEAN
  );
  PROCEDURE BYID_GET
  (
    ICMS_ID ID_SHORT_DOM 
  )
  RETURNS
  (
    SIGLA CHAR(1)
    , DESCR NOME_INTERM_DOM
    , PERC NUMERIC(4,2)
    , ATIVO BOOLEAN
  );
  PROCEDURE GARANTIR
  (
    ICMS_ID ID_SHORT_DOM 
    , SIGLA CHAR(1) NOT NULL
    , DESCR NOME_INTERM_NOTN_DOM
    , PERC NUMERIC(4,2) NOT NULL
    , ATIVO BOOLEAN NOT NULL
  )
  RETURNS
  (
    ID_GRAVADO SMALLINT
  );

  PROCEDURE BYPERC_GET
  (
    PERC NUMERIC(4,2) NOT NULL
  )
  RETURNS
  (
    ICMS_ID SMALLINT
  );  

  PROCEDURE ATIVO_SET (ICMS_ID ID_SHORT_DOM
    , ATIVO BOOLEAN NOT NULL);
    
END^

RECREATE PACKAGE BODY ICMS_PA
AS
BEGIN
  PROCEDURE LISTA_GET
  RETURNS
  (
    ICMS_ID SMALLINT
    , SIGLA CHAR(1)
    , DESCR NOME_INTERM_DOM
    , PERC NUMERIC(4,2)
    , ATIVO BOOLEAN
  )
  AS 
  BEGIN 
    FOR SELECT I.ICMS_ID, I.SIGLA, I.DESCR, I.PERC, I.ATIVO
    FROM ICMS I INTO :ICMS_ID, :SIGLA, :DESCR, :PERC, :ATIVO 
    DO SUSPEND; 
  END

   PROCEDURE BYID_GET
  (
    ICMS_ID ID_SHORT_DOM 
  )
  RETURNS
  (
    SIGLA CHAR(1)
    , DESCR NOME_INTERM_DOM
    , PERC NUMERIC(4,2)
    , ATIVO BOOLEAN
  )
  AS  
  BEGIN  
    SELECT FIRST(1) SIGLA, DESCR, PERC, ATIVO
    FROM ICMS WHERE ICMS_ID = :ICMS_ID INTO 
    :SIGLA, :DESCR, :PERC, :ATIVO;  
    SUSPEND;
  END
  
  PROCEDURE GARANTIR
  (
    ICMS_ID ID_SHORT_DOM 
    , SIGLA CHAR(1) NOT NULL
    , DESCR NOME_INTERM_NOTN_DOM
    , PERC NUMERIC(4,2) NOT NULL
    , ATIVO BOOLEAN NOT NULL
  )
  RETURNS
  (
    ID_GRAVADO SMALLINT
  )
  AS
  BEGIN
    IF (ICMS_ID < 1) THEN
    BEGIN
      ID_GRAVADO = NEXT VALUE FOR ICMS_SEQ;
  	END
    ELSE
    BEGIN
	    ID_GRAVADO = ICMS_ID;
    END	
	
    UPDATE OR INSERT INTO ICMS (ICMS_ID, SIGLA, DESCR, PERC, ATIVO)
    VALUES (:ID_GRAVADO, :SIGLA, :DESCR, :PERC, :ATIVO)
    MATCHING (ICMS_ID);
    SUSPEND;
  END

  PROCEDURE BYPERC_GET
  (
    PERC NUMERIC(4,2) NOT NULL
  )
  RETURNS
  (
    ICMS_ID SMALLINT
  )
  AS
  BEGIN
    SELECT FIRST(1) ICMS_ID FROM ICMS 
    WHERE PERC = :PERC INTO :ICMS_ID;
    SUSPEND;
  END

  PROCEDURE ATIVO_SET (ICMS_ID ID_SHORT_DOM, ATIVO BOOLEAN NOT NULL)
  AS
  BEGIN
    UPDATE ICMS SET ATIVO = :ATIVO WHERE ICMS_ID = :ICMS_ID;
  END

END^
SET TERM ;^
```
COMANDO FIM

DBATUALIZ FIM


DBATUALIZ FIM
