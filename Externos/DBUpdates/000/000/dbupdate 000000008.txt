USUARIO

//INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=USUARIOS
DBATUALIZ_OBJETIVO=CRIA USUARIO
DBATUALIZ_OBS=

//////////////////////
//
// DOMAINS
//
//////////////////////
COMANDO INI
TIPO_COMANDO=CREATE DOMAINS

```FIREBIRD
CREATE DOMAIN SENHA_DOM AS VARCHAR(80);
```
COMANDO FIM
// DOMAINS FIM



/////////////////////////
//
// TABELA USUARIO
//
/////////////////////////
COMANDO INI

TIPO_COMANDO=CREATE TABLE
OBJETO_NOME=USUARIO
COLUNAS INI
//NOME,TIPO,NOT NULL,PRIM

LOJA_ID,ID_SHORT_DOM,N,S
TERMINAL_ID,ID_SHORT_DOM,N,S
PESSOA_ID,ID_DOM,N,S

NOME_USU,NOME_RED_DOM,N,N,S
SENHA,SENHA_DOM,
CRY_VER,ID_SHORT_DOM
COLUNAS FIM
COMANDO FIM







//////////////////////////////////
//
// FOREIGN KEY USUARIO REF PESSOA
//
//////////////////////////////////
COMANDO INI
TIPO_COMANDO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=USUARIO
CAMPOS_FK=LOJA_ID,TERMINAL_ID,PESSOA_ID
TABELA_PK=PESSOA
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY USUARIO PESSOA FIM



/////////////////////////
//
// TABELA USUARIO_TEM_PERFIL_USO
//
/////////////////////////
COMANDO INI

TIPO_COMANDO=CREATE TABLE
OBJETO_NOME=USUARIO_TEM_PERFIL_USO
COLUNAS INI
//NOME,TIPO,NOT NULL,PRIM

LOJA_ID,ID_SHORT_DOM,N,S
TERMINAL_ID,ID_SHORT_DOM,N,S
PESSOA_ID,ID_DOM,N,S
PERFIL_USO_ID,ID_SHORT_DOM,N,S

COLUNAS FIM
COMANDO FIM


//////////////////////////////////
//
// FOREIGN KEY USUARIO_TEM_PERFIL_USO X USUARIO
//
//////////////////////////////////
COMANDO INI
TIPO_COMANDO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=USUARIO_TEM_PERFIL_USO
CAMPOS_FK=LOJA_ID,TERMINAL_ID,PESSOA_ID
TABELA_PK=USUARIO
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY USUARIO_TEM_PERFIL_USO X USUARIO FIM


COMANDO INI
TIPO_COMANDO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=USUARIO_TEM_PERFIL_USO
CAMPOS_FK=PERFIL_USO_ID
TABELA_PK=PERFIL_USO
//CAMPOS_PK=
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
COMANDO FIM
// FOREIGN KEY USUARIO_TEM_PERFIL_USO X USUARIO FIM







/////////////////////////
//
// TABELA USUARIO_ACESSA_MODULO
//
/////////////////////////
COMANDO INI

TIPO_COMANDO=CREATE TABLE
OBJETO_NOME=USUARIO_ACESSA_MODULO
COLUNAS INI
//NOME,TIPO,NOT NULL,PRIM

LOJA_ID,ID_SHORT_DOM,N,S
TERMINAL_ID,ID_SHORT_DOM,N,S
PESSOA_ID,ID_DOM,N,S
MODULO_ID,ID_CHAR_DOM,N,S

COLUNAS FIM
COMANDO FIM




//////////////////////////////////
//
// FOREIGN KEY USUARIO_ACESSA_MODULO X MODULO
//
//////////////////////////////////
COMANDO INI
TIPO_COMANDO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=USUARIO_ACESSA_MODULO
CAMPOS_FK=MODULO_ID
TABELA_PK=MODULO
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY USUARIO PESSOA FIM







//////////////////////////////////
//
// FOREIGN KEY USUARIO_ACESSA_MODULO X USUARIO
//
//////////////////////////////////
COMANDO INI
TIPO_COMANDO=CREATE FOREIGN KEY
//OBJETO_NOME=
TABELA_FK=USUARIO_ACESSA_MODULO
CAMPOS_FK=LOJA_ID,TERMINAL_ID,PESSOA_ID
TABELA_PK=USUARIO
//CAMPOS_PK=
COMANDO FIM
//OBJETO_NOME e CAMPOS_PK nao sao obrigatorios
// FOREIGN KEY USUARIO PESSOA FIM



//PACKAGE USUARIO_PA

COMANDO INI
TIPO_COMANDO=CREATE OR ALTER PACKAGE
OBJETO_NOME=USUARIO_PA

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE USUARIO_PA
AS
BEGIN
  PROCEDURE USUARIO_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM,
    NOME NOME_DOM,
    NOME_USU NOME_RED_DOM,
    SENHA SENHA_DOM,
    CRY_VER ID_SHORT_DOM,
    APELIDO NOME_RED_DOM,
    PESSOA_ID INTEGER
  )
  RETURNS
  (
    PESSOA_ID_RETORNADA INTEGER 
  );

  PROCEDURE USUARIO_TEM_PERFIL_USO_GARANTIR(
    LOJA_ID ID_SHORT_DOM,
    PESSOA_ID INTEGER,
    PERFIL_USO_ID ID_SHORT_DOM
  );

  PROCEDURE USUARIO_ACESSA_MODULO_GARANTIR(
    LOJA_ID ID_SHORT_DOM,
    PESSOA_ID INTEGER,
    MODULO_ID ID_CHAR_DOM
  );

  PROCEDURE USUARIO_TRAZER_MODULOS (
    LOJA_ID SMALLINT,
    PESSOA_ID INTEGER,
    PERFIL_USO_ID SMALLINT
  );

  PROCEDURE BY_NOME_USU (NOME_USU VARCHAR(20) NOT NULL)
  RETURNS (LOJA_ID SMALLINT, PESSOA_ID INTEGER, NOME VARCHAR(60), APELIDO VARCHAR(20), CRY_VER SMALLINT, SENHA VARCHAR(80));

  PROCEDURE USUARIO_ACESSA_MODULO_GET (
    LOJA_ID SMALLINT,
    PESSOA_ID INTEGER,
    MODULO_ID CHAR(1)
  ) RETURNS (
    ACESSA BOOLEAN
  );

END^

RECREATE PACKAGE BODY USUARIO_PA
AS
BEGIN
  PROCEDURE USUARIO_GARANTIR
  (
    LOJA_ID ID_SHORT_DOM,
    NOME NOME_DOM,
    NOME_USU NOME_RED_DOM,
    SENHA SENHA_DOM,
    CRY_VER ID_SHORT_DOM,
    APELIDO NOME_RED_DOM,
    PESSOA_ID INTEGER
  )
  RETURNS
  (
    PESSOA_ID_RETORNADA INTEGER 
  )
  AS
  BEGIN
    EXECUTE PROCEDURE FUNCIONARIO_PA.FUNCIONARIO_GARANTIR(:LOJA_ID, :NOME, :APELIDO, :PESSOA_ID)
      RETURNING_VALUES :PESSOA_ID_RETORNADA;
    
    UPDATE OR INSERT INTO USUARIO (LOJA_ID, TERMINAL_ID, PESSOA_ID, NOME_USU, SENHA, CRY_VER)
    VALUES (:LOJA_ID, 0, :PESSOA_ID_RETORNADA, :NOME_USU, :SENHA, :CRY_VER)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID);
    
    SUSPEND; -- RETORNA O VALOR DE PESSOA_ID_RETORNADA
  END

  PROCEDURE USUARIO_TEM_PERFIL_USO_GARANTIR(
    LOJA_ID ID_SHORT_DOM,
    PESSOA_ID INTEGER,
    PERFIL_USO_ID ID_SHORT_DOM
  )
  AS
  BEGIN
    UPDATE OR INSERT INTO USUARIO_TEM_PERFIL_USO (LOJA_ID, TERMINAL_ID, PESSOA_ID, PERFIL_USO_ID)
    VALUES (:LOJA_ID, 0, :PESSOA_ID, :PERFIL_USO_ID)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID, PERFIL_USO_ID);

    EXECUTE PROCEDURE USUARIO_TRAZER_MODULOS (LOJA_ID, PESSOA_ID, PERFIL_USO_ID);
  END

  PROCEDURE USUARIO_ACESSA_MODULO_GARANTIR(
    LOJA_ID ID_SHORT_DOM,
    PESSOA_ID INTEGER,
    MODULO_ID ID_CHAR_DOM
  )
  AS
  BEGIN
    UPDATE OR INSERT INTO USUARIO_ACESSA_MODULO (LOJA_ID, TERMINAL_ID, PESSOA_ID, MODULO_ID)
    VALUES (:LOJA_ID, 0, :PESSOA_ID, :MODULO_ID)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID, MODULO_ID);
  END

  PROCEDURE USUARIO_TRAZER_MODULOS (
    LOJA_ID SMALLINT,
    PESSOA_ID INTEGER,
    PERFIL_USO_ID SMALLINT
  )
  AS
  DECLARE VARIABLE MODULO_ID CHAR(1);
  BEGIN
    DELETE FROM USUARIO_ACESSA_MODULO
    WHERE LOJA_ID = :LOJA_ID
    AND TERMINAL_ID = 0
    AND PESSOA_ID = :PESSOA_ID;

    FOR SELECT MODULO_ID
    FROM PERFIL_USO_ACESSA_MODULO
    WHERE PERFIL_USO_ID = :PERFIL_USO_ID
    INTO :MODULO_ID
    DO
    BEGIN
      INSERT INTO USUARIO_ACESSA_MODULO (LOJA_ID, TERMINAL_ID, PESSOA_ID, MODULO_ID)
      VALUES (:LOJA_ID, 0, :PESSOA_ID, :MODULO_ID);
    END
  END

  PROCEDURE BY_NOME_USU (NOME_USU VARCHAR(20) NOT NULL)
  RETURNS (LOJA_ID SMALLINT, PESSOA_ID INTEGER, NOME VARCHAR(60), APELIDO VARCHAR(20), CRY_VER SMALLINT, SENHA VARCHAR(80))
  AS
  BEGIN
    FOR SELECT p.LOJA_ID, p.PESSOA_ID, P.NOME, p.APELIDO, u.CRY_VER, u.SENHA
    FROM pessoa p
    JOIN usuario u ON 
    p.LOJA_ID = u.LOJA_ID 
    AND p.TERMINAL_ID = 0
    AND p.TERMINAL_ID = u.TERMINAL_ID 
    AND p.PESSOA_ID = u.PESSOA_ID
    WHERE u.NOME_USU = :NOME_USU
    INTO :LOJA_ID, :PESSOA_ID, :NOME, :APELIDO, :CRY_VER, :SENHA
    DO
    BEGIN
      SUSPEND;
    END
  END

  PROCEDURE USUARIO_ACESSA_MODULO_GET (
    LOJA_ID SMALLINT,
    PESSOA_ID INTEGER,
    MODULO_ID CHAR(1)
  ) RETURNS (
    ACESSA BOOLEAN
  )
  AS
  DECLARE VARIABLE RESULTADO INTEGER;
  BEGIN
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
    SELECT PESSOA_ID
    FROM USUARIO_ACESSA_MODULO
    WHERE LOJA_ID = :LOJA_ID
    AND TERMINAL_ID = 0
    AND PESSOA_ID = :PESSOA_ID
    AND MODULO_ID = :MODULO_ID
    ) INTO :RESULTADO;

    :ACESSA = :RESULTADO = 1;
    SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM
//PACKAGE USUARIO_PA FIM


DBATUALIZ FIM
