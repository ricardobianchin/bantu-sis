PESSOA

-----------------------------
TESTES INICIO
-----------------------------


SELECT * FROM ;

SHOW PACKAGE PESSOA_PA;

-----------------------------
TESTES FIM 
-----------------------------

-----------------------------
INICIO
-----------------------------
DBATUALIZ INI
DBATUALIZ_ASSUNTO=PESSOA
DBATUALIZ_OBJETIVO=CRIAR PACKAGE PESSOA_PA
DBATUALIZ_OBS=




//PACKAGE PESSOA_PA

COMANDO INI
COMANDO_TIPO=CREATE OR ALTER PACKAGE
OBJETO_NOME=PESSOA_PA

/*
Externos\DBUpdates Complementos\Complementos\Pess\pessoa_pa.sql
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\
C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\pessoa_pa.sql

"C:\Program Files\Notepad++\notepad++.exe" "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\pessoa_pa.sql"

in "C:\Pr\app\bantu\bantu-sis\Src\Externos\DBUpdates Complementos\Complementos\Pess\pessoa_pa.sql";
*/

```FIREBIRD
SET TERM ^;
CREATE OR ALTER PACKAGE PESSOA_PA
AS
BEGIN
  FUNCTION PROXIMO_ID_GET()
  RETURNS INTEGER;

  PROCEDURE GARANTIR_NOMES(
    LOJA_ID ID_SHORT_DOM NOT NULL,
    TERMINAL_ID ID_SHORT_DOM NOT NULL,
    NOME NOME_DOM NOT NULL,
    APELIDO VARCHAR(20) NOT NULL,
    PESSOA_ID INTEGER
  )
  RETURNS
  (
    PESSOA_ID_RET INTEGER 
  );

  PROCEDURE GARANTIR(
    LOJA_ID SMALLINT NOT NULL,
    TERMINAL_ID SMALLINT NOT NULL,
    NOME VARCHAR(60),
    NOME_FANTASIA VARCHAR(60),
    APELIDO VARCHAR(20),
    GENERO_ID CHAR(1),
    ESTADO_CIVIL_ID CHAR(1),
    C VARCHAR(15),
    I VARCHAR(15),
    M VARCHAR(15),
    M_UF CHAR(2),
    EMAIL VARCHAR(50),
    DT_NASC DATE,
    ATIVO             BOOLEAN,
    PESSOA_ID INTEGER,

    LOGRADOURO        VARCHAR(70),
    NUMERO            NOME_DOM,
    COMPLEMENTO       NOME_DOM,
    BAIRRO            NOME_DOM,
    UF_SIGLA          CHAR(2),
    CEP               CHAR(8),
    MUNICIPIO_IBGE_ID CHAR(7),
    DDD               CHAR(2),
    FONE1             NOME_CURTO_DOM,
    FONE2             NOME_CURTO_DOM,
    FONE3             NOME_CURTO_DOM,
    CONTATO           NOME_DOM,
    REFERENCIA        OBS1_DOM
  )
  RETURNS
  (
    PESSOA_ID_RET INTEGER
  );

  PROCEDURE ID_BY_C 
  (
    C VARCHAR(15)
  )
  RETURNS 
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM
  );
END^

/*
  body
*/

RECREATE PACKAGE BODY PESSOA_PA
AS
BEGIN
  FUNCTION PROXIMO_ID_GET()
  RETURNS INTEGER
  AS
  BEGIN
    RETURN NEXT VALUE FOR PESSOA_SEQ;
  END

  PROCEDURE GARANTIR_NOMES(
    LOJA_ID ID_SHORT_DOM NOT NULL,
    TERMINAL_ID ID_SHORT_DOM NOT NULL,
    NOME NOME_DOM NOT NULL,
    APELIDO VARCHAR(20) NOT NULL,
    PESSOA_ID INTEGER
  )
  RETURNS
  (
    PESSOA_ID_RET INTEGER 
  )
  AS
  BEGIN
    IF (PESSOA_ID IS NULL OR PESSOA_ID = 0) THEN
      PESSOA_ID = PROXIMO_ID_GET();

    PESSOA_ID_RET = PESSOA_ID;  
    
    UPDATE OR INSERT INTO PESSOA (LOJA_ID, TERMINAL_ID, PESSOA_ID, NOME, APELIDO)
    VALUES (:LOJA_ID, :TERMINAL_ID, :PESSOA_ID, :NOME, :APELIDO)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID);
    
    SUSPEND;
  END

  PROCEDURE GARANTIR(
    LOJA_ID SMALLINT NOT NULL,
    TERMINAL_ID SMALLINT NOT NULL,
    NOME VARCHAR(60),
    NOME_FANTASIA VARCHAR(60),
    APELIDO VARCHAR(20),
    GENERO_ID CHAR(1),
    ESTADO_CIVIL_ID CHAR(1),
    C VARCHAR(15),
    I VARCHAR(15),
    M VARCHAR(15),
    M_UF CHAR(2),
    EMAIL VARCHAR(50),
    DT_NASC DATE,
    ATIVO             BOOLEAN,
    PESSOA_ID INTEGER,

    LOGRADOURO        VARCHAR(70),
    NUMERO            NOME_DOM,
    COMPLEMENTO       NOME_DOM,
    BAIRRO            NOME_DOM,
    UF_SIGLA          CHAR(2),
    CEP               CHAR(8),
    MUNICIPIO_IBGE_ID CHAR(7),
    DDD               CHAR(2),
    FONE1             NOME_CURTO_DOM,
    FONE2             NOME_CURTO_DOM,
    FONE3             NOME_CURTO_DOM,
    CONTATO           NOME_DOM,
    REFERENCIA        OBS1_DOM
  )
  RETURNS
  (
    PESSOA_ID_RET INTEGER
  )
  AS
  DECLARE VARIABLE ALTERADO_EM TIMESTAMP;
  BEGIN
    IF ((PESSOA_ID IS NULL) OR (PESSOA_ID = 0)) THEN
    BEGIN
      PESSOA_ID = PROXIMO_ID_GET();
      ALTERADO_EM = NULL;
    END
    ELSE
    BEGIN
      ALTERADO_EM = CURRENT_TIMESTAMP;
    END

    PESSOA_ID_RET = PESSOA_ID;  

    UPDATE OR INSERT INTO PESSOA (LOJA_ID, TERMINAL_ID, PESSOA_ID, NOME,
      NOME_FANTASIA, APELIDO, GENERO_ID, ESTADO_CIVIL_ID, C, I, M, M_UF, EMAIL,
      DT_NASC, ATIVO, ALTERADO_EM)
    VALUES (:LOJA_ID, :TERMINAL_ID, :PESSOA_ID_RET, :NOME, :NOME_FANTASIA,
      :APELIDO, :GENERO_ID, :ESTADO_CIVIL_ID, :C, :I, :M, :M_UF, :EMAIL,
      :DT_NASC, :ATIVO, :ALTERADO_EM)
    MATCHING (LOJA_ID, TERMINAL_ID, PESSOA_ID);

    EXECUTE PROCEDURE ENDERECO_PA.GARANTIR(:LOJA_ID, :TERMINAL_ID, :PESSOA_ID_RET,
      0, :LOGRADOURO, :NUMERO, :COMPLEMENTO, :BAIRRO, :UF_SIGLA, :CEP,
      :MUNICIPIO_IBGE_ID, :DDD, :FONE1, :FONE2, :FONE3, :CONTATO, :REFERENCIA);

    SUSPEND;
  END
  
  PROCEDURE ID_BY_C 
  (
    C VARCHAR(15)
  )
  RETURNS 
  (
    LOJA_ID ID_SHORT_DOM,
    TERMINAL_ID ID_SHORT_DOM,
    PESSOA_ID ID_DOM
  )
  AS
  BEGIN
    FOR SELECT LOJA_ID, TERMINAL_ID, PESSOA_ID
      FROM PESSOA
      WHERE C = :C
      INTO :LOJA_ID, :TERMINAL_ID, :PESSOA_ID
  DO
    SUSPEND;
  END
END^
SET TERM ;^
```
COMANDO FIM

//PACKAGE DBUPDATE_PA

DBATUALIZ FIM


