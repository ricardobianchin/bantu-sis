SET TERM ^;
CREATE OR ALTER PACKAGE CAIXA_SESSAO_PDV_PA
AS
BEGIN
  PROCEDURE TEM_CAIXA_ABERTO
  RETURNS
  (  
    TEM BOOLEAN
  );
  
  PROCEDURE TEM_VENDA_NAO_FINALIZADA
  RETURNS
  (  
    TEM BOOLEAN
  );
  
  PROCEDURE FECHAR_PODE_GET
  RETURNS
  (
    PODE BOOLEAN
    , MENSAGEM_ID ID_DOM
  );
END^

---- BODY

RECREATE PACKAGE BODY CAIXA_SESSAO_PDV_PA
AS
BEGIN
/*
SELECT * FROM CAIXA_SESSAO_PDV_PA.TEM_CAIXA_ABERTO;
*/
  PROCEDURE TEM_CAIXA_ABERTO
  RETURNS
  (  
    TEM BOOLEAN
  )
  AS
    DECLARE RESULTADO INTEGER;
  BEGIN
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
      SELECT SESS.SESS_ID

      FROM AMBIENTE_SIS AMBI

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID  = SESS.TERMINAL_ID

      WHERE SESS.ABERTO 
    ) INTO :RESULTADO;
    
    :RESULTADO = COALESCE(:RESULTADO, 0);
    
    :TEM = :RESULTADO = 1;
    SUSPEND;
  END
  
/*  
SELECT * FROM CAIXA_SESSAO_PDV_PA.TEM_VENDA_NAO_FINALIZADA;
*/
  PROCEDURE TEM_VENDA_NAO_FINALIZADA
  RETURNS
  (  
    TEM BOOLEAN
  )
  AS
    DECLARE RESULTADO INTEGER;
  BEGIN
    SELECT 1 FROM RDB$DATABASE WHERE EXISTS (
      SELECT SESS.SESS_ID

      FROM AMBIENTE_SIS AMBI

      JOIN CAIXA_SESSAO SESS ON
      AMBI.LOJA_ID = SESS.LOJA_ID
      AND AMBI.TERMINAL_ID  = SESS.TERMINAL_ID

      JOIN VENDA V ON
      V.SESS_LOJA_ID = SESS.LOJA_ID
      AND V.SESS_TERMINAL_ID  = SESS.TERMINAL_ID
      AND V.SESS_ID = SESS.SESS_ID

      JOIN EST_MOV E ON
      V.LOJA_ID = E.LOJA_ID
      AND V.TERMINAL_ID = E.TERMINAL_ID
      AND V.EST_MOV_ID = E.EST_MOV_ID

      WHERE SESS.ABERTO AND (NOT E.FINALIZADO) AND (NOT E.CANCELADO)
      ) INTO :RESULTADO;
    
    :RESULTADO = COALESCE(:RESULTADO, 0);
    
    :TEM = :RESULTADO = 1;
    SUSPEND;
  END
  
/*
SELECT * FROM CAIXA_SESSAO_PDV_PA.FECHAR_PODE_GET;
*/
  PROCEDURE FECHAR_PODE_GET
  RETURNS
  (
    PODE BOOLEAN
    , MENSAGEM_ID ID_DOM
  )
  AS
/*
  1 = 'Pode fechar o caixa';
  2 = 'Não há caixa aberto';
  3 = 'Há uma venda não finalizada';
*/  
    DECLARE TEM_CX_ABERTO BOOLEAN;
    DECLARE TEM_VEN_NAO_FIN BOOLEAN;
  BEGIN
    PODE = TRUE;
    MENSAGEM_ID = 1;
    
    SELECT TEM FROM CAIXA_SESSAO_PDV_PA.TEM_CAIXA_ABERTO INTO :TEM_CX_ABERTO;
    
    IF (NOT :TEM_CX_ABERTO) THEN
    BEGIN
      PODE = FALSE;
      MENSAGEM_ID = 2;
      SUSPEND;
      EXIT;
    END

    SELECT TEM FROM CAIXA_SESSAO_PDV_PA.TEM_VENDA_NAO_FINALIZADA INTO :TEM_VEN_NAO_FIN;
    
    IF (:TEM_VEN_NAO_FIN) THEN
    BEGIN
      PODE = FALSE;
      MENSAGEM_ID = 3;
      SUSPEND;
      EXIT;
    END

    SUSPEND;
  END
END^
SET TERM ;^
